<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>eBayãƒªã‚µãƒ¼ãƒãƒ„ãƒ¼ãƒ«</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f5f7;--card:#fff;--border:#e0e0e0;
  --primary:#2563eb;--primary-light:#dbeafe;
  --green:#16a34a;--green-bg:#dcfce7;
  --red:#dc2626;--red-bg:#fee2e2;
  --text:#1e293b;--text2:#475569;--text3:#94a3b8;
  --sp:#f97316;--sp-bg:#fff7ed;--sp-border:#fdba74;
  --shadow:0 1px 3px rgba(0,0,0,.08);
  --shadow2:0 4px 6px rgba(0,0,0,.07);
}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Sans",sans-serif;background:var(--bg);color:var(--text);line-height:1.5;padding:10px 16px;margin:0 auto;max-width:1400px}
h1{font-size:1.3rem;text-align:center;padding:8px 0 2px;font-weight:700}
.subtitle{text-align:center;font-size:.82rem;color:var(--text3);margin-bottom:10px}
.card{background:var(--card);border-radius:10px;padding:12px 16px;margin-bottom:10px;box-shadow:var(--shadow)}
.card h2{font-size:.95rem;font-weight:700;margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--primary);color:var(--primary);display:flex;align-items:center;gap:6px}
.card h2 .icon{font-size:1rem}

/* ===== 2-column PC layout ===== */
.main-layout{display:grid;grid-template-columns:380px 1fr;gap:10px;align-items:start}

.field{display:flex;flex-direction:column;gap:2px}
.field label{font-size:.8rem;color:var(--text2);font-weight:600;white-space:nowrap}
.field input{border:1.5px solid var(--border);border-radius:6px;padding:6px 10px;font-size:.95rem;width:100%;transition:border-color .15s;background:#fafafa}
.field input:focus{outline:none;border-color:var(--primary);background:#fff;box-shadow:0 0 0 2px var(--primary-light)}
.field input.highlight{background:#fffbeb;border-color:#f59e0b}
.field .unit{font-size:.7rem;color:var(--text3)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.grid4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}

/* ===== Summary bar â€” horizontal ===== */
.summary-row{display:flex;gap:8px;margin-bottom:8px}
.summary-cell{flex:1;padding:8px 10px;border-radius:6px;text-align:center;min-width:0}
.summary-cell .s-label{font-size:.72rem;color:var(--text2);white-space:nowrap}
.summary-cell .s-val{font-size:1.05rem;font-weight:700;font-family:"SF Mono",Consolas,monospace;white-space:nowrap}

.fee-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:.85rem}
.fee-row .fee-label{color:var(--text2)}
.fee-row .fee-val{font-weight:600;font-family:"SF Mono",Consolas,monospace}
.fee-total{border-top:1.5px solid var(--border);margin-top:4px;padding-top:5px;font-weight:700;font-size:.9rem}
.divider{border:none;border-top:1px dashed var(--border);margin:5px 0}

.toggle-btn{display:inline-flex;align-items:center;gap:4px;background:none;border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:.78rem;cursor:pointer;color:var(--text3);transition:all .15s}
.toggle-btn:hover{background:var(--primary-light);border-color:var(--primary);color:var(--primary)}
.toggle-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.settings-content{display:none;margin-top:8px}
.settings-content.show{display:block}
.note{font-size:.72rem;color:var(--text3);margin-top:5px;padding:5px 8px;background:#f8fafc;border-radius:6px;line-height:1.4}

/* ===== Group Section ===== */
.group-section{margin-bottom:12px}
.group-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:6px 12px;border-radius:6px;font-weight:700;font-size:.95rem}
.group-header .g-icon{font-size:1rem}
.group-header .g-label{white-space:nowrap}
.group-header .g-note{font-size:.78rem;font-weight:400;opacity:.7;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.group-header .g-tag{font-size:.72rem;padding:2px 8px;border-radius:99px;font-weight:600}
.group-speedpak{background:linear-gradient(135deg,#fff7ed,#ffedd5);color:#c2410c;border:1.5px solid var(--sp-border)}
.group-speedpak .g-tag{background:#c2410c;color:#fff}
.group-elogi{background:#f5f0ff;color:#6d28d9;border:1px solid #c4b5fd}
.group-elogi .g-tag{background:#7c3aed;color:#fff}
.group-dhl{background:#fefce8;color:#a16207;border:1px solid #fde68a}
.group-dhl .g-tag{background:#a16207;color:#fff}
.group-jppost{background:#f0fdf4;color:#15803d;border:1px solid #bbf7d0}
.group-jppost .g-tag{background:#15803d;color:#fff}

.group-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}

/* ===== Method Row ===== */
.method-row{display:grid;grid-template-columns:1fr auto;gap:0;border-radius:8px;padding:9px 12px;border:1.5px solid var(--border);background:var(--card);transition:all .15s;align-items:center}
.method-row.best{border-color:var(--green);background:var(--green-bg);box-shadow:var(--shadow2)}
.method-row.ng{opacity:.45;background:#f8fafc}
.method-row .mr-left{display:flex;flex-direction:column;gap:2px;min-width:0}
.method-row .mr-name{font-size:1rem;font-weight:700}
.method-row .mr-sub{font-size:.78rem;color:var(--text3);line-height:1.4}
.method-row .mr-right{display:grid;grid-template-columns:auto auto;gap:2px 10px;font-size:.95rem;text-align:right;white-space:nowrap}
.method-row .mr-right .lbl{color:var(--text2);text-align:left}
.method-row .mr-right .val{font-weight:700;font-family:"SF Mono",Consolas,monospace}
.method-row .mr-right .val-profit{color:var(--green)}
.method-row .mr-right .val-refund{color:var(--primary)}
.method-row .mr-right .val-neg{color:var(--red);background:var(--red-bg);border-radius:4px;padding:0 4px}
.method-row .mr-na{font-size:.88rem;color:var(--text3)}
.badge{font-size:.72rem;padding:2px 7px;border-radius:99px;font-weight:700;display:inline-block;vertical-align:middle;margin-left:4px}
.badge-ok{background:var(--green-bg);color:var(--green)}
.badge-ng{background:var(--red-bg);color:var(--red)}
.badge-best{background:var(--green);color:#fff}
.badge-na{background:#f1f5f9;color:var(--text3)}

.group-section.grp-fedex .method-row:not(.ng){border-color:#c4b5fd;background:#f5f0ff}
.group-section.grp-dhl .method-row:not(.ng){border-color:#fde68a;background:#fefce8}
.group-section .method-row.best{border-color:var(--green);background:var(--green-bg);box-shadow:var(--shadow2)}

.group-section.collapsed .group-grid{display:none}
.group-toggle{font-size:.75rem;padding:3px 10px;border:1px solid var(--border);border-radius:5px;background:var(--card);cursor:pointer;color:var(--text3);margin-left:auto}
.group-toggle:hover{background:var(--primary-light);color:var(--primary);border-color:var(--primary)}
.group-unavail{background:#fef2f2;color:var(--red);border:1.5px solid #fca5a5}
.group-unavail .g-tag{background:var(--red);color:#fff}
.unavail-note{font-size:.78rem;color:var(--red);padding:4px 12px;margin-bottom:6px}
.group-section.grp-speedpak .method-row:not(.ng){border-color:var(--sp-border);background:var(--sp-bg)}
.group-section.grp-jppost .method-row:not(.ng){border-color:#bbf7d0;background:#f0fdf4}

.mode-bar{display:flex;gap:6px;margin-bottom:10px}
.mode-btn{flex:1;padding:6px 10px;border:1.5px solid var(--border);border-radius:6px;background:var(--card);cursor:pointer;font-size:.82rem;font-weight:600;color:var(--text3);text-align:center;transition:all .15s}
.mode-btn:hover{border-color:var(--primary);color:var(--primary)}
.mode-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.pricing-info{font-size:.78rem;color:var(--text2);padding:6px 8px;background:#f8fafc;border-radius:6px;margin-top:4px;line-height:1.5}
.pricing-info strong{color:var(--text);font-family:"SF Mono",Consolas,monospace}

/* ===== Shopping Search Bar ===== */
.shop-search-bar{background:var(--card);border-radius:8px;box-shadow:var(--shadow);padding:6px 12px;margin-bottom:10px}
.shop-search-top{display:flex;align-items:center;gap:8px}
.shop-search-top input[type="text"]{flex:1;border:1.5px solid var(--border);border-radius:6px;padding:5px 10px;font-size:.9rem;min-width:0}
.shop-search-top input[type="text"]:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px var(--primary-light)}
.shop-search-btn{font-size:.78rem;padding:5px 14px;border:1.5px solid var(--primary);border-radius:6px;background:var(--primary);color:#fff;cursor:pointer;font-weight:600;white-space:nowrap}
.shop-search-btn:hover{background:#1d4ed8}
.shop-sites{display:flex;flex-wrap:wrap;gap:2px 6px;margin-top:4px}
.shop-sites label{font-size:.72rem;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:2px;padding:1px 4px;border-radius:4px;transition:background .1s;white-space:nowrap;user-select:none}
.shop-sites label:hover{background:var(--primary-light)}
.shop-sites input[type="checkbox"]{width:12px;height:12px;margin:0;accent-color:var(--primary)}
.shop-toggle{font-size:.7rem;color:var(--text3);cursor:pointer;border:none;background:none;padding:0;text-decoration:underline}
.shop-toggle:hover{color:var(--primary)}

@media(max-width:900px){
  .main-layout{grid-template-columns:1fr}
  .group-grid{grid-template-columns:1fr}
}
@media(max-width:640px){
  body{padding:8px 10px}
  h1{font-size:1.1rem}
  .tool-bar{grid-template-columns:1fr !important}
  .tool-bar>*{text-align:center}
  .tool-bar .shop-sites{justify-content:center}
  .tool-bar div[style*="display:flex"]{justify-content:center}
  .card{padding:10px 12px}
  .grid4{grid-template-columns:1fr 1fr;gap:6px}
  .summary-row{flex-direction:column;gap:6px}
  .group-header{flex-wrap:wrap;font-size:.82rem;gap:4px 8px;justify-content:center;text-align:center}
  .group-header .g-label{white-space:normal}
  .group-header .g-note{width:100%;flex:none;text-align:center}
  .method-row{grid-template-columns:1fr;gap:6px;text-align:center}
  .method-row .mr-right{justify-content:center;justify-items:center;text-align:center;font-size:.88rem}
  .method-row .mr-left{align-items:center}
  .mode-bar{flex-direction:column;gap:4px}
  .unavail-note{text-align:center}
  .group-note{text-align:center}
}
</style>
</head>
<body>

<h1>eBayãƒªã‚µãƒ¼ãƒãƒ„ãƒ¼ãƒ«</h1>

<div class="tool-bar" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">
  <!-- 1. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¬ãƒãƒ£ -->
  <div style="background:var(--card);border-radius:8px;box-shadow:var(--shadow);padding:8px 12px;border-top:3px solid var(--primary)">
    <div style="font-size:.72rem;margin-bottom:4px"><span style="font-weight:700;color:var(--primary)">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ</span> <span style="color:var(--text3)">â€” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ¼ã™ã¨ã‚³ãƒ”ãƒ¼ã§ãã¾ã™</span></div>
    <div id="kwResult" style="font-size:.95rem;font-weight:700;color:var(--primary);font-family:'SF Mono',Consolas,monospace;min-height:28px;line-height:28px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:6px">-</div>
    <div style="display:flex;align-items:center;gap:6px">
      <select id="kwCount" style="font-size:.75rem;padding:3px 6px;border:1px solid var(--border);border-radius:5px;background:#fafafa;color:var(--text2)">
        <option value="1">1èª</option><option value="2" selected>2èª</option><option value="3">3èª</option><option value="5">5èª</option>
      </select>
      <button onclick="rollKw()" style="font-size:.75rem;padding:4px 12px;border:1.5px solid var(--primary);border-radius:6px;background:var(--primary);color:#fff;cursor:pointer;font-weight:600;white-space:nowrap">ã‚¬ãƒãƒ£</button>
    </div>
  </div>
  <!-- 2. eBayè²©å£²å±¥æ­´ -->
  <a href="https://www.ebay.com/sh/research?marketplace=EBAY-US&tabName=SOLD" target="_blank" style="background:var(--card);border-radius:8px;box-shadow:var(--shadow);padding:8px 12px;border-top:3px solid var(--green);text-decoration:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;transition:all .15s" onmouseover="this.style.background='var(--green-bg)'" onmouseout="this.style.background='var(--card)'">
    <div style="font-size:.72rem;font-weight:700;color:var(--green)">ğŸ“Š eBayè²©å£²å±¥æ­´</div>
    <div style="font-size:1.3rem;font-weight:700">Research Products</div>
    <div style="font-size:.68rem;color:var(--text3)">90æ—¥é–“ã§2å€‹ä»¥ä¸Šå£²ã‚Œã¦ã„ã‚‹å•†å“ã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
  </a>
  <!-- 3. ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ä¸€æ‹¬æ¤œç´¢ -->
  <div style="background:var(--card);border-radius:8px;box-shadow:var(--shadow);padding:8px 12px;border-top:3px solid var(--sp)">
    <div style="font-size:.72rem;margin-bottom:4px"><span style="font-weight:700;color:var(--sp)">ğŸ” ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ä¸€æ‹¬æ¤œç´¢</span> <span style="color:var(--text3)">â€” å›½å†…ã®æœ€å®‰å€¤ã‚’æ¤œç´¢</span></div>
    <div style="display:flex;gap:4px;margin-bottom:4px">
      <input type="text" id="shopQuery" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰..." style="flex:1;border:1.5px solid var(--border);border-radius:6px;padding:4px 8px;font-size:.82rem;min-width:0" onkeydown="if(event.key==='Enter')shopSearch()">
      <button class="shop-search-btn" onclick="shopSearch()" style="font-size:.72rem;padding:4px 10px">æ¤œç´¢</button>
    </div>
    <div style="display:flex;align-items:center;gap:4px;margin-bottom:2px">
      <button class="shop-toggle" onclick="toggleShopAll(true)">å…¨é¸æŠ</button>
      <button class="shop-toggle" onclick="toggleShopAll(false)">å…¨è§£é™¤</button>
    </div>
    <div class="shop-sites" id="shopSites"></div>
  </div>
</div>

<div class="main-layout">
<!-- ===== LEFT COLUMN ===== -->
<div class="left-col">

  <!-- å•†å“æƒ…å ± -->
  <div class="card">
    <h2><span class="icon">ğŸ“¦</span> å•†å“æƒ…å ±</h2>
    <div class="mode-bar">
      <button class="mode-btn active" id="modeUs" onclick="setPricingMode('us')">ğŸ‡ºğŸ‡¸ ã‚¢ãƒ¡ãƒªã‚«å‘ã‘</button>
      <button class="mode-btn" id="modeOther" onclick="setPricingMode('other')">ğŸŒ ã‚¢ãƒ¡ãƒªã‚«ä»¥å¤–</button>
    </div>
    <div class="grid2" style="margin-bottom:6px">
      <div class="field">
        <label>ä»•å…¥é¡ <span class="unit">(Â¥ãƒ»ç¨è¾¼)</span></label>
        <input type="number" id="purchasePrice" value="0" class="highlight" min="0" step="100">
      </div>
      <div class="field">
        <label>å£²å€¤ <span class="unit">($)â€»ç«¶åˆæœ€å®‰å€¤</span></label>
        <input type="number" id="sellingPrice" value="0" class="highlight" min="0" step="0.01">
      </div>
    </div>
    <!-- ğŸ‡ºğŸ‡¸ ã‚¢ãƒ¡ãƒªã‚«å‘ã‘: ç«¶åˆé€æ–™ -->
    <div id="usSection" style="margin-bottom:6px">
      <div class="field" style="width:130px;margin-bottom:6px">
        <label>é€æ–™ <span class="unit">($)â€»ç«¶åˆé€æ–™</span></label>
        <input type="number" id="compShipping" value="0" class="highlight" min="0" step="0.01">
      </div>
      <div id="usPricingInfo" style="display:flex;gap:6px">
        <div style="flex:1;padding:8px 10px;border-radius:6px;background:var(--primary-light);border:1.5px solid var(--primary);text-align:center">
          <div style="font-size:.68rem;color:var(--primary);font-weight:600">ğŸ“‹ eBayå‡ºå“ä¾¡æ ¼</div>
          <div id="listPrice" style="font-size:1.1rem;font-weight:700;color:var(--primary);font-family:'SF Mono',Consolas,monospace">-</div>
        </div>
        <div style="flex:1;padding:8px 10px;border-radius:6px;background:#fef3c7;border:1.5px solid #f59e0b;text-align:center">
          <div style="font-size:.68rem;color:#b45309;font-weight:600">ğŸ“‹ eBayå‡ºå“é€æ–™</div>
          <div id="listShipping" style="font-size:1.1rem;font-weight:700;color:#b45309;font-family:'SF Mono',Consolas,monospace">-</div>
        </div>
      </div>
    </div>
    <!-- ğŸŒ ã‚¢ãƒ¡ãƒªã‚«ä»¥å¤–: é–¢ç¨ç‡ -->
    <div id="otherSection" style="margin-bottom:6px;display:none">
      <div style="display:flex;gap:8px;align-items:flex-end">
        <div class="field" style="width:160px">
          <label>ç±³å›½å‘ã‘é–¢ç¨ç‡ <span class="unit">(%)</span></label>
          <input type="number" id="usTariffRate" value="20" class="highlight" min="0" step="1">
        </div>
        <div class="pricing-info" id="otherPricingInfo" style="flex:1">ğŸ‡ºğŸ‡¸ç±³å›½å‘ã‘é€æ–™: <strong>-</strong></div>
      </div>
    </div>
    <div class="grid4">
      <div class="field">
        <label>å®Ÿé‡é‡ <span class="unit">(kg)</span></label>
        <input type="number" id="weight" value="0.5" class="highlight" min="0" step="0.01">
      </div>
      <div class="field">
        <label>ç¸¦ <span class="unit">(cm)</span></label>
        <input type="number" id="length" value="10" class="highlight" min="0" step="0.1">
      </div>
      <div class="field">
        <label>æ¨ª <span class="unit">(cm)</span></label>
        <input type="number" id="width" value="10" class="highlight" min="0" step="0.1">
      </div>
      <div class="field">
        <label>é«˜ã• <span class="unit">(cm)</span></label>
        <input type="number" id="height" value="5" class="highlight" min="0" step="0.1">
      </div>
    </div>
    <div style="display:flex;gap:12px;margin-top:4px;font-size:.75rem;color:var(--text3)">
      <span>ä½“ç©é‡é‡(Ã·5000): <strong id="volWeight" style="color:var(--text2)">-</strong></span>
      <span>Economy(Ã·8000): <strong id="volWeightEco" style="color:var(--text2)">-</strong></span>
    </div>
  </div>

  <!-- æ‰‹æ•°æ–™è¨­å®š -->
  <div class="card">
    <h2><span class="icon">âš™ï¸</span> æ‰‹æ•°æ–™ãƒ»ãƒ¬ãƒ¼ãƒˆ</h2>
    <div style="display:flex;gap:8px;align-items:flex-end;margin-bottom:5px">
      <div class="field" style="width:110px">
        <label>ã‚«ãƒ†ã‚´ãƒªNo.</label>
        <input type="number" id="categoryNo" value="20561" placeholder="ä¾‹: 20561" class="highlight">
      </div>
      <div class="field" style="flex:1;min-width:0">
        <label>ã‚«ãƒ†ã‚´ãƒªå</label>
        <div id="categoryName" style="font-size:.82rem;padding:6px 0;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">-</div>
      </div>
    </div>
    <div style="font-size:.75rem;color:var(--text2);margin-bottom:6px;padding:4px 8px;background:#f8fafc;border-radius:4px" id="feeDescription">-</div>
    <div style="display:flex;align-items:flex-end;gap:8px;margin-bottom:5px">
      <div class="field" style="width:140px">
        <label>ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ <span class="unit">(Â¥/$)</span></label>
        <input type="number" id="exchangeRate" value="153.5115" class="highlight" step="0.0001">
      </div>
      <button onclick="fetchRate()" style="font-size:.72rem;padding:5px 10px;border:1px solid var(--border);border-radius:5px;background:#fafafa;cursor:pointer;color:var(--text3);white-space:nowrap;margin-bottom:0">è‡ªå‹•å–å¾—</button>
    </div>
    <div style="display:flex;align-items:flex-end;gap:8px;margin-bottom:5px">
      <div class="field" style="width:140px">
        <label>ç‡ƒæ²¹ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸ <span class="unit">(%)</span></label>
        <input type="number" id="fuelSurcharge" value="28.75" class="highlight" step="0.25">
      </div>
      <button onclick="fetchFuelSurcharge(false)" style="font-size:.72rem;padding:5px 10px;border:1px solid var(--border);border-radius:5px;background:#fafafa;cursor:pointer;color:var(--text3);white-space:nowrap;margin-bottom:0">FedExå–å¾—</button>
      <div style="font-size:.68rem;color:var(--text3);margin-bottom:4px;line-height:1.3">FedEx/DHLå…±é€šãƒ»åŸºæœ¬é€æ–™ã«åŠ ç®—<br><span id="fuelStatus" style="color:var(--text3)">-</span></div>
    </div>
    <button class="toggle-btn" id="settingsToggle" onclick="toggleSettings()">è©³ç´°è¨­å®š â–¼</button>
    <div class="settings-content" id="settingsContent">
      <div class="grid2" style="gap:6px;margin-top:6px">
        <div class="field"><label>eBayæ‰‹æ•°æ–™ (%)</label><input type="number" id="ebayFeeRate" value="12.7" step="0.01"></div>
        <div class="field"><label>é–¾å€¤ ($)</label><input type="number" id="feeThreshold" value="2500" step="100"></div>
        <div class="field"><label>eBayæ‰‹æ•°æ–™2 (%)</label><input type="number" id="ebayFeeRate2" value="2.35" step="0.01"></div>
        <div class="field"><label>1æ³¨æ–‡ã‚ãŸã‚Š ($)</label><input type="number" id="perOrderFee" value="0.40" step="0.01"></div>
        <div class="field"><label>Promoted (%)</label><input type="number" id="promotedRate" value="2" step="0.1" class="highlight"></div>
        <div class="field"><label>æµ·å¤–æ‰‹æ•°æ–™ (%)</label><input type="number" id="intlFeeRate" value="0.95" step="0.01" class="highlight"></div>
        <div class="field"><label>Payoneer (%)</label><input type="number" id="payoneerRate" value="2" step="0.1" class="highlight"></div>
        <div class="field"><label>æ¶ˆè²»ç¨ç‡ (%)</label><input type="number" id="taxRate" value="10" step="1"></div>
      </div>
    </div>
  </div>

  <!-- åˆ©ç›Šã‚µãƒãƒªãƒ¼ -->
  <div class="card">
    <h2><span class="icon">ğŸ’°</span> åˆ©ç›Šã‚µãƒãƒªãƒ¼</h2>
    <div class="summary-row">
      <div class="summary-cell" id="summaryProfit" style="background:var(--green-bg)">
        <div class="s-label">æ¨å¥¨ä¾¿ åˆ©ç›Š</div>
        <div class="s-val" style="color:var(--green)" id="bestProfitYen">-</div>
      </div>
      <div class="summary-cell" id="summaryRefund" style="background:#dbeafe">
        <div class="s-label">é‚„ä»˜è¾¼ã¿</div>
        <div class="s-val" style="color:var(--primary)" id="bestProfitRefundYen">-</div>
      </div>
      <div class="summary-cell" style="background:#f0fdf4">
        <div class="s-label">åˆ©ç›Šç‡</div>
        <div class="s-val" style="color:var(--green)" id="bestProfitRate">-</div>
      </div>
    </div>
    <button class="toggle-btn" id="feeToggle" onclick="toggleFeeDetail()">å†…è¨³ â–¼</button>
    <div class="settings-content" id="feeDetailContent">
      <div class="fee-row"><span class="fee-label">å£²ä¸Š</span><span class="fee-val" id="revenueYen">-</span></div>
      <div class="fee-row"><span class="fee-label">æ‰‹æ•°æ–™è¨ˆ</span><span class="fee-val" style="color:var(--red)" id="totalFeesYen">-</span></div>
      <hr class="divider">
      <div class="fee-row"><span class="fee-label">eBay FVF</span><span class="fee-val" id="feeEbay">-</span></div>
      <div class="fee-row"><span class="fee-label">Promoted</span><span class="fee-val" id="feePromoted">-</span></div>
      <div class="fee-row"><span class="fee-label">æµ·å¤–æ‰‹æ•°æ–™</span><span class="fee-val" id="feeIntl">-</span></div>
      <hr class="divider">
      <div class="fee-row"><span class="fee-label">Payoneer</span><span class="fee-val" id="feePayoneer">-</span></div>
      <div class="fee-row fee-total"><span class="fee-label">åˆè¨ˆ</span><span class="fee-val" id="feeTotalUsd">-</span></div>
      <div class="note">â€»eBayç³»æ‰‹æ•°æ–™ã«ã¯æ¶ˆè²»ç¨10%è¾¼ã€‚Payoneerã¯ç‚ºæ›¿å¤‰æ›æ™‚æ§é™¤ã€‚</div>
    </div>
  </div>

</div><!-- /left-col -->

<!-- ===== RIGHT COLUMN ===== -->
<div class="right-col">
  <div class="card" style="padding:12px 16px">
    <h2><span class="icon">ğŸšš</span> é…é€æ–¹æ³•åˆ¥ åˆ©ç›Šæ¯”è¼ƒ</h2>
    <div style="margin-bottom:8px">
      <select id="destCountry" style="border:1.5px solid var(--border);border-radius:6px;padding:6px 10px;font-size:.95rem;width:100%;background:#fafafa;cursor:pointer;font-weight:600" onchange="onCountryChange()">
      </select>
    </div>
    <div id="resultsContainer"></div>
  </div>
  <div class="note" style="text-align:center;margin-top:3px" id="footerNote">
    â€»é€æ–™ã¯SpeedPAKå…¬å¼PDFæº–æ‹ ã€‚FedEx/DHLã¯ç‡ƒæ²¹ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸åŠ ç®—æ¸ˆã€‚åˆ©ç›ŠOKåˆ¤å®šï¼šâ‰¥Â¥500 ã‹ã¤ â‰¥5%ã€‚é‚„ä»˜ï¼ä»•å…¥ç¨ï¼‹eBayæ‰‹æ•°æ–™ç¨ã€‚
  </div>
</div><!-- /right-col -->

</div><!-- /main-layout -->

<script src="ebay_categories.js"></script>
<script>
// ========== Shopping Site Bulk Search ==========
const SHOP_SITES = [
  { id:'amazon_jp', name:'Amazon JP',    url:'https://www.amazon.co.jp/s?k={q}', checked:true },
  { id:'rakuten',   name:'æ¥½å¤©',          url:'https://search.rakuten.co.jp/search/mall/{q}/', checked:true },
  { id:'yahoo_shop',name:'Yahooã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°', url:'https://shopping.yahoo.co.jp/search?p={q}', checked:false },
  { id:'mercari',   name:'ãƒ¡ãƒ«ã‚«ãƒª',       url:'https://jp.mercari.com/search?keyword={q}', checked:true },
  { id:'yahoo_auc', name:'ãƒ¤ãƒ•ã‚ªã‚¯',       url:'https://auctions.yahoo.co.jp/search/search?p={q}', checked:true },
  { id:'paypay',    name:'PayPayãƒ•ãƒªãƒ',   url:'https://paypayfleamarket.yahoo.co.jp/search/{q}', checked:false },
  { id:'rakuma',    name:'ãƒ©ã‚¯ãƒ',         url:'https://fril.jp/search/{q}', checked:false },
  { id:'kakaku',    name:'ä¾¡æ ¼.com',      url:'https://kakaku.com/search_results/{q}/', checked:false },
  { id:'yodobashi', name:'ãƒ¨ãƒ‰ãƒã‚·',       url:'https://www.yodobashi.com/?word={q}', checked:false },
  { id:'surugaya',  name:'é§¿æ²³å±‹',        url:'https://www.suruga-ya.jp/search?category=&search_word={q}', checked:false },
  { id:'google',    name:'Google',       url:'https://www.google.com/search?q={q}', checked:false },
  { id:'amazon_us', name:'Amazon US',    url:'https://www.amazon.com/s?k={q}', checked:false },
  { id:'ebay',      name:'eBay',         url:'https://www.ebay.com/sch/i.html?_nkw={q}', checked:true },
  { id:'aliexpress',name:'AliExpress',   url:'https://www.aliexpress.com/wholesale?SearchText={q}', checked:false },
];

function initShopSites() {
  const container = document.getElementById('shopSites');
  const saved = JSON.parse(localStorage.getItem('shop_sites_checked') || 'null');
  SHOP_SITES.forEach(s => {
    const checked = saved ? (saved[s.id] !== undefined ? saved[s.id] : s.checked) : s.checked;
    const lbl = document.createElement('label');
    lbl.innerHTML = `<input type="checkbox" data-shop="${s.id}" ${checked?'checked':''} onchange="saveShopChecks()"> ${s.name}`;
    container.appendChild(lbl);
  });
}

function saveShopChecks() {
  const obj = {};
  document.querySelectorAll('#shopSites input[type="checkbox"]').forEach(cb => {
    obj[cb.dataset.shop] = cb.checked;
  });
  localStorage.setItem('shop_sites_checked', JSON.stringify(obj));
}

function toggleShopAll(on) {
  document.querySelectorAll('#shopSites input[type="checkbox"]').forEach(cb => { cb.checked = on; });
  saveShopChecks();
}

function shopSearch() {
  const q = document.getElementById('shopQuery').value.trim();
  if (!q) { alert('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const encoded = encodeURIComponent(q);
  let opened = 0;
  document.querySelectorAll('#shopSites input[type="checkbox"]:checked').forEach(cb => {
    const site = SHOP_SITES.find(s => s.id === cb.dataset.shop);
    if (site) { window.open(site.url.replace('{q}', encoded), '_blank'); opened++; }
  });
  if (opened === 0) alert('æ¤œç´¢ã™ã‚‹ã‚µã‚¤ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
}

initShopSites();

// ========== Keyword Gacha ==========
const KW_LIST = [
  // Electronics & Gadgets
  'vintage','camera','lens','turntable','amplifier','headphones','speaker','microphone','radio','cassette',
  'walkman','gameboy','nintendo','sega','playstation','controller','console','cartridge','adapter','charger',
  'transformer','oscilloscope','multimeter','soldering','transistor','vacuum tube','calculator','typewriter',
  // Watches & Jewelry
  'watch','seiko','casio','citizen','orient','chronograph','automatic','mechanical','quartz','pocket watch',
  'pendant','necklace','bracelet','ring','brooch','earring','cufflinks','pearl','silver','gold',
  // Collectibles
  'figurine','statue','doll','plush','stuffed','miniature','diecast','model kit','gundam','bandai',
  'pokemon','card','trading card','stamp','coin','medal','badge','pin','patch','sticker',
  'poster','print','lithograph','painting','calligraphy','scroll','woodblock','ukiyo-e',
  // Fashion & Accessories
  'kimono','obi','haori','geta','tabi','tenugui','furoshiki','bag','wallet','purse',
  'backpack','tote','leather','silk','denim','vintage jacket','sneakers','boots','hat','scarf',
  // Kitchen & Home
  'knife','chef knife','santoku','whetstone','ceramic','teapot','tea cup','matcha','cast iron','tetsubin',
  'bento','chopsticks','lacquerware','bamboo','cutting board','rice cooker','thermos','zojirushi',
  // Tools & Instruments
  'chisel','plane','saw','hammer','wrench','pliers','drill','clamp','file','sandpaper',
  'guitar','violin','flute','harmonica','ukulele','keyboard','synthesizer','drum','cymbal','pedal',
  // Anime & Manga
  'manga','anime','cosplay','wig','figure','nendoroid','scale figure','art book','soundtrack','cel',
  // Automotive & Bicycle
  'carburetor','exhaust','headlight','mirror','emblem','wheel','tire','brake','suspension','seat',
  'bicycle','shimano','derailleur','pedal','saddle','handlebar','frame','fork','chain','spoke',
  // Stationery & Art
  'fountain pen','ink','notebook','sketchbook','watercolor','acrylic','oil paint','brush','easel','canvas',
  'washi tape','origami','calligraphy pen','seal','stamp pad',
  // Outdoor & Sports
  'fishing reel','fishing rod','lure','tackle','tent','sleeping bag','lantern','compass','binoculars',
  'golf club','baseball glove','kendo','judo','karate','bokken','shinai',
  // Misc
  'antique','retro','rare','limited edition','unused','mint condition','NOS','OEM','genuine','original',
  'handmade','crafted','custom','restoration','repair','parts','accessories','set','lot','bulk',
  'japanese','japan','tokyo','osaka','kyoto',
];

function rollKw() {
  const count = parseInt(document.getElementById('kwCount').value) || 2;
  const shuffled = [...KW_LIST].sort(() => Math.random() - 0.5);
  const picked = shuffled.slice(0, count);
  document.getElementById('kwResult').innerHTML = picked.map(w => '<span style="background:var(--primary-light);padding:2px 8px;border-radius:4px;margin-right:4px;display:inline-block;cursor:pointer" onclick="copyOneKw(this)" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼">' + w + '</span>').join('');
}

function copyOneKw(span) {
  const text = span.textContent.trim();
  if (!text) return;
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.select();
  document.execCommand('copy');
  document.body.removeChild(ta);
  const orig = span.textContent;
  const origBg = span.style.background;
  span.textContent = 'âœ“ copy';
  span.style.background = 'var(--green-bg)';
  setTimeout(() => { span.textContent = orig; span.style.background = origBg; }, 800);
}

rollKw(); // åˆæœŸè¡¨ç¤º

// ========== Category Lookup ==========

function onCategoryNoInput() {
  const no = parseInt(document.getElementById('categoryNo').value);
  const nameEl = document.getElementById('categoryName');
  if (typeof ebayCategoryMap !== 'undefined' && ebayCategoryMap[no]) {
    const cat = ebayCategoryMap[no]; // [name, rate1%, threshold, rate2%]
    nameEl.textContent = cat[0] || '(åç§°ãªã—)';
    // Auto-set fee rates from category data
    document.getElementById('ebayFeeRate').value = cat[1];
    document.getElementById('feeThreshold').value = cat[2];
    document.getElementById('ebayFeeRate2').value = cat[3];
  } else {
    nameEl.textContent = no ? 'ä¸æ˜ãªã‚«ãƒ†ã‚´ãƒª' : '-';
  }
  updateFeeDescription();
  calculate();
}

function updateFeeDescription() {
  const r1 = getVal('ebayFeeRate');
  const th = getVal('feeThreshold');
  const r2 = getVal('ebayFeeRate2');
  const po = getVal('perOrderFee');
  document.getElementById('feeDescription').textContent =
    'FVF: $' + th.toLocaleString() + 'ã¾ã§ ' + r1 + '% â†’ æ®‹ã‚Š ' + r2 + '% + $' + po + '/æ³¨æ–‡';
}

// ========== Shipping Rate Tables (USå‘ã‘ãƒ»2025å¹´ç‰ˆPDFæº–æ‹ ) ==========

// --- SpeedPAK Economy ç±³å›½æœ¬åœŸ48å· (Ã·8,000 å®¹ç©é‡é‡, æœ€å¤§$1,300, æœ€å¤§25kg) ---
const speedpakEconomyRates = [
  [100,1227],[200,1367],[300,1581],[400,1778],[500,2060],
  [600,2222],[700,2321],[800,2703],[900,2820],[1000,3020],
  [1100,3136],[1200,3250],[1300,3366],[1400,3704],[1500,3816],
  [1600,3935],[1700,4046],[1800,4165],[1900,5056],[2000,5245],
  [2500,5582],[3000,6333],[3500,6958],[4000,7704],
  [4500,9135],[5000,11733],[5500,12500],[6000,13335],
  [6500,14160],[7000,15209],[7500,16058],[8000,16893],
  [8500,17562],[9000,18152],[9500,19106],[10000,19639],
  [10500,20276],[11000,20864],[11500,21565],[12000,22199],
  [12500,22887],[13000,23466],[13500,24054],[14000,24869],
  [14500,25200],[15000,25988],[15500,26656],[16000,28149],
  [16500,28775],[17000,29495],[17500,30196],[18000,30902],
  [18500,31478],[19000,32204],[19500,32936],[20000,33947],
  [20500,34655],[21000,35426],[21500,36145],[22000,36859],
  [22500,37602],[23000,38516],[23500,39084],[24000,39678],
  [24500,40374],[25000,40955]
];

// --- SpeedPAK FedEx FICP (International Connect Plus) Zone F=USE/CA (Ã·5,000, æœ€å¤§68kg, DDP) ---
const speedpakFicpRates = [
  [500,2115],[1000,2599],[1500,2840],[2000,3108],[2500,3383],
  [3000,3540],[3500,3593],[4000,4022],[4500,4451],[5000,4718],
  [5500,5043],[6000,5366],[6500,5735],[7000,6184],[7500,6683],
  [8000,6871],[8500,7060],[9000,7249],[9500,8865],[10000,9089],
  [10500,9346],[11000,9602],[11500,9861],[12000,10116],
  [12500,11439],[13000,11723],[13500,12006],[14000,12289],
  [14500,12573],[15000,12857],[15500,13140],[16000,14631],
  [16500,14940],[17000,15249],[17500,15559],[18000,15867],
  [18500,16177],[19000,16485],[19500,16794],[20000,17104],
  [21000,20625],[22000,21657],[23000,22689],[24000,23721],
  [25000,24754],[26000,25787],[27000,26819],[28000,27852],
  [29000,28885],[30000,29916],
  [31000,30950],[32000,31983],[33000,34201],[34000,35237],
  [35000,36274],[36000,37310],[37000,38346],[38000,39383],
  [39000,40419],[40000,41455],[41000,42492],[42000,43528],
  [43000,44565],[44000,45601],[45000,45624],
  [46000,45624],[47000,45624],[48000,45792],[49000,46746],
  [50000,47700],[51000,48654],[52000,49608],[53000,50562],
  [54000,51516],[55000,52470],[56000,53424],[57000,54378],
  [58000,55332],[59000,56286],[60000,57240],
  [61000,58194],[62000,59148],[63000,60102],[64000,61056],
  [65000,62010],[66000,62964],[67000,63918],[68000,64872]
];

// --- SpeedPAK FedEx IP Envelope (Zone F=USE/CA, å®Ÿé‡é‡, æœ€å¤§0.5kg) ---
const speedpakIpEnvelopeRates = [
  [500,2091]
];

// --- SpeedPAK FedEx IP Pak (Zone F=USE/CA, å®Ÿé‡é‡, æœ€å¤§2.5kg) ---
const speedpakIpPakRates = [
  [500,2427],[1000,2894],[1500,3286],[2000,3686],[2500,4091]
];

// --- SpeedPAK FedEx IP Package (Zone F=USE/CA, Ã·5,000, æœ€å¤§68kg, DDP) ---
const speedpakIpPackageRates = [
  [500,2369],[1000,2655],[1500,2850],[2000,2859],[2500,3186],
  [3000,3755],[3500,3757],[4000,4252],[4500,4746],[5000,5241],
  [5500,6429],[6000,6587],[6500,6746],[7000,6905],[7500,7065],
  [8000,7224],[8500,7383],[9000,7541],[9500,9590],[10000,9788],
  [10500,9967],[11000,10146],[11500,10325],[12000,10505],
  [12500,12411],[13000,12620],[13500,12828],[14000,13035],
  [14500,13243],[15000,13451],[15500,13659],[16000,15914],
  [16500,16153],[17000,16391],[17500,16631],[18000,16870],
  [18500,17107],[19000,17346],[19500,17585],[20000,17823],
  [21000,22085],[22000,23136],[23000,24187],[24000,25240],
  [25000,26291],[26000,27343],[27000,28394],[28000,29446],
  [29000,30498],[30000,31550],
  [31000,32601],[32000,33652],[33000,34689],[34000,35740],
  [35000,36791],[36000,37842],[37000,38893],[38000,39945],
  [39000,40996],[40000,42047],[41000,43098],[42000,44149],
  [43000,45200],[44000,46252],[45000,46252],
  [46000,46794],[47000,47811],[48000,48828],[49000,49846],
  [50000,50863],[51000,51880],[52000,52898],[53000,53915],
  [54000,54932],[55000,55949],[56000,56967],[57000,57984],
  [58000,59001],[59000,60018],[60000,61036],
  [61000,62053],[62000,63070],[63000,64087],[64000,65105],
  [65000,66122],[66000,67139],[67000,68156],[68000,69174]
];

// --- SpeedPAK DHL Express Envelope (Zone 10=US, å®Ÿé‡é‡, æœ€å¤§0.3kg) ---
const speedpakDhlEnvelopeRates = [
  [300,2454]
];

// --- SpeedPAK DHL Express Worldwide (Zone 10=US, Ã·5,000, æœ€å¤§154kg) ---
const speedpakDhlRates = [
  [500,2454],[1000,2780],[1500,2898],[2000,3045],[2500,3404],
  [3000,3761],[3500,4203],[4000,4568],[4500,4934],[5000,5300],
  [5500,5665],[6000,6029],[6500,6444],[7000,6948],[7500,7450],
  [8000,7954],[8500,8456],[9000,8958],[9500,9463],[10000,9966],
  [10500,10469],[11000,10972],[11500,11475],[12000,11978],
  [12500,12481],[13000,12986],[13500,13487],[14000,13991],
  [14500,14494],[15000,14998],[15500,15500],[16000,16004],
  [16500,16508],[17000,17011],[17500,17515],[18000,18018],
  [18500,18521],[19000,19024],[19500,19528],[20000,20031],
  [21000,21039],[22000,22045],[23000,23052],[24000,24059],
  [25000,25065],[26000,26073],[27000,27078],[28000,28085],
  [29000,29082],[30000,30089],
  [31000,31093],[32000,32096],[33000,33099],[34000,34102],
  [35000,35104],[36000,36108],[37000,37111],[38000,38114],
  [39000,39117],[40000,40120],[41000,41123],[42000,42127],
  [43000,43129],[44000,44133],[45000,45135],[46000,46139],
  [47000,47142],[48000,48145],[49000,49148],[50000,50151],
  [51000,51154],[52000,52158],[53000,53160],[54000,54163],
  [55000,55166],[56000,56169],[57000,57173],[58000,58175],
  [59000,59179],[60000,60181],
  [61000,61185],[62000,62188],[63000,63191],[64000,64194],
  [65000,65197],[66000,66200],[67000,67204],[68000,68206],
  [69000,69210],[70000,70213]
];

// ========== Multi-Country Rate Tables ==========

// --- FedEx FICP Zone M (DE/GB/FR/IT/ES) ---
const ficpZoneM = [
  [500,2979],[1000,4014],[1500,4601],[2000,4989],[2500,5382],[3000,5766],[3500,6153],[4000,6540],[4500,6925],[5000,7311],
  [5500,7313],[6000,7595],[6500,7877],[7000,8160],[7500,8441],[8000,8722],[8500,9004],[9000,9285],[9500,9327],[10000,9602],
  [10500,9848],[11000,10096],[11500,10343],[12000,10589],[12500,10838],[13000,11084],[13500,11333],[14000,11579],[14500,11829],[15000,12075],
  [15500,12322],[16000,12571],[16500,12817],[17000,13065],[17500,13311],[18000,13560],[18500,13807],[19000,14054],[19500,14302],[20000,14549],
  [21000,14786],[22000,15546],[23000,16305],[24000,17063],[25000,17821],[26000,18580],[27000,19339],[28000,20097],[29000,20856],[30000,21615],
  [31000,22374],[32000,23132],[33000,25351],[34000,26119],[35000,26887],[36000,27655],[37000,28424],[38000,29192],[39000,29960],[40000,30728],
  [41000,31496],[42000,32265],[43000,33033],[44000,33801],[45000,33864],[46000,33864],[47000,33864],[48000,33864],[49000,33864],[50000,33864],
  [51000,33864],[52000,33864],[53000,33864],[54000,33864],[55000,33864],[56000,33864],[57000,33864],[58000,33864],[59000,33864],[60000,34049],
  [61000,34617],[62000,35184],[63000,35751],[64000,36319],[65000,36886],[66000,37454],[67000,38021],[68000,38589]
];

// --- FedEx FICP Zone U (AU/NZ) ---
const ficpZoneU = [
  [500,6428],[1000,7205],[1500,8440],[2000,9322],[2500,10203],[3000,11022],[3500,11841],[4000,12661],[4500,13480],[5000,14299],
  [5500,15727],[6000,16611],[6500,17494],[7000,18376],[7500,19261],[8000,20141],[8500,21025],[9000,21908],[9500,22130],[10000,22987],
  [10500,23679],[11000,24371],[11500,25061],[12000,25752],[12500,26443],[13000,27134],[13500,27826],[14000,28517],[14500,29208],[15000,29899],
  [15500,30590],[16000,31281],[16500,31973],[17000,32664],[17500,33355],[18000,34047],[18500,34737],[19000,35428],[19500,36119],[20000,36810],
  [21000,37501],[22000,39414],[23000,41329],[24000,43244],[25000,45160],[26000,47074],[27000,48989],[28000,50902],[29000,52817],[30000,54733],
  [31000,56647],[32000,58563],[33000,62562],[34000,64457],[35000,66353],[36000,68249],[37000,70145],[38000,72041],[39000,73936],[40000,75832],
  [41000,77728],[42000,79624],[43000,81520],[44000,83416],[45000,83416],[46000,83416],[47000,83416],[48000,83416],[49000,83416],[50000,83416],
  [51000,84999],[52000,86666],[53000,88333],[54000,89999],[55000,91666],[56000,93333],[57000,94999],[58000,96666],[59000,98333],[60000,99999],
  [61000,101666],[62000,103332],[63000,104999],[64000,106666],[65000,108332],[66000,109999],[67000,111666],[68000,113332]
];

// --- FedEx IP Package Zone M (DE/GB) ---
const ipPackageZoneM = [
  [500,2803],[1000,3746],[1500,4228],[2000,4738],[2500,5220],[3000,5639],[3500,6141],[4000,6566],[4500,6990],[5000,7414],
  [5500,9216],[6000,9543],[6500,9871],[7000,10199],[7500,10526],[8000,10854],[8500,11182],[9000,11510],[9500,11510],[10000,11794],
  [10500,12017],[11000,12239],[11500,12461],[12000,12685],[12500,12739],[13000,12959],[13500,13179],[14000,13400],[14500,13619],[15000,13839],
  [15500,14059],[16000,14300],[16500,14520],[17000,14740],[17500,14961],[18000,15180],[18500,15401],[19000,15621],[19500,15840],[20000,15840],
  [21000,15840],[22000,15840],[23000,15840],[24000,15840],[25000,15840],[26000,15840],[27000,15840],[28000,15840],[29000,16125],[30000,16681],
  [31000,17238],[32000,17794],[33000,18347],[34000,18903],[35000,19459],[36000,20014],[37000,20570],[38000,21126],[39000,21682],[40000,22238],
  [41000,22794],[42000,23350],[43000,23906],[44000,24462],[45000,24944],[46000,25498],[47000,26052],[48000,26607],[49000,27161],[50000,27715],
  [51000,28270],[52000,28824],[53000,29378],[54000,29933],[55000,30487],[56000,31041],[57000,31596],[58000,32150],[59000,32704],[60000,33258],
  [61000,33813],[62000,34367],[63000,34921],[64000,35476],[65000,36030],[66000,36584],[67000,37139],[68000,37693]
];

// --- FedEx IP Package Zone U (AU/NZ) ---
const ipPackageZoneU = [
  [500,6957],[1000,8016],[1500,9465],[2000,10802],[2500,12241],[3000,13653],[3500,14776],[4000,16161],[4500,17547],[5000,18932],
  [5500,20555],[6000,21480],[6500,22405],[7000,23332],[7500,24257],[8000,25182],[8500,26109],[9000,27034],[9500,27904],[10000,28826],
  [10500,29389],[11000,29950],[11500,30513],[12000,31075],[12500,31645],[13000,32207],[13500,32770],[14000,33332],[14500,33895],[15000,34456],
  [15500,35018],[16000,35634],[16500,36198],[17000,36760],[17500,37325],[18000,37887],[18500,38449],[19000,39014],[19500,39576],[20000,40139],
  [21000,40752],[22000,40752],[23000,40752],[24000,40752],[25000,41291],[26000,42943],[27000,44594],[28000,46246],[29000,47898],[30000,49550],
  [31000,51202],[32000,52852],[33000,54512],[34000,56163],[35000,57815],[36000,59467],[37000,61119],[38000,62771],[39000,64423],[40000,66075],
  [41000,67727],[42000,69378],[43000,71030],[44000,72682],[45000,72682],[46000,74034],[47000,75643],[48000,77253],[49000,78862],[50000,80471],
  [51000,82081],[52000,83690],[53000,85300],[54000,86909],[55000,88519],[56000,90128],[57000,91737],[58000,93347],[59000,94956],[60000,96566],
  [61000,98175],[62000,99785],[63000,101394],[64000,103003],[65000,104613],[66000,106222],[67000,107832],[68000,109441]
];

// --- DHL Zone 2 (France) ---
const dhlZone2 = [
  [500,2073],[1000,2073],[1500,2468],[2000,2905],[2500,3195],[3000,3340],[3500,3555],[4000,3898],[4500,4053],[5000,4208],
  [5500,4829],[6000,5454],[6500,6077],[7000,6701],[7500,7324],[8000,7949],[8500,8571],[9000,9195],[9500,9819],[10000,10443],
  [10500,11145],[11000,11847],[11500,12547],[12000,13249],[12500,13950],[13000,14651],[13500,15321],[14000,16024],[14500,16725],[15000,17426],
  [15500,18128],[16000,18830],[16500,19532],[17000,20234],[17500,20935],[18000,21637],[18500,22339],[19000,23041],[19500,23743],[20000,24445],
  [21000,25790],[22000,27136],[23000,28480],[24000,29824],[25000,31169],[26000,32513],[27000,33858],[28000,35203],[29000,36535],[30000,37891]
];

// --- DHL Zone 3 (Germany/Italy/NL/CH) ---
const dhlZone3 = [
  [500,2073],[1000,2073],[1500,2468],[2000,2905],[2500,3195],[3000,3340],[3500,3555],[4000,3898],[4500,4053],[5000,4208],
  [5500,4829],[6000,5454],[6500,6077],[7000,6701],[7500,7324],[8000,7949],[8500,8571],[9000,9195],[9500,9819],[10000,10443],
  [10500,11145],[11000,11847],[11500,12547],[12000,13249],[12500,13950],[13000,14651],[13500,15321],[14000,16024],[14500,16725],[15000,17426],
  [15500,18128],[16000,18830],[16500,19532],[17000,20234],[17500,20935],[18000,21637],[18500,22339],[19000,23041],[19500,23743],[20000,24445],
  [21000,25790],[22000,27136],[23000,28480],[24000,29824],[25000,31169],[26000,32513],[27000,33858],[28000,35203],[29000,36535],[30000,37891]
];

// --- DHL Zone 4 (UK/Spain) ---
const dhlZone4 = [
  [500,2285],[1000,2827],[1500,3073],[2000,3378],[2500,3393],[3000,4215],[3500,5139],[4000,6291],[4500,7173],[5000,8055],
  [5500,8954],[6000,9854],[6500,10753],[7000,11651],[7500,12551],[8000,14108],[8500,15053],[9000,15995],[9500,16941],[10000,17883],
  [10500,18741],[11000,19600],[11500,20457],[12000,21315],[12500,22172],[13000,23028],[13500,23862],[14000,24721],[14500,25579],[15000,26437],
  [15500,27294],[16000,28152],[16500,29009],[17000,29865],[17500,30722],[18000,31579],[18500,32437],[19000,33294],[19500,34151],[20000,35007],
  [21000,36724],[22000,38439],[23000,40155],[24000,41872],[25000,43588],[26000,45305],[27000,47021],[28000,48736],[29000,50462],[30000,52174]
];

// --- DHL Zone 5 (Canada) ---
const dhlZone5 = [
  [500,2342],[1000,2653],[1500,2767],[2000,2907],[2500,3250],[3000,3589],[3500,4012],[4000,4360],[4500,4711],[5000,5059],
  [5500,5407],[6000,5755],[6500,6174],[7000,6650],[7500,7123],[8000,7599],[8500,8073],[9000,8550],[9500,9031],[10000,9510],
  [10500,9991],[11000,10471],[11500,10951],[12000,11432],[12500,11912],[13000,12393],[13500,12872],[14000,13353],[14500,13833],[15000,14315],
  [15500,14795],[16000,15276],[16500,15757],[17000,16237],[17500,16719],[18000,17199],[18500,17680],[19000,18161],[19500,18642],[20000,19123],
  [21000,20083],[22000,21043],[23000,22003],[24000,22962],[25000,23922],[26000,24881],[27000,25839],[28000,26799],[29000,27749],[30000,28717]
];

// --- DHL Zone 11 (Australia) ---
const dhlZone11 = [
  [500,2419],[1000,2419],[1500,2419],[2000,2427],[2500,4155],[3000,4173],[3500,4297],[4000,4314],[4500,4325],[5000,4330],
  [5500,5730],[6000,7218],[6500,8708],[7000,10197],[7500,11685],[8000,13176],[8500,14665],[9000,16152],[9500,17643],[10000,19132],
  [10500,19489],[11000,19846],[11500,20203],[12000,20560],[12500,20918],[13000,21276],[13500,21632],[14000,21991],[14500,22348],[15000,22705],
  [15500,23062],[16000,23418],[16500,23775],[17000,24131],[17500,24488],[18000,24844],[18500,25200],[19000,25557],[19500,25914],[20000,26271],
  [21000,27319],[22000,28368],[23000,29417],[24000,30466],[25000,31517],[26000,32566],[27000,33616],[28000,34665],[29000,35712],[30000,36752]
];

// --- DHL Envelope per zone (max 0.3kg) ---
const dhlEnvelopeRates = { 2:2111, 3:2111, 4:2439, 5:2342, 10:2454, 11:2439 };

// --- Economy UK (max 25kg, real weight â‰¤ 15kg, 7-10æ—¥, Â£135ä»¥ä¸‹) ---
const economyUK = [
  [100,938],[200,1073],[300,1244],[400,1430],[500,1571],[600,1703],[700,1851],[800,1968],[900,2121],[1000,2240],
  [1100,2411],[1200,2552],[1300,2690],[1400,2811],[1500,2947],[1600,3068],[1700,3234],[1800,3357],[1900,3497],[2000,3620],
  [2500,4402],[3000,5095],[3500,5760],[4000,6412],[4500,7079],[5000,7810],[5500,8484],[6000,9142],[6500,9815],[7000,10475],
  [7500,11149],[8000,11809],[8500,12483],[9000,13141],[9500,13815],[10000,14474],[10500,15148],[11000,15807],[11500,16482],[12000,17140],
  [12500,17814],[13000,18472],[13500,19147],[14000,19806],[14500,20696],[15000,21362],[15500,22043],[16000,22710],[16500,23392],[17000,24058],
  [17500,24739],[18000,25404],[18500,26086],[19000,26752],[19500,27434],[20000,28100],[20500,28783],[21000,29448],[21500,30129],[22000,30794],
  [22500,33796],[23000,34512],[23500,35245],[24000,35960],[24500,36693],[25000,37410]
];

// --- Economy Germany (max 25kg, 7-11æ—¥, â‚¬150ä»¥ä¸‹) ---
const economyDE = [
  [100,1336],[200,1460],[300,1589],[400,1634],[500,1769],[600,1863],[700,1978],[800,2178],[900,2273],[1000,2273],
  [1100,2387],[1200,2609],[1300,2609],[1400,2609],[1500,2919],[1600,3313],[1700,3313],[1800,3617],[1900,3621],[2000,4092],
  [2500,4618],[3000,5092],[3500,6088],[4000,6563],[4500,7049],[5000,7524],[5500,8540],[6000,9014],[6500,9500],[7000,10442],
  [7500,10929],[8000,11405],[8500,12358],[9000,12832],[9500,13318],[10000,13805],[10500,14841],[11000,15316],[11500,15802],[12000,16743],
  [12500,17231],[13000,17716],[13500,18659],[14000,19134],[14500,19621],[15000,20107],[15500,21183],[16000,21670],[16500,22143],[17000,23086],
  [17500,23573],[18000,24060],[18500,25001],[19000,25488],[19500,25963],[20000,26451],[20500,27555],[21000,28042],[21500,28517],[22000,29471],
  [22500,29946],[23000,30433],[23500,30453],[24000,30472],[24500,30492],[25000,30511]
];

// --- Economy Australia (real weight â‰¤ 22kg, billable â‰¤ 22.5kg, 6-12æ—¥, AUD1000ä»¥ä¸‹) ---
const economyAU = [
  [100,1142],[200,1322],[300,1508],[400,1539],[500,1630],[600,1812],[700,1847],[800,1997],[900,2068],[1000,2068],
  [1100,2139],[1200,2174],[1300,2209],[1400,2462],[1500,2462],[1600,2462],[1700,2462],[1800,2724],[1900,3153],[2000,3153],
  [2500,3153],[3000,3507],[3500,4015],[4000,4369],[4500,4547],[5000,5290],[5500,5466],[6000,5820],[6500,5997],[7000,6977],
  [7500,7155],[8000,7509],[8500,7687],[9000,8041],[9500,8219],[10000,8573],[10500,8749],[11000,9104],[11500,9281],[12000,9636],
  [12500,9813],[13000,10167],[13500,10344],[14000,10700],[14500,10877],[15000,11230],[15500,11409],[16000,11762],[16500,11940],[17000,13581],
  [17500,13758],[18000,14112],[18500,14290],[19000,14644],[19500,14821],[20000,15176],[20500,15176],[21000,15176],[21500,15176],[22000,15431],
  [22500,15768]
];

// ========== Country Configuration ==========
const COUNTRIES = [
  { id:'us', name:'ğŸ‡ºğŸ‡¸ ã‚¢ãƒ¡ãƒªã‚«', fedexZone:'F', dhlZone:10, jpZone:4, jpOk:false, economy:true, ecoTable:speedpakEconomyRates, ecoMaxKg:25, ecoMaxVal:'$1,300', ecoDays:'8-12æ—¥',
    ecoSizeCheck:(L,W,H,g)=>{ const d=[L,W,H].sort((a,b)=>b-a); return d[0]<=66 && (d[0]+2*(d[1]+d[2]))<=274; },
    ecoSurcharge:(L,W,H,vol)=>(Math.max(L,W,H)>55.88||vol>55000?2475:0)+245 },
  { id:'uk', name:'ğŸ‡¬ğŸ‡§ ã‚¤ã‚®ãƒªã‚¹', fedexZone:'M', dhlZone:4, jpZone:3, jpOk:true, economy:true, ecoTable:economyUK, ecoMaxKg:25, ecoRealMaxKg:15, ecoMaxVal:'Â£135', ecoDays:'7-10æ—¥',
    ecoSizeCheck:(L,W,H,g)=>{ const d=[L,W,H].sort((a,b)=>b-a); return d[0]<=120 && (d[0]+2*(d[1]+d[2]))<=225; },
    ecoSurcharge:()=>0 },
  { id:'de', name:'ğŸ‡©ğŸ‡ª ãƒ‰ã‚¤ãƒ„', fedexZone:'M', dhlZone:3, jpZone:3, jpOk:true, economy:true, ecoTable:economyDE, ecoMaxKg:25, ecoMaxVal:'â‚¬150', ecoDays:'7-11æ—¥',
    ecoSizeCheck:(L,W,H,g)=>{ const d=[L,W,H].sort((a,b)=>b-a); return d[0]<=110 && d[1]<=50 && d[2]<=50; },
    ecoSurcharge:()=>0 },
  { id:'au', name:'ğŸ‡¦ğŸ‡º ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢', fedexZone:'U', dhlZone:11, jpZone:3, jpOk:true, economy:true, ecoTable:economyAU, ecoMaxKg:22.5, ecoRealMaxKg:22, ecoMaxVal:'AUD1,000', ecoDays:'6-12æ—¥',
    ecoSizeCheck:(L,W,H,g)=>{ const d=[L,W,H].sort((a,b)=>b-a); return d[0]<=105 && (d[0]*d[1]*d[2])<=180000; },
    ecoSurcharge:()=>0 },
  { id:'fr', name:'ğŸ‡«ğŸ‡· ãƒ•ãƒ©ãƒ³ã‚¹', fedexZone:'M', dhlZone:2, jpZone:3, jpOk:true, economy:false },
  { id:'ca', name:'ğŸ‡¨ğŸ‡¦ ã‚«ãƒŠãƒ€', fedexZone:'F', dhlZone:5, jpZone:3, jpOk:true, economy:false },
  { id:'it', name:'ğŸ‡®ğŸ‡¹ ã‚¤ã‚¿ãƒªã‚¢', fedexZone:'M', dhlZone:3, jpZone:3, jpOk:true, economy:false },
  { id:'es', name:'ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³', fedexZone:'M', dhlZone:4, jpZone:3, jpOk:true, economy:false },
];

function getFicpTable(zone) { return zone==='M'?ficpZoneM:zone==='U'?ficpZoneU:speedpakFicpRates; }
function getIpPackageTable(zone) { return zone==='M'?ipPackageZoneM:zone==='U'?ipPackageZoneU:speedpakIpPackageRates; }
function getDhlTable(z) { return z===2?dhlZone2:z===3?dhlZone3:z===4?dhlZone4:z===5?dhlZone5:z===11?dhlZone11:speedpakDhlRates; }
function getDhlEnvelopeRate(z) { return dhlEnvelopeRates[z]||2454; }
function getEpacketLightTable(jpZone) { return jpZone===3?epacketLightZone3:epacketLightZone4; }
function getEmsTable(jpZone) { return jpZone===3?emsZone3:emsZone4; }

// --- æ—¥æœ¬éƒµä¾¿ eãƒ‘ã‚±ãƒƒãƒˆãƒ©ã‚¤ãƒˆ (å®Ÿé‡é‡, æœ€å¤§2kg) ---
// ç¬¬3åœ°å¸¯: ã‚ªã‚»ã‚¢ãƒ‹ã‚¢ãƒ»åŒ—ç±³(ç±³å›½é™¤ã)ãƒ»ä¸­è¿‘æ±ãƒ»ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ (UK/DE/FR/CA/AU/IT/ES)
const epacketLightZone3 = [
  [100,880],[200,1060],[300,1240],[400,1420],[500,1600],
  [600,1780],[700,1960],[800,2140],[900,2320],[1000,2500],
  [1100,2680],[1200,2860],[1300,3040],[1400,3220],[1500,3400],
  [1600,3580],[1700,3760],[1800,3940],[1900,4120],[2000,4300]
];
// ç¬¬4åœ°å¸¯: ã‚¢ãƒ¡ãƒªã‚«(ã‚°ã‚¢ãƒ ç­‰æµ·å¤–é ˜åœŸå«ã‚€)
const epacketLightZone4 = [
  [100,1200],[200,1410],[300,1620],[400,1830],[500,2040],
  [600,2250],[700,2460],[800,2670],[900,2880],[1000,3090],
  [1100,3300],[1200,3510],[1300,3720],[1400,3930],[1500,4140],
  [1600,4350],[1700,4560],[1800,4770],[1900,4980],[2000,5190]
];

// --- æ—¥æœ¬éƒµä¾¿ EMS (å®Ÿé‡é‡, æœ€å¤§30kg) ---
// ç¬¬3åœ°å¸¯
const emsZone3 = [
  [500,3150],[600,3400],[700,3650],[800,3900],[900,4150],
  [1000,4400],[1250,5000],[1500,5550],[1750,6150],[2000,6700],
  [2500,7750],[3000,8800],[3500,9850],[4000,10900],[4500,11950],
  [5000,13000],[5500,14050],[6000,15100],[7000,17200],[8000,19300],
  [9000,21400],[10000,23500],[11000,25600],[12000,27700],[13000,29800],
  [14000,31900],[15000,34000],[16000,36100],[17000,38200],[18000,40300],
  [19000,42400],[20000,44500],[21000,46600],[22000,48700],[23000,50800],
  [24000,52900],[25000,55000],[26000,57100],[27000,59200],[28000,61300],
  [29000,63400],[30000,65500]
];
// ç¬¬4åœ°å¸¯
const emsZone4 = [
  [500,3900],[600,4180],[700,4460],[800,4740],[900,5020],
  [1000,5300],[1250,5990],[1500,6600],[1750,7290],[2000,7900],
  [2500,9100],[3000,10300],[3500,11500],[4000,12700],[4500,13900],
  [5000,15100],[5500,16300],[6000,17500],[7000,19900],[8000,22300],
  [9000,24700],[10000,27100],[11000,29500],[12000,31900],[13000,34300],
  [14000,36700],[15000,39100],[16000,41500],[17000,43900],[18000,46300],
  [19000,48700],[20000,51100],[21000,53500],[22000,55900],[23000,58300],
  [24000,60700],[25000,63100],[26000,65500],[27000,67900],[28000,70300],
  [29000,72700],[30000,75100]
];

// ========== Utility Functions ==========

function lookupRate(table, weightGrams) {
  for (let i = 0; i < table.length; i++) {
    if (weightGrams <= table[i][0]) return table[i][1];
  }
  return -1;
}

function getVal(id) { return parseFloat(document.getElementById(id).value) || 0; }
function fmt(n) { return Math.round(n).toLocaleString('ja-JP'); }
function fmtD(n) { return n.toFixed(2); }

const currentSort = 'profit';
let currentCountry = 'us';
let currentPricingMode = 'us';

function initCountrySelector() {
  const sel = document.getElementById('destCountry');
  COUNTRIES.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
  sel.value = 'us';
}

function onCountryChange() {
  currentCountry = document.getElementById('destCountry').value;
  calculate();
}

function setPricingMode(mode) {
  currentPricingMode = mode;
  document.getElementById('modeUs').classList.toggle('active', mode === 'us');
  document.getElementById('modeOther').classList.toggle('active', mode === 'other');
  document.getElementById('usSection').style.display = mode === 'us' ? '' : 'none';
  document.getElementById('otherSection').style.display = mode === 'other' ? '' : 'none';
  updatePricingDisplay();
  calculate();
}

function getEffectiveSellingPrice() {
  const selling = getVal('sellingPrice');
  if (currentPricingMode === 'us') {
    const compShipping = getVal('compShipping');
    const compTotal = selling + compShipping;
    if (compTotal <= 0) return selling;
    if ((compTotal - 0.01) > 2499.99) {
      return Math.round((compTotal - 0.01) * 100) / 100;
    } else {
      return Math.round((compTotal * 0.816 - 0.01) * 100) / 100;
    }
  }
  return selling;
}

function updatePricingDisplay() {
  const selling = getVal('sellingPrice');
  if (currentPricingMode === 'us') {
    const compShipping = getVal('compShipping');
    const compTotal = selling + compShipping;
    let listPrice, listShipping;
    if (compTotal <= 0) {
      listPrice = selling; listShipping = 0;
    } else if ((compTotal - 0.01) > 2499.99) {
      listPrice = Math.round((compTotal - 0.01) * 100) / 100;
      listShipping = 0;
    } else {
      listPrice = Math.round((compTotal * 0.816 - 0.01) * 100) / 100;
      listShipping = Math.round((compTotal - 0.01) * 0.184 * 100) / 100;
    }
    document.getElementById('listPrice').textContent = '$' + fmtD(listPrice);
    document.getElementById('listShipping').textContent = '$' + fmtD(listShipping);
  } else {
    const tariff = getVal('usTariffRate') / 100;
    const usShipping = Math.round(selling * tariff * 100) / 100;
    document.getElementById('otherPricingInfo').innerHTML =
      'ğŸ‡ºğŸ‡¸ç±³å›½å‘ã‘é€æ–™: <strong>$' + fmtD(usShipping) + '</strong>';
  }
}

function toggleSettings() {
  const c = document.getElementById('settingsContent');
  const b = document.getElementById('settingsToggle');
  if (c.classList.contains('show')) {
    c.classList.remove('show');
    b.textContent = 'è©³ç´°è¨­å®š â–¼';
    b.classList.remove('active');
  } else {
    c.classList.add('show');
    b.textContent = 'è©³ç´°è¨­å®š â–²';
    b.classList.add('active');
  }
}

function toggleFeeDetail() {
  const c = document.getElementById('feeDetailContent');
  const b = document.getElementById('feeToggle');
  if (c.classList.contains('show')) {
    c.classList.remove('show');
    b.textContent = 'å†…è¨³ â–¼';
    b.classList.remove('active');
  } else {
    c.classList.add('show');
    b.textContent = 'å†…è¨³ â–²';
    b.classList.add('active');
  }
}

async function fetchRate() {
  try {
    const r = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
    const d = await r.json();
    if (d.rates && d.rates.JPY) {
      document.getElementById('exchangeRate').value = d.rates.JPY.toFixed(4);
      calculate();
    }
  } catch(e) {
    alert('ãƒ¬ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }
}

// ========== Fuel Surcharge Auto-Fetch (EIA APIçµŒç”±) ==========
// FedEx Express International Export ç‡ƒæ–™å‰²å¢—é‡‘ãƒ†ãƒ¼ãƒ–ãƒ« (Effective Dec 1, 2025)
// USGC Kerosene-Type Jet Fuel $/gallon â†’ ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸%
// å›½éš›è¼¸å‡ºç”¨: å›½å†…ãƒ†ãƒ¼ãƒ–ãƒ«ã‚ˆã‚Šç´„2.5%é«˜ã„
// $2.120 â†’ 30.50% (FedExå…¬å¼ 2026å¹´2æœˆ16-22æ—¥é€±ã§ç¢ºèªæ¸ˆã¿)
// $0.05åˆ»ã¿ã§0.5%ãšã¤å¤‰å‹•
const FUEL_TABLE = [
  [1.36, 23.0],[1.41, 23.5],[1.46, 24.0],[1.51, 24.5],[1.56, 25.0],
  [1.61, 25.5],[1.66, 26.0],[1.71, 26.5],[1.76, 27.0],[1.81, 27.5],
  [1.86, 28.0],[1.91, 28.5],[1.96, 29.0],[2.01, 29.5],[2.06, 30.0],
  [2.11, 30.5],[2.16, 31.0],[2.21, 31.5],[2.26, 32.0],[2.31, 32.5],
  [2.36, 33.0],[2.41, 33.5],[2.46, 34.0],[2.51, 34.5],[2.56, 35.0],
  [2.61, 35.5],[2.66, 36.0],[2.71, 36.5],[2.76, 37.0],[2.81, 37.5],
  [2.86, 38.0],[2.91, 38.5],[2.96, 39.0],[3.01, 39.5],[3.06, 40.0],
];
const FUEL_CACHE_KEY = 'fedex_fuel_surcharge';
const FUEL_CACHE_TIME_KEY = 'fedex_fuel_surcharge_time';
const FUEL_CACHE_PRICE_KEY = 'fedex_fuel_price';
const FUEL_CACHE_TTL = 7 * 24 * 60 * 60 * 1000; // 7æ—¥ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆEIAã¯é€±æ¬¡æ›´æ–°ï¼‰

function _fuelPriceToSurcharge(pricePerGallon) {
  for (let i = FUEL_TABLE.length - 1; i >= 0; i--) {
    if (pricePerGallon >= FUEL_TABLE[i][0]) return FUEL_TABLE[i][1];
  }
  return FUEL_TABLE[0][1]; // æœ€ä½å€¤
}

async function _fetchJetFuelPrice() {
  // EIA API: USGC Kerosene-Type Jet Fuel Spot Price (é€±æ¬¡)
  const url = 'https://api.eia.gov/v2/petroleum/pri/spt/data/?api_key=DEMO_KEY&frequency=weekly&data[0]=value&facets[series][]=EER_EPJK_PF4_RGC_DPG&sort[0][column]=period&sort[0][direction]=desc&length=1';
  const r = await fetch(url, { signal: AbortSignal.timeout(10000) });
  const d = await r.json();
  if (d.response && d.response.data && d.response.data.length > 0) {
    return { price: parseFloat(d.response.data[0].value), date: d.response.data[0].period };
  }
  return null;
}

async function fetchFuelSurcharge(silent) {
  const statusEl = document.getElementById('fuelStatus');
  if (statusEl) statusEl.textContent = 'å–å¾—ä¸­...';
  try {
    const result = await _fetchJetFuelPrice();
    if (result) {
      const surcharge = _fuelPriceToSurcharge(result.price);
      document.getElementById('fuelSurcharge').value = surcharge;
      localStorage.setItem(FUEL_CACHE_KEY, surcharge);
      localStorage.setItem(FUEL_CACHE_PRICE_KEY, result.price);
      localStorage.setItem(FUEL_CACHE_TIME_KEY, Date.now());
      if (statusEl) statusEl.textContent = 'âœ“ ' + surcharge + '% (ç‡ƒæ–™$' + result.price.toFixed(3) + '/gal ' + result.date + ')';
      calculate();
      if (!silent) alert('FedExç‡ƒæ²¹ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸: ' + surcharge + '%\n(ã‚¸ã‚§ãƒƒãƒˆç‡ƒæ–™: $' + result.price.toFixed(3) + '/gal, ' + result.date + 'é€±)');
    } else {
      throw new Error('ãƒ‡ãƒ¼ã‚¿ãªã—');
    }
  } catch(e) {
    const cached = localStorage.getItem(FUEL_CACHE_KEY);
    if (cached) {
      const age = Date.now() - (parseInt(localStorage.getItem(FUEL_CACHE_TIME_KEY)) || 0);
      const days = Math.floor(age / (24*60*60*1000));
      if (statusEl) statusEl.textContent = 'âš  ' + cached + '% (' + days + 'æ—¥å‰)';
    } else {
      if (statusEl) statusEl.textContent = 'âš  å–å¾—å¤±æ•—';
    }
    if (!silent) alert('è‡ªå‹•å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\næ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nç¾åœ¨ã®å€¤: ' + document.getElementById('fuelSurcharge').value + '%');
  }
}

function initFuelSurcharge() {
  const cached = localStorage.getItem(FUEL_CACHE_KEY);
  const cachedTime = parseInt(localStorage.getItem(FUEL_CACHE_TIME_KEY)) || 0;
  const age = Date.now() - cachedTime;
  if (cached && age < FUEL_CACHE_TTL) {
    document.getElementById('fuelSurcharge').value = cached;
    const price = localStorage.getItem(FUEL_CACHE_PRICE_KEY) || '?';
    const statusEl = document.getElementById('fuelStatus');
    if (statusEl) statusEl.textContent = 'âœ“ ' + cached + '% (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ç‡ƒæ–™$' + price + '/gal)';
  } else {
    fetchFuelSurcharge(true);
  }
}

// ========== Main Calculation ==========

function calculate() {
  updatePricingDisplay();
  const purchase = getVal('purchasePrice');
  const selling = getEffectiveSellingPrice();
  const weightKg = getVal('weight');
  const L = getVal('length');
  const W = getVal('width');
  const H = getVal('height');

  const ebayRate1 = getVal('ebayFeeRate') / 100;
  const threshold = getVal('feeThreshold');
  const ebayRate2 = getVal('ebayFeeRate2') / 100;
  const perOrder = getVal('perOrderFee');
  const promotedRate = getVal('promotedRate') / 100;
  const intlRate = getVal('intlFeeRate') / 100;
  const payoneerRate = getVal('payoneerRate') / 100;
  const rate = getVal('exchangeRate');
  const taxRate = getVal('taxRate') / 100;
  const taxMultiplier = 1 + taxRate;
  const fuelSurchargeRate = getVal('fuelSurcharge') / 100; // ç‡ƒæ²¹ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸ç‡

  const vol = L * W * H;
  const volWeight = vol / 5000;
  const volWeightEco = vol / 8000;

  document.getElementById('volWeight').textContent = volWeight.toFixed(3) + ' kg';
  document.getElementById('volWeightEco').textContent = volWeightEco.toFixed(3) + ' kg';

  // eBay FVF: two-rate system
  let fvfBase = 0;
  if (selling <= threshold) {
    fvfBase = selling * ebayRate1;
  } else {
    fvfBase = threshold * ebayRate1 + (selling - threshold) * ebayRate2;
  }
  const ebayFvf = (fvfBase + perOrder) * taxMultiplier;
  const promotedFee = selling * promotedRate * taxMultiplier;
  const intlFee = selling * intlRate * taxMultiplier;
  const totalEbayDeductions = ebayFvf + promotedFee + intlFee;
  const netPayout = selling - totalEbayDeductions;
  const payoneerFee = netPayout * payoneerRate;
  const netReceived = netPayout * (1 - payoneerRate) * rate;
  const revenueYen = selling * rate;
  const totalFeesYen = revenueYen - netReceived;

  const purchaseTax = purchase * taxRate / taxMultiplier;
  const ebayFeeTaxPortion = totalEbayDeductions / taxMultiplier * taxRate * rate;
  const totalRefund = purchaseTax + ebayFeeTaxPortion;

  document.getElementById('revenueYen').textContent = 'Â¥' + fmt(revenueYen) + 'ï¼ˆ$' + fmtD(selling) + 'ï¼‰';
  document.getElementById('totalFeesYen').textContent = 'Â¥' + fmt(totalFeesYen);
  document.getElementById('feeEbay').textContent = '$' + fmtD(ebayFvf);
  document.getElementById('feePromoted').textContent = '$' + fmtD(promotedFee);
  document.getElementById('feeIntl').textContent = '$' + fmtD(intlFee);
  document.getElementById('feePayoneer').textContent = '$' + fmtD(payoneerFee) + 'ï¼ˆÂ¥' + fmt(payoneerFee * rate) + 'ï¼‰';
  document.getElementById('feeTotalUsd').textContent = '$' + fmtD(totalEbayDeductions + payoneerFee) + 'ï¼ˆÂ¥' + fmt(totalFeesYen) + 'ï¼‰';

  // ========== Shipping Methods ==========
  const weightG = weightKg * 1000;
  const dims = [L, W, H].sort((a,b) => b-a);
  const longest = dims[0];
  const girth = longest + 2 * (dims[1] + dims[2]);
  const billableStandard = Math.max(weightKg, volWeight);
  const billableStandardG = billableStandard * 1000;
  const billableEcoKg = Math.max(weightKg, volWeightEco);
  const billableEcoG = billableEcoKg * 1000;

  // Current country config
  const cc = COUNTRIES.find(c => c.id === currentCountry) || COUNTRIES[0];
  const ficpTable = getFicpTable(cc.fedexZone);
  const ipPkgTable = getIpPackageTable(cc.fedexZone);
  const dhlTable = getDhlTable(cc.dhlZone);
  const dhlEnvRate = getDhlEnvelopeRate(cc.dhlZone);
  const isUS = currentCountry === 'us';

  const groups = [
    { id: 'fedex',    label: 'SpeedPAK FedEx International Connect Plus', icon: 'ğŸŸ£', cls: 'group-elogi',    tag: 'æ¨å¥¨',      primary: true,  methods: [], note: 'åŸºæœ¬çš„ã«ã¯ã“ã®é…é€æ–¹æ³•ã§OK' },
    { id: 'fedex-ip', label: 'SpeedPAK FedEx International Priority',   icon: 'ğŸŸ£', cls: 'group-elogi',    tag: 'é€Ÿé”',      primary: false, methods: [], collapsed: true, note: 'æ—©ã„é…é€æ–¹æ³•ã€å°‘ã—é«˜ã„' },
    { id: 'dhl',      label: 'SpeedPAK DHL',        icon: 'ğŸŸ¡', cls: 'group-dhl',      tag: 'æ¨å¥¨',      primary: true,  methods: [], note: 'å®‰ã‘ã‚Œã°ä½¿ç”¨OKã€åŸºæœ¬çš„ã«ã¯FedExãŒå®‰ã„' },
    { id: 'speedpak', label: 'SpeedPAK Economy',    icon: 'ğŸŸ ', cls: 'group-speedpak', tag: cc.economy?'4ãƒ¶å›½é™å®š':'éå¯¾å¿œ', primary: false, methods: [], note: cc.economy?'é…é€ãŒé…ã„ã®ã§ä½¿ç”¨ã™ã‚‹å ´åˆã¯Economyç”¨ã®Shipping Policyã‚’ä½œæˆã—ã¦ãã ã•ã„':'ã“ã®å›½ã¯Economyéå¯¾å¿œã§ã™' },
    { id: 'jppost',   label: 'æ—¥æœ¬éƒµä¾¿',             icon: 'ğŸŸ¢', cls: cc.jpOk!==false?'group-jppost':'group-unavail', tag: cc.jpOk!==false?'è£œåŠ©':'å·®å‡ºä¸å¯', primary: false, methods: [], note: cc.jpOk!==false?'SpeedPAKéå¯¾å¿œãƒ»è‡ªåˆ†ã§ç™ºé€æ‰‹ç¶šããŒå¿…è¦':'ã“ã®å›½ã¯æ—¥æœ¬éƒµä¾¿ã®å·®å‡ºãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ï¼ˆâ–³ï¼‰' },
  ];

  function addMethod(groupId, m) {
    m._groupId = groupId;
    const g = groups.find(g => g.id === groupId);
    if (g) g.methods.push(m);
  }

  // ===== SpeedPAK Economy =====
  if (cc.economy) {
    const maxKg = cc.ecoMaxKg || 25;
    const realMaxKg = cc.ecoRealMaxKg || Infinity;
    const csW = billableEcoKg <= maxKg && weightKg <= realMaxKg;
    const csD = cc.ecoSizeCheck ? cc.ecoSizeCheck(L, W, H, billableEcoG) : true;
    const cs = csW && csD;
    let c = cs ? lookupRate(cc.ecoTable, billableEcoG) : -1;
    if (cs && c > 0 && cc.ecoSurcharge) c += cc.ecoSurcharge(L, W, H, vol);
    const r2 = [];
    if (!csW) r2.push(maxKg + 'kgè¶…é');
    if (!csD) r2.push('ã‚µã‚¤ã‚ºè¶…é');
    addMethod('speedpak',{name:'Economy',sub:cc.ecoDays+'/'+cc.ecoMaxVal+'ä»¥ä¸‹/ä½“ç©Ã·8,000/DDP',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:r2.join(', ')});
  } else {
    addMethod('speedpak',{name:'Economy',sub:'ã“ã®å›½ã¯Economyéå¯¾å¿œ',cost:-1,canSend:false,reason:cc.name+' éå¯¾å¿œ'});
  }

  // ===== SpeedPAK FedEx FICP (International Connect Plus) =====
  {
    const cs = billableStandardG <= 68000;
    let c = cs ? lookupRate(ficpTable, billableStandardG) : -1;
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    addMethod('fedex',{name:'International Connect Plus',sub:'2-5æ—¥/DDP/æœ€å¤§68kg/ä½“ç©Ã·5,000/ç‡ƒæ²¹è¾¼',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:!cs?'68kgè¶…é':''});
  }

  // ===== SpeedPAK FedEx IP Envelope (US/CA only) =====
  if (cc.fedexZone === 'F') {
    const sorted = [L, W, H].sort((a,b) => b-a);
    const csW = weightG <= 500;
    const csS = sorted[0] <= 33.5 && sorted[1] <= 23.5 && sorted[2] <= 3;
    const cs = csW && csS;
    let c = cs ? lookupRate(speedpakIpEnvelopeRates, weightG) : -1;
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    const r2 = [];
    if (!csW) r2.push('500gè¶…é');
    if (!csS) r2.push('ã‚µã‚¤ã‚ºè¶…é(23.5x33.5x3cm)');
    addMethod('fedex-ip',{name:'FedEx IP Envelope',sub:'1-3æ—¥/DDP/æœ€å¤§500g/å†…å¯¸23.5Ã—33.5Ã—3cm/ç‡ƒæ²¹è¾¼',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:r2.join(', ')});
  }

  // ===== SpeedPAK FedEx IP Pak (US/CA only) =====
  if (cc.fedexZone === 'F') {
    const cs = weightG <= 2500;
    let c = cs ? lookupRate(speedpakIpPakRates, weightG) : -1;
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    addMethod('fedex-ip',{name:'FedEx IP Pak',sub:'1-3æ—¥/DDP/æœ€å¤§2.5kg/å®Ÿé‡é‡/ç‡ƒæ²¹è¾¼',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:!cs?'2.5kgè¶…é':''});
  }

  // ===== SpeedPAK FedEx IP Package =====
  {
    const cs = billableStandardG <= 68000;
    let c = cs ? lookupRate(ipPkgTable, billableStandardG) : -1;
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    addMethod('fedex-ip',{name:'FedEx IP Package',sub:'1-3æ—¥/DDP/æœ€å¤§68kg/ä½“ç©Ã·5,000/ç‡ƒæ²¹è¾¼',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:!cs?'68kgè¶…é':''});
  }

  // ===== SpeedPAK DHL Express Envelope =====
  {
    const maxW = cc.dhlZone === 10 ? 300 : 300; // å…¨zone 0.3kg
    const cs = weightG <= maxW;
    let c = cs ? dhlEnvRate : -1;
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    addMethod('dhl',{name:'DHL Express Envelope',sub:'2-4æ—¥/DDP/æœ€å¤§300g/å®Ÿé‡é‡/ç‡ƒæ²¹è¾¼',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:!cs?'300gè¶…é':''});
  }

  // ===== SpeedPAK DHL Express Worldwide =====
  {
    const maxW = cc.dhlZone === 10 ? 70000 : 30000; // US=70kg, others=30kg
    const cs = billableStandardG <= maxW;
    let c = cs ? lookupRate(dhlTable, billableStandardG) : -1;
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    addMethod('dhl',{name:'DHL Express',sub:'2-4æ—¥/DDP/æœ€å¤§'+(maxW/1000)+'kg/ä½“ç©Ã·5,000/ç‡ƒæ²¹è¾¼',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:!cs?(maxW/1000)+'kgè¶…é':''});
  }

  // ===== æ—¥æœ¬éƒµä¾¿ï¼ˆå›½åˆ¥æ–™é‡‘ï¼‰ =====
  {
    const jpZone = cc.jpZone || 4;
    const jpOk = cc.jpOk !== false;
    const zoneName = jpZone === 3 ? 'ç¬¬3åœ°å¸¯' : 'ç¬¬4åœ°å¸¯';
    const eplTable = getEpacketLightTable(jpZone);
    const emsTable = getEmsTable(jpZone);
    {
      const cs = jpOk && weightG <= 2000;
      const c = cs ? lookupRate(eplTable, weightG) : (jpOk ? -1 : lookupRate(eplTable, Math.min(weightG,2000)));
      const reason = !jpOk ? 'å·®å‡ºä¸å¯ï¼ˆâ–³ï¼‰' : !cs ? '2kgè¶…é' : '';
      addMethod('jppost',{name:'eãƒ‘ã‚±ãƒƒãƒˆãƒ©ã‚¤ãƒˆ',sub:zoneName+'/è¿½è·¡ã‚ã‚Š/æœ€å¤§2kg/å®Ÿé‡é‡/âš ï¸ Economyç”¨Shipping Policyè¦ä½œæˆ',cost:c>0?c:-1,canSend:cs&&c>0,reason:reason});
    }
    {
      const cs = jpOk && weightG <= 30000;
      const c = cs ? lookupRate(emsTable, weightG) : (jpOk ? -1 : lookupRate(emsTable, Math.min(weightG,30000)));
      const reason = !jpOk ? 'å·®å‡ºä¸å¯ï¼ˆâ–³ï¼‰' : !cs ? '30kgè¶…é' : '';
      addMethod('jppost',{name:'EMS',sub:zoneName+'/æœ€é€Ÿ/æœ€å¤§30kg/å®Ÿé‡é‡',cost:c>0?c:-1,canSend:cs&&c>0,reason:reason});
    }
  }

  // Profit calculation
  let allMethods = [];
  groups.forEach(g => {
    g.methods.forEach(m => {
      if (m.cost > 0) {
        m.profit = Math.round(netReceived - purchase - m.cost);
        m.profitWithRefund = Math.round(m.profit + totalRefund);
        m.profitRate = purchase > 0 ? (m.profit / purchase * 100) : 0;
        m.isOk = m.canSend && m.profit >= 500 && m.profitRate >= 5;
      } else {
        m.profit = null; m.profitWithRefund = null; m.profitRate = 0; m.isOk = false;
      }
      allMethods.push(m);
    });
  });

  // Beståˆ¤å®š: FedEx/DHLã‚’å„ªå…ˆã€‚Economyã¯ãŠã¾ã‘ã€‚
  // FedEx/DHLå†…ã§åˆ©ç›ŠOKã®æœ€é«˜åˆ©ç›Šãƒ¡ã‚½ãƒƒãƒ‰ã‚’bestã€‚ãªã‘ã‚Œã°å…¨ä½“ã§æœ€é«˜åˆ©ç›Šã‚’bestã€‚
  const fedexDhlMethods = allMethods.filter(m => m._groupId === 'fedex' || m._groupId === 'fedex-ip' || m._groupId === 'dhl');
  let bestFD = null, bestFDProfit = -Infinity;
  fedexDhlMethods.forEach(m => {
    if (m.isOk && m.profit !== null && m.profit > bestFDProfit) { bestFDProfit = m.profit; bestFD = m; }
  });

  let bestProfit = -Infinity, bestRefund = -Infinity;
  allMethods.forEach(m => {
    if (!m.canSend) return; // ç™ºé€ä¸å¯ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚µãƒãƒªãƒ¼å¯¾è±¡å¤–
    if (m.profit !== null && m.profit > bestProfit) bestProfit = m.profit;
    if (m.profitWithRefund !== null && m.profitWithRefund > bestRefund) bestRefund = m.profitWithRefund;
  });

  function setSummaryVal(elId, value, cellId) {
    const el = document.getElementById(elId);
    const cell = document.getElementById(cellId);
    if (value === null || value === undefined) {
      el.textContent = '-';
      if (cell) { cell.style.background = ''; }
      return;
    }
    if (value < 0) {
      el.textContent = 'âš  Â¥' + fmt(value);
      el.style.color = 'var(--red)';
      if (cell) cell.style.background = 'var(--red-bg)';
    } else {
      el.textContent = 'Â¥' + fmt(value);
      el.style.color = '';
      if (cell) cell.style.background = '';
    }
  }

  if (bestFD) {
    allMethods.forEach(m => { m.isBest = (m === bestFD); });
    setSummaryVal('bestProfitYen', bestFD.profit, 'summaryProfit');
    setSummaryVal('bestProfitRefundYen', bestFD.profitWithRefund, 'summaryRefund');
    const rateEl = document.getElementById('bestProfitRate');
    rateEl.textContent = bestFD.profitRate.toFixed(1) + '%';
    rateEl.style.color = bestFD.profitRate < 0 ? 'var(--red)' : '';
  } else {
    let bestMethod = null;
    allMethods.forEach(m => { m.isBest = m.profit !== null && m.profit === bestProfit && m.isOk; if (m.isBest && !bestMethod) bestMethod = m; });
    setSummaryVal('bestProfitYen', bestProfit > -Infinity ? bestProfit : null, 'summaryProfit');
    setSummaryVal('bestProfitRefundYen', bestRefund > -Infinity ? bestRefund : null, 'summaryRefund');
    const rateEl = document.getElementById('bestProfitRate');
    rateEl.textContent = bestMethod ? bestMethod.profitRate.toFixed(1) + '%' : '-';
    rateEl.style.color = bestMethod && bestMethod.profitRate < 0 ? 'var(--red)' : '';
  }

  // Sort by profit (descending)
  groups.forEach(g => {
    g.methods.sort((a,b) => {
      const av = a.profit, bv = b.profit;
      if (av === null && bv === null) return 0;
      if (av === null) return 1;
      if (bv === null) return -1;
      return bv - av;
    });
  });

  // Render
  const container = document.getElementById('resultsContainer');
  container.innerHTML = '';

  groups.forEach(g => {
    const section = document.createElement('div');
    let sectionCls = 'group-section';
    if (g.id === 'fedex' || g.id === 'fedex-ip') sectionCls += ' grp-fedex';
    else if (g.id === 'dhl') sectionCls += ' grp-dhl';
    else if (g.id === 'speedpak') { sectionCls += ' grp-speedpak'; if (!cc.economy) sectionCls += ' collapsed'; }
    else if (g.id === 'jppost') sectionCls += ' grp-jppost';
    if (g.collapsed) sectionCls += ' collapsed';
    section.className = sectionCls;

    let headerExtra = '';
    const isCollapsed = g.collapsed || (g.id === 'speedpak' && !cc.economy);
    if (isCollapsed) {
      headerExtra = `<button class="group-toggle" onclick="this.closest('.group-section').classList.toggle('collapsed');this.textContent=this.closest('.group-section').classList.contains('collapsed')?'è©³ç´° â–¼':'é–‰ã˜ã‚‹ â–²'">è©³ç´° â–¼</button>`;
    }
    const noteHtml = g.note ? `<span class="g-note">â€” ${g.note}</span>` : '';
    section.innerHTML = `<div class="group-header ${g.cls}"><span class="g-icon">${g.icon}</span><span class="g-label">${g.label}</span>${noteHtml}<span class="g-tag">${g.tag}</span>${headerExtra}</div>`;

    // æ—¥æœ¬éƒµä¾¿ã®æ³¨è¨˜
    if (g.id === 'jppost') {
      const jpZone = cc.jpZone || 4;
      const note = document.createElement('div');
      note.className = 'group-note';
      note.style.cssText = 'font-size:.78rem;color:var(--text2);padding:4px 12px;margin-bottom:6px';
      note.textContent = 'ğŸ“® ' + (jpZone===3?'ç¬¬3åœ°å¸¯':'ç¬¬4åœ°å¸¯') + 'ï¼ˆ' + cc.name + 'ï¼‰â€” è‡ªåˆ†ã§éƒµä¾¿å±€ã‹ã‚‰ç™ºé€';
      section.appendChild(note);
    }

    const grid = document.createElement('div');
    grid.className = 'group-grid';

    g.methods.forEach(m => {
      const row = document.createElement('div');
      let cls = 'method-row';
      if (m.isBest) cls += ' best';
      else if (!m.canSend || (m.profit !== null && !m.isOk)) cls += ' ng';
      row.className = cls;

      let badge = '';
      if (!m.canSend) badge = '<span class="badge badge-na">ä¸å¯</span>';
      else if (m.isBest) badge = '<span class="badge badge-best">æœ€é«˜</span>';
      else if (m.isOk) badge = '<span class="badge badge-ok">OK</span>';
      else badge = '<span class="badge badge-ng">NG</span>';

      let right;
      if (m.cost > 0 && m.profit !== null) {
        const profitCls = m.profit < 0 ? 'val val-neg' : 'val val-profit';
        const refundCls = m.profitWithRefund < 0 ? 'val val-neg' : 'val val-refund';
        const profitTxt = m.profit < 0 ? 'âš  Â¥' + fmt(m.profit) : 'Â¥' + fmt(m.profit);
        const refundTxt = m.profitWithRefund < 0 ? 'âš  Â¥' + fmt(m.profitWithRefund) : 'Â¥' + fmt(m.profitWithRefund);
        right = `<div class="mr-right">
          <span class="lbl">é€æ–™</span><span class="val">Â¥${fmt(m.cost)}</span>
          <span class="lbl">åˆ©ç›Š</span><span class="${profitCls}">${profitTxt}</span>
          <span class="lbl">é‚„ä»˜è¾¼</span><span class="${refundCls}">${refundTxt}</span>
        </div>`;
      } else {
        right = `<div class="mr-na">${m.reason || 'ç™ºé€ä¸å¯'}</div>`;
      }

      row.innerHTML = `<div class="mr-left"><div class="mr-name">${m.name}${badge}</div><div class="mr-sub">${m.sub}</div></div>${right}`;
      grid.appendChild(row);
    });

    section.appendChild(grid);
    container.appendChild(section);
  });
}

// ========== Event Listeners ==========
document.querySelectorAll('input').forEach(el => {
  el.addEventListener('input', calculate);
});
document.getElementById('categoryNo').addEventListener('input', onCategoryNoInput);

// Initial setup
initCountrySelector();
onCategoryNoInput();
updateFeeDescription();
initFuelSurcharge();
calculate();
</script>
</body>
</html>
