<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>eBay„É™„Çµ„Éº„ÉÅ„ÉÑ„Éº„É´</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f5f7;--card:#fff;--border:#e0e0e0;
  --primary:#2563eb;--primary-light:#dbeafe;
  --green:#16a34a;--green-bg:#dcfce7;
  --red:#dc2626;--red-bg:#fee2e2;
  --text:#1e293b;--text2:#475569;--text3:#94a3b8;
  --sp:#f97316;--sp-bg:#fff7ed;--sp-border:#fdba74;
  --shadow:0 1px 3px rgba(0,0,0,.08);
  --shadow2:0 4px 6px rgba(0,0,0,.07);
}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Sans",sans-serif;background:var(--bg);color:var(--text);line-height:1.5;padding:10px 16px;margin:0 auto;max-width:1400px}
h1{font-size:1.3rem;text-align:center;padding:8px 0 2px;font-weight:700}
.subtitle{text-align:center;font-size:.82rem;color:var(--text3);margin-bottom:10px}
.card{background:var(--card);border-radius:10px;padding:12px 16px;margin-bottom:10px;box-shadow:var(--shadow)}
.card h2{font-size:.95rem;font-weight:700;margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--primary);color:var(--primary);display:flex;align-items:center;gap:6px}
.card h2 .icon{font-size:1rem}

/* ===== 2-column PC layout ===== */
.main-layout{display:grid;grid-template-columns:380px 1fr;gap:10px;align-items:start}

.field{display:flex;flex-direction:column;gap:2px}
.field label{font-size:.8rem;color:var(--text2);font-weight:600;white-space:nowrap}
.field input{border:1.5px solid var(--border);border-radius:6px;padding:6px 10px;font-size:.95rem;width:100%;transition:border-color .15s;background:#fafafa}
.field input:focus{outline:none;border-color:var(--primary);background:#fff;box-shadow:0 0 0 2px var(--primary-light)}
.field input.highlight{background:#fffbeb;border-color:#f59e0b}
.field .unit{font-size:.7rem;color:var(--text3)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.grid4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}

/* ===== Summary bar ‚Äî horizontal ===== */
.summary-row{display:flex;gap:8px;margin-bottom:8px}
.summary-cell{flex:1;padding:8px 10px;border-radius:6px;text-align:center;min-width:0}
.summary-cell .s-label{font-size:.72rem;color:var(--text2);white-space:nowrap}
.summary-cell .s-val{font-size:1.05rem;font-weight:700;font-family:"SF Mono",Consolas,monospace;white-space:nowrap}

.fee-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:.85rem}
.fee-row .fee-label{color:var(--text2)}
.fee-row .fee-val{font-weight:600;font-family:"SF Mono",Consolas,monospace}
.fee-total{border-top:1.5px solid var(--border);margin-top:4px;padding-top:5px;font-weight:700;font-size:.9rem}
.divider{border:none;border-top:1px dashed var(--border);margin:5px 0}

.toggle-btn{display:inline-flex;align-items:center;gap:4px;background:none;border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:.78rem;cursor:pointer;color:var(--text3);transition:all .15s}
.toggle-btn:hover{background:var(--primary-light);border-color:var(--primary);color:var(--primary)}
.toggle-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.settings-content{display:none;margin-top:8px}
.settings-content.show{display:block}
.note{font-size:.72rem;color:var(--text3);margin-top:5px;padding:5px 8px;background:#f8fafc;border-radius:6px;line-height:1.4}

/* ===== Group Section ===== */
.group-section{margin-bottom:12px}
.group-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:6px 12px;border-radius:6px;font-weight:700;font-size:.95rem}
.group-header .g-icon{font-size:1rem}
.group-header .g-label{white-space:nowrap}
.group-header .g-note{font-size:.78rem;font-weight:400;opacity:.7;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.group-header .g-tag{font-size:.72rem;padding:2px 8px;border-radius:99px;font-weight:600}
.group-speedpak{background:linear-gradient(135deg,#fff7ed,#ffedd5);color:#c2410c;border:1.5px solid var(--sp-border)}
.group-speedpak .g-tag{background:#c2410c;color:#fff}
.group-elogi{background:#f5f0ff;color:#6d28d9;border:1px solid #c4b5fd}
.group-elogi .g-tag{background:#7c3aed;color:#fff}
.group-dhl{background:#fefce8;color:#a16207;border:1px solid #fde68a}
.group-dhl .g-tag{background:#a16207;color:#fff}
.group-jppost{background:#f0fdf4;color:#15803d;border:1px solid #bbf7d0}
.group-jppost .g-tag{background:#15803d;color:#fff}
.group-elogi-blue{background:#eff6ff;color:#1d4ed8;border:1px solid #93c5fd}
.group-elogi-blue .g-tag{background:#2563eb;color:#fff}
.group-ups{background:#fef3c7;color:#7c2d12;border:1px solid #fbbf24}
.group-ups .g-tag{background:#92400e;color:#fff}

.group-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}

/* ===== Method Row ===== */
.method-row{display:grid;grid-template-columns:1fr auto;gap:0;border-radius:8px;padding:9px 12px;border:1.5px solid var(--border);background:var(--card);transition:all .15s;align-items:center}
.method-row.best{border-color:var(--green);background:var(--green-bg);box-shadow:var(--shadow2)}
.method-row.ng{opacity:.45;background:#f8fafc}
.method-row .mr-left{display:flex;flex-direction:column;gap:2px;min-width:0}
.method-row .mr-name{font-size:1rem;font-weight:700}
.method-row .mr-sub{font-size:.78rem;color:var(--text3);line-height:1.4}
.method-row .mr-right{display:grid;grid-template-columns:auto auto;gap:2px 10px;font-size:.95rem;text-align:right;white-space:nowrap}
.method-row .mr-right .lbl{color:var(--text2);text-align:left}
.method-row .mr-right .val{font-weight:700;font-family:"SF Mono",Consolas,monospace}
.method-row .mr-right .val-profit{color:var(--green)}
.method-row .mr-right .val-refund{color:var(--primary)}
.method-row .mr-right .val-neg{color:var(--red);background:var(--red-bg);border-radius:4px;padding:0 4px}
.method-row .mr-na{font-size:.88rem;color:var(--text3)}
.badge{font-size:.72rem;padding:2px 7px;border-radius:99px;font-weight:700;display:inline-block;vertical-align:middle;margin-left:4px}
.badge-ok{background:var(--green-bg);color:var(--green)}
.badge-ng{background:var(--red-bg);color:var(--red)}
.badge-best{background:var(--green);color:#fff}
.badge-na{background:#f1f5f9;color:var(--text3)}

.group-section.grp-fedex .method-row:not(.ng){border-color:#c4b5fd;background:#f5f0ff}
.group-section.grp-dhl .method-row:not(.ng){border-color:#fde68a;background:#fefce8}
.group-section.grp-elogi .method-row:not(.ng){border-color:#93c5fd;background:#eff6ff}
.group-section.grp-ups .method-row:not(.ng){border-color:#fbbf24;background:#fef3c7}
.group-section .method-row.best{border-color:var(--green);background:var(--green-bg);box-shadow:var(--shadow2)}

.group-section.collapsed .group-grid{display:none}
.group-toggle{font-size:.75rem;padding:3px 10px;border:1px solid var(--border);border-radius:5px;background:var(--card);cursor:pointer;color:var(--text3);margin-left:auto}
.group-toggle:hover{background:var(--primary-light);color:var(--primary);border-color:var(--primary)}
.group-unavail{background:#fef2f2;color:var(--red);border:1.5px solid #fca5a5}
.group-unavail .g-tag{background:var(--red);color:#fff}
.unavail-note{font-size:.78rem;color:var(--red);padding:4px 12px;margin-bottom:6px}
.group-section.grp-speedpak .method-row:not(.ng){border-color:var(--sp-border);background:var(--sp-bg)}
.group-section.grp-jppost .method-row:not(.ng){border-color:#bbf7d0;background:#f0fdf4}

.mode-bar{display:flex;gap:6px;margin-bottom:10px}
.mode-btn{flex:1;padding:6px 10px;border:1.5px solid var(--border);border-radius:6px;background:var(--card);cursor:pointer;font-size:.82rem;font-weight:600;color:var(--text3);text-align:center;transition:all .15s}
.mode-btn:hover{border-color:var(--primary);color:var(--primary)}
.mode-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.pricing-info{font-size:.78rem;color:var(--text2);padding:6px 8px;background:#f8fafc;border-radius:6px;margin-top:4px;line-height:1.5}
.pricing-info strong{color:var(--text);font-family:"SF Mono",Consolas,monospace}

/* ===== Shopping Search Bar ===== */
.shop-search-bar{background:var(--card);border-radius:8px;box-shadow:var(--shadow);padding:6px 12px;margin-bottom:10px}
.shop-search-top{display:flex;align-items:center;gap:8px}
.shop-search-top input[type="text"]{flex:1;border:1.5px solid var(--border);border-radius:6px;padding:5px 10px;font-size:.9rem;min-width:0}
.shop-search-top input[type="text"]:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px var(--primary-light)}
.shop-search-btn{font-size:.78rem;padding:5px 14px;border:1.5px solid var(--primary);border-radius:6px;background:var(--primary);color:#fff;cursor:pointer;font-weight:600;white-space:nowrap}
.shop-search-btn:hover{background:#1d4ed8}
.shop-sites{display:flex;flex-wrap:wrap;gap:2px 6px;margin-top:4px}
.shop-sites label{font-size:.72rem;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:2px;padding:1px 4px;border-radius:4px;transition:background .1s;white-space:nowrap;user-select:none}
.shop-sites label:hover{background:var(--primary-light)}
.shop-sites input[type="checkbox"]{width:12px;height:12px;margin:0;accent-color:var(--primary)}
.shop-toggle{font-size:.7rem;color:var(--text3);cursor:pointer;border:none;background:none;padding:0;text-decoration:underline}
.shop-toggle:hover{color:var(--primary)}

@media(max-width:900px){
  .main-layout{grid-template-columns:1fr}
  .group-grid{grid-template-columns:1fr}
}
@media(max-width:640px){
  body{padding:8px 10px}
  h1{font-size:1.1rem}
  .tool-bar{grid-template-columns:1fr !important}
  .tool-bar>*{text-align:center}
  .tool-bar .shop-sites{justify-content:center}
  .tool-bar div[style*="display:flex"]{justify-content:center}
  .card{padding:10px 12px}
  .grid4{grid-template-columns:1fr 1fr;gap:6px}
  .summary-row{flex-direction:column;gap:6px}
  .group-header{flex-wrap:wrap;font-size:.82rem;gap:4px 8px;justify-content:center;text-align:center}
  .group-header .g-label{white-space:normal}
  .group-header .g-note{width:100%;flex:none;text-align:center}
  .method-row{grid-template-columns:1fr;gap:6px;text-align:center}
  .method-row .mr-right{justify-content:center;justify-items:center;text-align:center;font-size:.88rem}
  .method-row .mr-left{align-items:center}
  .mode-bar{flex-direction:column;gap:4px}
  .unavail-note{text-align:center}
  .group-note{text-align:center}
}
</style>
</head>
<body>

<h1>eBay„É™„Çµ„Éº„ÉÅ„ÉÑ„Éº„É´</h1>

<div class="tool-bar" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">
  <!-- 1. „Ç≠„Éº„ÉØ„Éº„Éâ„Ç¨„ÉÅ„É£ -->
  <div style="background:var(--card);border-radius:8px;box-shadow:var(--shadow);padding:8px 12px;border-top:3px solid var(--primary)">
    <div style="font-size:.72rem;margin-bottom:4px"><span style="font-weight:700;color:var(--primary)">üé≤ „É©„É≥„ÉÄ„É†„Ç≠„Éº„ÉØ„Éº„ÉâÁîüÊàê</span> <span style="color:var(--text3)">‚Äî „Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÊäº„Åô„Å®„Ç≥„Éî„Éº„Åß„Åç„Åæ„Åô</span></div>
    <div id="kwResult" style="font-size:.95rem;font-weight:700;color:var(--primary);font-family:'SF Mono',Consolas,monospace;min-height:28px;line-height:28px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:6px">-</div>
    <div style="display:flex;align-items:center;gap:6px">
      <select id="kwCount" style="font-size:.75rem;padding:3px 6px;border:1px solid var(--border);border-radius:5px;background:#fafafa;color:var(--text2)">
        <option value="1">1Ë™û</option><option value="2" selected>2Ë™û</option><option value="3">3Ë™û</option><option value="5">5Ë™û</option>
      </select>
      <button onclick="rollKw()" style="font-size:.75rem;padding:4px 12px;border:1.5px solid var(--primary);border-radius:6px;background:var(--primary);color:#fff;cursor:pointer;font-weight:600;white-space:nowrap">„Ç¨„ÉÅ„É£</button>
    </div>
  </div>
  <!-- 2. eBayË≤©Â£≤Â±•Ê≠¥ -->
  <a href="https://www.ebay.com/sh/research?marketplace=EBAY-US&tabName=SOLD" target="_blank" style="background:var(--card);border-radius:8px;box-shadow:var(--shadow);padding:8px 12px;border-top:3px solid var(--green);text-decoration:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;transition:all .15s" onmouseover="this.style.background='var(--green-bg)'" onmouseout="this.style.background='var(--card)'">
    <div style="font-size:.72rem;font-weight:700;color:var(--green)">üìä eBayË≤©Â£≤Â±•Ê≠¥</div>
    <div style="font-size:1.3rem;font-weight:700">Research Products</div>
    <div style="font-size:.68rem;color:var(--text3)">90Êó•Èñì„Åß2ÂÄã‰ª•‰∏äÂ£≤„Çå„Å¶„ÅÑ„ÇãÂïÜÂìÅ„Çí„Éî„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó</div>
  </a>
  <!-- 3. „Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞‰∏ÄÊã¨Ê§úÁ¥¢ -->
  <div style="background:var(--card);border-radius:8px;box-shadow:var(--shadow);padding:8px 12px;border-top:3px solid var(--sp)">
    <div style="font-size:.72rem;margin-bottom:4px"><span style="font-weight:700;color:var(--sp)">üîç „Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞‰∏ÄÊã¨Ê§úÁ¥¢</span> <span style="color:var(--text3)">‚Äî ÂõΩÂÜÖ„ÅÆÊúÄÂÆâÂÄ§„ÇíÊ§úÁ¥¢</span></div>
    <div style="display:flex;gap:4px;margin-bottom:4px">
      <input type="text" id="shopQuery" placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ..." style="flex:1;border:1.5px solid var(--border);border-radius:6px;padding:4px 8px;font-size:.82rem;min-width:0" onkeydown="if(event.key==='Enter')shopSearch()">
      <button class="shop-search-btn" onclick="shopSearch()" style="font-size:.72rem;padding:4px 10px">Ê§úÁ¥¢</button>
    </div>
    <div style="display:flex;align-items:center;gap:4px;margin-bottom:2px">
      <button class="shop-toggle" onclick="toggleShopAll(true)">ÂÖ®ÈÅ∏Êäû</button>
      <button class="shop-toggle" onclick="toggleShopAll(false)">ÂÖ®Ëß£Èô§</button>
    </div>
    <div class="shop-sites" id="shopSites"></div>
  </div>
</div>

<div class="main-layout">
<!-- ===== LEFT COLUMN ===== -->
<div class="left-col">

  <!-- ÂïÜÂìÅÊÉÖÂ†± -->
  <div class="card">
    <h2><span class="icon">üì¶</span> ÂïÜÂìÅÊÉÖÂ†±</h2>
    <div class="mode-bar">
      <button class="mode-btn active" id="modeUs" onclick="setPricingMode('us')">üá∫üá∏ „Ç¢„É°„É™„Ç´Âêë„Åë</button>
      <button class="mode-btn" id="modeOther" onclick="setPricingMode('other')">üåç „Ç¢„É°„É™„Ç´‰ª•Â§ñ</button>
    </div>
    <div class="grid2" style="margin-bottom:6px">
      <div class="field">
        <label>‰ªïÂÖ•È°ç <span class="unit">(¬•„ÉªÁ®éËæº)</span></label>
        <input type="number" id="purchasePrice" value="0" class="highlight" min="0" step="100">
      </div>
      <div class="field">
        <label>Â£≤ÂÄ§ <span class="unit">($)‚ÄªÁ´∂ÂêàÊúÄÂÆâÂÄ§</span></label>
        <input type="number" id="sellingPrice" value="0" class="highlight" min="0" step="0.01">
      </div>
    </div>
    <!-- üá∫üá∏ „Ç¢„É°„É™„Ç´Âêë„Åë: Á´∂ÂêàÈÄÅÊñô -->
    <div id="usSection" style="margin-bottom:6px">
      <div class="field" style="width:130px;margin-bottom:6px">
        <label>ÈÄÅÊñô <span class="unit">($)‚ÄªÁ´∂ÂêàÈÄÅÊñô</span></label>
        <input type="number" id="compShipping" value="0" class="highlight" min="0" step="0.01">
      </div>
      <div id="usPricingInfo" style="display:flex;gap:6px">
        <div style="flex:1;padding:8px 10px;border-radius:6px;background:var(--primary-light);border:1.5px solid var(--primary);text-align:center">
          <div style="font-size:.68rem;color:var(--primary);font-weight:600">üìã eBayÂá∫ÂìÅ‰æ°Ê†º</div>
          <div id="listPrice" style="font-size:1.1rem;font-weight:700;color:var(--primary);font-family:'SF Mono',Consolas,monospace">-</div>
        </div>
        <div style="flex:1;padding:8px 10px;border-radius:6px;background:#fef3c7;border:1.5px solid #f59e0b;text-align:center">
          <div style="font-size:.68rem;color:#b45309;font-weight:600">üìã eBayÂá∫ÂìÅÈÄÅÊñô</div>
          <div id="listShipping" style="font-size:1.1rem;font-weight:700;color:#b45309;font-family:'SF Mono',Consolas,monospace">-</div>
        </div>
      </div>
    </div>
    <!-- üåç „Ç¢„É°„É™„Ç´‰ª•Â§ñ: Èñ¢Á®éÁéá -->
    <div id="otherSection" style="margin-bottom:6px;display:none">
      <div style="display:flex;gap:8px;align-items:flex-end">
        <div class="field" style="width:160px">
          <label>Á±≥ÂõΩÂêë„ÅëÈñ¢Á®éÁéá <span class="unit">(%)</span></label>
          <input type="number" id="usTariffRate" value="20" class="highlight" min="0" step="1">
        </div>
        <div class="pricing-info" id="otherPricingInfo" style="flex:1">üá∫üá∏Á±≥ÂõΩÂêë„ÅëÈÄÅÊñô: <strong>-</strong></div>
      </div>
    </div>
    <div class="grid4">
      <div class="field">
        <label>ÂÆüÈáçÈáè <span class="unit">(kg)</span></label>
        <input type="number" id="weight" value="0.5" class="highlight" min="0" step="0.01">
      </div>
      <div class="field">
        <label>Á∏¶ <span class="unit">(cm)</span></label>
        <input type="number" id="length" value="10" class="highlight" min="0" step="0.1">
      </div>
      <div class="field">
        <label>Ê®™ <span class="unit">(cm)</span></label>
        <input type="number" id="width" value="10" class="highlight" min="0" step="0.1">
      </div>
      <div class="field">
        <label>È´ò„Åï <span class="unit">(cm)</span></label>
        <input type="number" id="height" value="5" class="highlight" min="0" step="0.1">
      </div>
    </div>
    <div style="display:flex;gap:12px;margin-top:4px;font-size:.75rem;color:var(--text3)">
      <span>‰ΩìÁ©çÈáçÈáè(√∑5000): <strong id="volWeight" style="color:var(--text2)">-</strong></span>
      <span>Economy(√∑8000): <strong id="volWeightEco" style="color:var(--text2)">-</strong></span>
    </div>
  </div>

  <!-- ÊâãÊï∞ÊñôË®≠ÂÆö -->
  <div class="card">
    <h2><span class="icon">‚öôÔ∏è</span> ÊâãÊï∞Êñô„Éª„É¨„Éº„Éà</h2>
    <div style="display:flex;gap:8px;align-items:flex-end;margin-bottom:5px">
      <div class="field" style="width:110px">
        <label>„Ç´„ÉÜ„Ç¥„É™No.</label>
        <input type="number" id="categoryNo" value="20561" placeholder="‰æã: 20561" class="highlight">
      </div>
      <div class="field" style="flex:1;min-width:0">
        <label>„Ç´„ÉÜ„Ç¥„É™Âêç</label>
        <div id="categoryName" style="font-size:.82rem;padding:6px 0;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">-</div>
      </div>
    </div>
    <div style="font-size:.75rem;color:var(--text2);margin-bottom:6px;padding:4px 8px;background:#f8fafc;border-radius:4px" id="feeDescription">-</div>
    <div style="display:flex;align-items:flex-end;gap:8px;margin-bottom:5px">
      <div class="field" style="width:140px">
        <label>ÁÇ∫Êõø„É¨„Éº„Éà <span class="unit">(¬•/$)</span></label>
        <input type="number" id="exchangeRate" value="153.5115" class="highlight" step="0.0001">
      </div>
      <button onclick="fetchRate()" style="font-size:.72rem;padding:5px 10px;border:1px solid var(--border);border-radius:5px;background:#fafafa;cursor:pointer;color:var(--text3);white-space:nowrap;margin-bottom:0">Ëá™ÂãïÂèñÂæó</button>
    </div>
    <div style="display:flex;align-items:flex-end;gap:8px;margin-bottom:5px">
      <div class="field" style="width:140px">
        <label>ÁáÉÊ≤π„Çµ„Éº„ÉÅ„É£„Éº„Ç∏ <span class="unit">(%)</span></label>
        <input type="number" id="fuelSurcharge" value="28.75" class="highlight" step="0.25">
      </div>
      <button onclick="fetchFuelSurcharge(false)" style="font-size:.72rem;padding:5px 10px;border:1px solid var(--border);border-radius:5px;background:#fafafa;cursor:pointer;color:var(--text3);white-space:nowrap;margin-bottom:0">FedExÂèñÂæó</button>
      <div style="font-size:.68rem;color:var(--text3);margin-bottom:4px;line-height:1.3">FedEx/DHLÂÖ±ÈÄö„ÉªÂü∫Êú¨ÈÄÅÊñô„Å´Âä†ÁÆó<br><span id="fuelStatus" style="color:var(--text3)">-</span></div>
    </div>
    <button class="toggle-btn" id="settingsToggle" onclick="toggleSettings()">Ë©≥Á¥∞Ë®≠ÂÆö ‚ñº</button>
    <div class="settings-content" id="settingsContent">
      <div class="grid2" style="gap:6px;margin-top:6px">
        <div class="field"><label>eBayÊâãÊï∞Êñô (%)</label><input type="number" id="ebayFeeRate" value="12.7" step="0.01"></div>
        <div class="field"><label>ÈñæÂÄ§ ($)</label><input type="number" id="feeThreshold" value="2500" step="100"></div>
        <div class="field"><label>eBayÊâãÊï∞Êñô2 (%)</label><input type="number" id="ebayFeeRate2" value="2.35" step="0.01"></div>
        <div class="field"><label>1Ê≥®Êñá„ÅÇ„Åü„Çä ($)</label><input type="number" id="perOrderFee" value="0.40" step="0.01"></div>
        <div class="field"><label>Promoted (%)</label><input type="number" id="promotedRate" value="2" step="0.1" class="highlight"></div>
        <div class="field"><label>Êµ∑Â§ñÊâãÊï∞Êñô (%)</label><input type="number" id="intlFeeRate" value="0.95" step="0.01" class="highlight"></div>
        <div class="field"><label>Payoneer (%)</label><input type="number" id="payoneerRate" value="2" step="0.1" class="highlight"></div>
        <div class="field"><label>Ê∂àË≤ªÁ®éÁéá (%)</label><input type="number" id="taxRate" value="10" step="1"></div>
      </div>
    </div>
  </div>

  <!-- Âà©Áõä„Çµ„Éû„É™„Éº -->
  <div class="card">
    <h2><span class="icon">üí∞</span> Âà©Áõä„Çµ„Éû„É™„Éº</h2>
    <div class="summary-row">
      <div class="summary-cell" id="summaryProfit" style="background:var(--green-bg)">
        <div class="s-label">Êé®Â•®‰æø Âà©Áõä</div>
        <div class="s-val" style="color:var(--green)" id="bestProfitYen">-</div>
      </div>
      <div class="summary-cell" id="summaryRefund" style="background:#dbeafe">
        <div class="s-label">ÈÇÑ‰ªòËæº„Åø</div>
        <div class="s-val" style="color:var(--primary)" id="bestProfitRefundYen">-</div>
      </div>
      <div class="summary-cell" style="background:#f0fdf4">
        <div class="s-label">Âà©ÁõäÁéá</div>
        <div class="s-val" style="color:var(--green)" id="bestProfitRate">-</div>
      </div>
    </div>
    <button class="toggle-btn" id="feeToggle" onclick="toggleFeeDetail()">ÂÜÖË®≥ ‚ñº</button>
    <div class="settings-content" id="feeDetailContent">
      <div class="fee-row"><span class="fee-label">Â£≤‰∏ä</span><span class="fee-val" id="revenueYen">-</span></div>
      <div class="fee-row"><span class="fee-label">ÊâãÊï∞ÊñôË®à</span><span class="fee-val" style="color:var(--red)" id="totalFeesYen">-</span></div>
      <hr class="divider">
      <div class="fee-row"><span class="fee-label">eBay FVF</span><span class="fee-val" id="feeEbay">-</span></div>
      <div class="fee-row"><span class="fee-label">Promoted</span><span class="fee-val" id="feePromoted">-</span></div>
      <div class="fee-row"><span class="fee-label">Êµ∑Â§ñÊâãÊï∞Êñô</span><span class="fee-val" id="feeIntl">-</span></div>
      <hr class="divider">
      <div class="fee-row"><span class="fee-label">Payoneer</span><span class="fee-val" id="feePayoneer">-</span></div>
      <div class="fee-row fee-total"><span class="fee-label">ÂêàË®à</span><span class="fee-val" id="feeTotalUsd">-</span></div>
      <div class="note">‚ÄªeBayÁ≥ªÊâãÊï∞Êñô„Å´„ÅØÊ∂àË≤ªÁ®é10%Ëæº„ÄÇPayoneer„ÅØÁÇ∫ÊõøÂ§âÊèõÊôÇÊéßÈô§„ÄÇ</div>
    </div>
  </div>

</div><!-- /left-col -->

<!-- ===== RIGHT COLUMN ===== -->
<div class="right-col">
  <div class="card" style="padding:12px 16px">
    <h2><span class="icon">üöö</span> ÈÖçÈÄÅÊñπÊ≥ïÂà• Âà©ÁõäÊØîËºÉ</h2>
    <div style="margin-bottom:8px">
      <select id="destCountry" style="border:1.5px solid var(--border);border-radius:6px;padding:6px 10px;font-size:.95rem;width:100%;background:#fafafa;cursor:pointer;font-weight:600" onchange="onCountryChange()">
      </select>
    </div>
    <div id="resultsContainer"></div>
  </div>
  <div class="note" style="text-align:center;margin-top:3px" id="footerNote">
    ‚ÄªÈÄÅÊñô„ÅØSpeedPAKÂÖ¨ÂºèPDFÊ∫ñÊã†„ÄÇFedEx/DHL„ÅØÁáÉÊ≤π„Çµ„Éº„ÉÅ„É£„Éº„Ç∏Âä†ÁÆóÊ∏à„ÄÇÂà©ÁõäOKÂà§ÂÆöÔºö‚â•¬•500 „Åã„Å§ ‚â•5%„ÄÇÈÇÑ‰ªòÔºù‰ªïÂÖ•Á®éÔºãeBayÊâãÊï∞ÊñôÁ®é„ÄÇ
  </div>
</div><!-- /right-col -->

</div><!-- /main-layout -->

<script src="ebay_categories.js"></script>
<script>
// ========== Shopping Site Bulk Search ==========
const SHOP_SITES = [
  { id:'amazon_jp', name:'Amazon JP',    url:'https://www.amazon.co.jp/s?k={q}', checked:true },
  { id:'rakuten',   name:'Ê•ΩÂ§©',          url:'https://search.rakuten.co.jp/search/mall/{q}/', checked:true },
  { id:'yahoo_shop',name:'Yahoo„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞', url:'https://shopping.yahoo.co.jp/search?p={q}', checked:false },
  { id:'mercari',   name:'„É°„É´„Ç´„É™',       url:'https://jp.mercari.com/search?keyword={q}', checked:true },
  { id:'yahoo_auc', name:'„É§„Éï„Ç™„ÇØ',       url:'https://auctions.yahoo.co.jp/search/search?p={q}', checked:true },
  { id:'paypay',    name:'PayPay„Éï„É™„Éû',   url:'https://paypayfleamarket.yahoo.co.jp/search/{q}', checked:false },
  { id:'rakuma',    name:'„É©„ÇØ„Éû',         url:'https://fril.jp/search/{q}', checked:false },
  { id:'kakaku',    name:'‰æ°Ê†º.com',      url:'https://kakaku.com/search_results/{q}/', checked:false },
  { id:'yodobashi', name:'„É®„Éâ„Éê„Ç∑',       url:'https://www.yodobashi.com/?word={q}', checked:false },
  { id:'surugaya',  name:'ÈßøÊ≤≥Â±ã',        url:'https://www.suruga-ya.jp/search?category=&search_word={q}', checked:false },
  { id:'google',    name:'Google',       url:'https://www.google.com/search?q={q}', checked:false },
  { id:'amazon_us', name:'Amazon US',    url:'https://www.amazon.com/s?k={q}', checked:false },
  { id:'ebay',      name:'eBay',         url:'https://www.ebay.com/sch/i.html?_nkw={q}', checked:true },
  { id:'aliexpress',name:'AliExpress',   url:'https://www.aliexpress.com/wholesale?SearchText={q}', checked:false },
];

function initShopSites() {
  const container = document.getElementById('shopSites');
  const saved = JSON.parse(localStorage.getItem('shop_sites_checked') || 'null');
  SHOP_SITES.forEach(s => {
    const checked = saved ? (saved[s.id] !== undefined ? saved[s.id] : s.checked) : s.checked;
    const lbl = document.createElement('label');
    lbl.innerHTML = `<input type="checkbox" data-shop="${s.id}" ${checked?'checked':''} onchange="saveShopChecks()"> ${s.name}`;
    container.appendChild(lbl);
  });
}

function saveShopChecks() {
  const obj = {};
  document.querySelectorAll('#shopSites input[type="checkbox"]').forEach(cb => {
    obj[cb.dataset.shop] = cb.checked;
  });
  localStorage.setItem('shop_sites_checked', JSON.stringify(obj));
}

function toggleShopAll(on) {
  document.querySelectorAll('#shopSites input[type="checkbox"]').forEach(cb => { cb.checked = on; });
  saveShopChecks();
}

function shopSearch() {
  const q = document.getElementById('shopQuery').value.trim();
  if (!q) { alert('„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
  const encoded = encodeURIComponent(q);
  let opened = 0;
  document.querySelectorAll('#shopSites input[type="checkbox"]:checked').forEach(cb => {
    const site = SHOP_SITES.find(s => s.id === cb.dataset.shop);
    if (site) { window.open(site.url.replace('{q}', encoded), '_blank'); opened++; }
  });
  if (opened === 0) alert('Ê§úÁ¥¢„Åô„Çã„Çµ„Ç§„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
}

initShopSites();

// ========== Keyword Gacha ==========
const KW_LIST = [
  // Electronics & Gadgets
  'vintage','camera','lens','turntable','amplifier','headphones','speaker','microphone','radio','cassette',
  'walkman','gameboy','nintendo','sega','playstation','controller','console','cartridge','adapter','charger',
  'transformer','oscilloscope','multimeter','soldering','transistor','vacuum tube','calculator','typewriter',
  // Watches & Jewelry
  'watch','seiko','casio','citizen','orient','chronograph','automatic','mechanical','quartz','pocket watch',
  'pendant','necklace','bracelet','ring','brooch','earring','cufflinks','pearl','silver','gold',
  // Collectibles
  'figurine','statue','doll','plush','stuffed','miniature','diecast','model kit','gundam','bandai',
  'pokemon','card','trading card','stamp','coin','medal','badge','pin','patch','sticker',
  'poster','print','lithograph','painting','calligraphy','scroll','woodblock','ukiyo-e',
  // Fashion & Accessories
  'kimono','obi','haori','geta','tabi','tenugui','furoshiki','bag','wallet','purse',
  'backpack','tote','leather','silk','denim','vintage jacket','sneakers','boots','hat','scarf',
  // Kitchen & Home
  'knife','chef knife','santoku','whetstone','ceramic','teapot','tea cup','matcha','cast iron','tetsubin',
  'bento','chopsticks','lacquerware','bamboo','cutting board','rice cooker','thermos','zojirushi',
  // Tools & Instruments
  'chisel','plane','saw','hammer','wrench','pliers','drill','clamp','file','sandpaper',
  'guitar','violin','flute','harmonica','ukulele','keyboard','synthesizer','drum','cymbal','pedal',
  // Anime & Manga
  'manga','anime','cosplay','wig','figure','nendoroid','scale figure','art book','soundtrack','cel',
  // Automotive & Bicycle
  'carburetor','exhaust','headlight','mirror','emblem','wheel','tire','brake','suspension','seat',
  'bicycle','shimano','derailleur','pedal','saddle','handlebar','frame','fork','chain','spoke',
  // Stationery & Art
  'fountain pen','ink','notebook','sketchbook','watercolor','acrylic','oil paint','brush','easel','canvas',
  'washi tape','origami','calligraphy pen','seal','stamp pad',
  // Outdoor & Sports
  'fishing reel','fishing rod','lure','tackle','tent','sleeping bag','lantern','compass','binoculars',
  'golf club','baseball glove','kendo','judo','karate','bokken','shinai',
  // Misc
  'antique','retro','rare','limited edition','unused','mint condition','NOS','OEM','genuine','original',
  'handmade','crafted','custom','restoration','repair','parts','accessories','set','lot','bulk',
  'japanese','japan','tokyo','osaka','kyoto',
];

function rollKw() {
  const count = parseInt(document.getElementById('kwCount').value) || 2;
  const shuffled = [...KW_LIST].sort(() => Math.random() - 0.5);
  const picked = shuffled.slice(0, count);
  document.getElementById('kwResult').innerHTML = picked.map(w => '<span style="background:var(--primary-light);padding:2px 8px;border-radius:4px;margin-right:4px;display:inline-block;cursor:pointer" onclick="copyOneKw(this)" title="„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç≥„Éî„Éº">' + w + '</span>').join('');
}

function copyOneKw(span) {
  const text = span.textContent.trim();
  if (!text) return;
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.select();
  document.execCommand('copy');
  document.body.removeChild(ta);
  const orig = span.textContent;
  const origBg = span.style.background;
  span.textContent = '‚úì copy';
  span.style.background = 'var(--green-bg)';
  setTimeout(() => { span.textContent = orig; span.style.background = origBg; }, 800);
}

rollKw(); // ÂàùÊúüË°®Á§∫

// ========== Category Lookup ==========

function onCategoryNoInput() {
  const no = parseInt(document.getElementById('categoryNo').value);
  const nameEl = document.getElementById('categoryName');
  if (typeof ebayCategoryMap !== 'undefined' && ebayCategoryMap[no]) {
    const cat = ebayCategoryMap[no]; // [name, rate1%, threshold, rate2%]
    nameEl.textContent = cat[0] || '(ÂêçÁß∞„Å™„Åó)';
    // Auto-set fee rates from category data
    document.getElementById('ebayFeeRate').value = cat[1];
    document.getElementById('feeThreshold').value = cat[2];
    document.getElementById('ebayFeeRate2').value = cat[3];
  } else {
    nameEl.textContent = no ? '‰∏çÊòé„Å™„Ç´„ÉÜ„Ç¥„É™' : '-';
  }
  updateFeeDescription();
  calculate();
}

function updateFeeDescription() {
  const r1 = getVal('ebayFeeRate');
  const th = getVal('feeThreshold');
  const r2 = getVal('ebayFeeRate2');
  const po = getVal('perOrderFee');
  document.getElementById('feeDescription').textContent =
    'FVF: $' + th.toLocaleString() + '„Åæ„Åß ' + r1 + '% ‚Üí ÊÆã„Çä ' + r2 + '% + $' + po + '/Ê≥®Êñá';
}

// ========== Shipping Rate Tables (USÂêë„Åë„Éª2025Âπ¥ÁâàPDFÊ∫ñÊã†) ==========

// --- SpeedPAK Economy Á±≥ÂõΩÊú¨Âúü48Â∑û (√∑8,000 ÂÆπÁ©çÈáçÈáè, ÊúÄÂ§ß$1,300, ÊúÄÂ§ß25kg) ---
const speedpakEconomyRates = [
  [100,1227],[200,1367],[300,1581],[400,1778],[500,2060],
  [600,2222],[700,2321],[800,2703],[900,2820],[1000,3020],
  [1100,3136],[1200,3250],[1300,3366],[1400,3704],[1500,3816],
  [1600,3935],[1700,4046],[1800,4165],[1900,5056],[2000,5245],
  [2500,5582],[3000,6333],[3500,6958],[4000,7704],
  [4500,9135],[5000,11733],[5500,12500],[6000,13335],
  [6500,14160],[7000,15209],[7500,16058],[8000,16893],
  [8500,17562],[9000,18152],[9500,19106],[10000,19639],
  [10500,20276],[11000,20864],[11500,21565],[12000,22199],
  [12500,22887],[13000,23466],[13500,24054],[14000,24869],
  [14500,25200],[15000,25988],[15500,26656],[16000,28149],
  [16500,28775],[17000,29495],[17500,30196],[18000,30902],
  [18500,31478],[19000,32204],[19500,32936],[20000,33947],
  [20500,34655],[21000,35426],[21500,36145],[22000,36859],
  [22500,37602],[23000,38516],[23500,39084],[24000,39678],
  [24500,40374],[25000,40955]
];

// --- SpeedPAK FedEx FICP (International Connect Plus) Zone F=USE/CA (√∑5,000, ÊúÄÂ§ß68kg, DDP) ---
const speedpakFicpRates = [
  [500,2115],[1000,2599],[1500,2840],[2000,3108],[2500,3383],
  [3000,3540],[3500,3593],[4000,4022],[4500,4451],[5000,4718],
  [5500,5043],[6000,5366],[6500,5735],[7000,6184],[7500,6683],
  [8000,6871],[8500,7060],[9000,7249],[9500,8865],[10000,9089],
  [10500,9346],[11000,9602],[11500,9861],[12000,10116],
  [12500,11439],[13000,11723],[13500,12006],[14000,12289],
  [14500,12573],[15000,12857],[15500,13140],[16000,14631],
  [16500,14940],[17000,15249],[17500,15559],[18000,15867],
  [18500,16177],[19000,16485],[19500,16794],[20000,17104],
  [21000,20625],[22000,21657],[23000,22689],[24000,23721],
  [25000,24754],[26000,25787],[27000,26819],[28000,27852],
  [29000,28885],[30000,29916],
  [31000,30950],[32000,31983],[33000,34201],[34000,35237],
  [35000,36274],[36000,37310],[37000,38346],[38000,39383],
  [39000,40419],[40000,41455],[41000,42492],[42000,43528],
  [43000,44565],[44000,45601],[45000,45624],
  [46000,45624],[47000,45624],[48000,45792],[49000,46746],
  [50000,47700],[51000,48654],[52000,49608],[53000,50562],
  [54000,51516],[55000,52470],[56000,53424],[57000,54378],
  [58000,55332],[59000,56286],[60000,57240],
  [61000,58194],[62000,59148],[63000,60102],[64000,61056],
  [65000,62010],[66000,62964],[67000,63918],[68000,64872]
];

// --- SpeedPAK FedEx IP Envelope (Zone F=USE/CA, ÂÆüÈáçÈáè, ÊúÄÂ§ß0.5kg) ---
const speedpakIpEnvelopeRates = [
  [500,2091]
];

// --- SpeedPAK FedEx IP Pak (Zone F=USE/CA, ÂÆüÈáçÈáè, ÊúÄÂ§ß2.5kg) ---
const speedpakIpPakRates = [
  [500,2427],[1000,2894],[1500,3286],[2000,3686],[2500,4091]
];

// --- SpeedPAK FedEx IP Package (Zone F=USE/CA, √∑5,000, ÊúÄÂ§ß68kg, DDP) ---
const speedpakIpPackageRates = [
  [500,2369],[1000,2655],[1500,2850],[2000,2859],[2500,3186],
  [3000,3755],[3500,3757],[4000,4252],[4500,4746],[5000,5241],
  [5500,6429],[6000,6587],[6500,6746],[7000,6905],[7500,7065],
  [8000,7224],[8500,7383],[9000,7541],[9500,9590],[10000,9788],
  [10500,9967],[11000,10146],[11500,10325],[12000,10505],
  [12500,12411],[13000,12620],[13500,12828],[14000,13035],
  [14500,13243],[15000,13451],[15500,13659],[16000,15914],
  [16500,16153],[17000,16391],[17500,16631],[18000,16870],
  [18500,17107],[19000,17346],[19500,17585],[20000,17823],
  [21000,22085],[22000,23136],[23000,24187],[24000,25240],
  [25000,26291],[26000,27343],[27000,28394],[28000,29446],
  [29000,30498],[30000,31550],
  [31000,32601],[32000,33652],[33000,34689],[34000,35740],
  [35000,36791],[36000,37842],[37000,38893],[38000,39945],
  [39000,40996],[40000,42047],[41000,43098],[42000,44149],
  [43000,45200],[44000,46252],[45000,46252],
  [46000,46794],[47000,47811],[48000,48828],[49000,49846],
  [50000,50863],[51000,51880],[52000,52898],[53000,53915],
  [54000,54932],[55000,55949],[56000,56967],[57000,57984],
  [58000,59001],[59000,60018],[60000,61036],
  [61000,62053],[62000,63070],[63000,64087],[64000,65105],
  [65000,66122],[66000,67139],[67000,68156],[68000,69174]
];

// --- SpeedPAK DHL Express Envelope (Zone 10=US, ÂÆüÈáçÈáè, ÊúÄÂ§ß0.3kg) ---
const speedpakDhlEnvelopeRates = [
  [300,2454]
];

// --- SpeedPAK DHL Express Worldwide (Zone 10=US, √∑5,000, ÊúÄÂ§ß154kg) ---
const speedpakDhlRates = [
  [500,2454],[1000,2780],[1500,2898],[2000,3045],[2500,3404],
  [3000,3761],[3500,4203],[4000,4568],[4500,4934],[5000,5300],
  [5500,5665],[6000,6029],[6500,6444],[7000,6948],[7500,7450],
  [8000,7954],[8500,8456],[9000,8958],[9500,9463],[10000,9966],
  [10500,10469],[11000,10972],[11500,11475],[12000,11978],
  [12500,12481],[13000,12986],[13500,13487],[14000,13991],
  [14500,14494],[15000,14998],[15500,15500],[16000,16004],
  [16500,16508],[17000,17011],[17500,17515],[18000,18018],
  [18500,18521],[19000,19024],[19500,19528],[20000,20031],
  [21000,21039],[22000,22045],[23000,23052],[24000,24059],
  [25000,25065],[26000,26073],[27000,27078],[28000,28085],
  [29000,29082],[30000,30089],
  [31000,31093],[32000,32096],[33000,33099],[34000,34102],
  [35000,35104],[36000,36108],[37000,37111],[38000,38114],
  [39000,39117],[40000,40120],[41000,41123],[42000,42127],
  [43000,43129],[44000,44133],[45000,45135],[46000,46139],
  [47000,47142],[48000,48145],[49000,49148],[50000,50151],
  [51000,51154],[52000,52158],[53000,53160],[54000,54163],
  [55000,55166],[56000,56169],[57000,57173],[58000,58175],
  [59000,59179],[60000,60181],
  [61000,61185],[62000,62188],[63000,63191],[64000,64194],
  [65000,65197],[66000,66200],[67000,67204],[68000,68206],
  [69000,69210],[70000,70213]
];

// ========== Multi-Country Rate Tables ==========

// --- FedEx FICP Zone M (DE/GB/FR/IT/ES) --- ‚ÄªExcel„ÇΩ„Éº„Çπ
const ficpZoneM = [
  [500,2010],[1000,2346],[1500,2731],[2000,3068],[2500,3408],[3000,3433],[3500,3490],[4000,3792],[4500,4097],[5000,4400],
  [5500,5120],[6000,5331],[6500,5543],[7000,5753],[7500,5964],[8000,6176],[8500,6386],[9000,6597],[9500,8010],[10000,8258],
  [10500,8426],[11000,8596],[11500,8768],[12000,8937],[12500,10498],[13000,10694],[13500,10890],[14000,11085],[14500,11281],[15000,11477],
  [15500,11672],[16000,13471],[16500,13692],[17000,13914],[17500,14136],[18000,14357],[18500,14580],[19000,14804],[19500,15024],[20000,15246],
  [21000,20659],[22000,21708],[23000,22758],[24000,23807],[25000,24856],[26000,25906],[27000,26956],[28000,28006],[29000,29055],[30000,30105],
  [31000,31154],[32000,32203],[33000,35122],[34000,36187],[35000,37251],[36000,38315],[37000,39380],[38000,40444],[39000,41508],[40000,42573],
  [41000,43637],[42000,44701],[43000,45766],[44000,46830],[45000,46830],[46000,46830],[47000,46830],[48000,46830],[49000,46830],[50000,47137],
  [51000,48080],[52000,49023],[53000,49966],[54000,50908],[55000,51851],[56000,52794],[57000,53737],[58000,54679],[59000,55622],[60000,56565],
  [61000,57508],[62000,58450],[63000,59393],[64000,60336],[65000,61279],[66000,62221],[67000,63164],[68000,64107]
];

// --- FedEx FICP Zone U (AU/NZ) --- ‚ÄªExcel„ÇΩ„Éº„Çπ
const ficpZoneU = [
  [500,2737],[1000,3014],[1500,3024],[2000,3339],[2500,3656],[3000,3950],[3500,4242],[4000,4535],[4500,4828],[5000,5124],
  [5500,5337],[6000,5637],[6500,5937],[7000,6235],[7500,6536],[8000,6836],[8500,7135],[9000,7435],[9500,8438],[10000,8764],
  [10500,9028],[11000,9292],[11500,9555],[12000,9819],[12500,21180],[13000,21733],[13500,22287],[14000,22840],[14500,23394],[15000,23948],
  [15500,24500],[16000,25053],[16500,25607],[17000,26160],[17500,26715],[18000,27267],[18500,27820],[19000,28375],[19500,28928],[20000,29484],
  [21000,31945],[22000,33577],[23000,35208],[24000,36837],[25000,38470],[26000,40101],[27000,41732],[28000,43363],[29000,44994],[30000,46626],
  [31000,48256],[32000,49888],[33000,49944],[34000,50185],[35000,51661],[36000,53137],[37000,54613],[38000,56089],[39000,57565],[40000,59041],
  [41000,60517],[42000,61993],[43000,63469],[44000,64945],[45000,64945],[46000,64945],[47000,64945],[48000,64945],[49000,64945],[50000,64945],
  [51000,66208],[52000,67507],[53000,68805],[54000,70103],[55000,71401],[56000,72699],[57000,73998],[58000,75296],[59000,76594],[60000,77892],
  [61000,79190],[62000,80489],[63000,81787],[64000,83085],[65000,84383],[66000,85681],[67000,86980],[68000,88278]
];

// --- FedEx IP Package Zone M (DE/GB) --- ‚ÄªExcel„ÇΩ„Éº„Çπ
const ipPackageZoneM = [
  [500,2413],[1000,2634],[1500,2839],[2000,2841],[2500,3238],[3000,3644],[3500,3647],[4000,4012],[4500,4377],[5000,4741],
  [5500,5564],[6000,5751],[6500,5939],[7000,6126],[7500,6313],[8000,6500],[8500,6687],[9000,6874],[9500,8617],[10000,8846],
  [10500,8973],[11000,9102],[11500,9231],[12000,9358],[12500,11293],[13000,11447],[13500,11599],[14000,11751],[14500,11905],[15000,12057],
  [15500,12210],[16000,14532],[16500,14711],[17000,14891],[17500,15071],[18000,15250],[18500,15430],[19000,15609],[19500,15788],[20000,15877],
  [21000,22085],[22000,23136],[23000,24188],[24000,25240],[25000,26291],[26000,27343],[27000,28395],[28000,29446],[29000,30498],[30000,31550],
  [31000,32601],[32000,33653],[33000,34715],[34000,35767],[35000,36819],[36000,37871],[37000,38923],[38000,39975],[39000,41027],[40000,42079],
  [41000,43131],[42000,44183],[43000,45235],[44000,46287],[45000,46288],[46000,46607],[47000,47620],[48000,48633],[49000,49646],[50000,50659],
  [51000,51673],[52000,52686],[53000,53699],[54000,54712],[55000,55725],[56000,56738],[57000,57752],[58000,58765],[59000,59778],[60000,60791],
  [61000,61804],[62000,62818],[63000,63831],[64000,64844],[65000,65857],[66000,66870],[67000,67884],[68000,68897]
];

// --- FedEx IP Envelope Zone M (DE/GB) --- ‚ÄªExcel„ÇΩ„Éº„Çπ
const ipEnvelopeZoneM = 2091;

// --- FedEx IP Pak Zone M (DE/GB) --- ‚ÄªExcel„ÇΩ„Éº„Çπ
const ipPakZoneM = [
  [500,2197],[1000,2417],[1500,3011],[2000,3640],[2500,4241]
];

// --- FedEx IP Package Zone U (AU/NZ) --- ‚ÄªExcel„ÇΩ„Éº„Çπ
const ipPackageZoneU = [
  [500,4202],[1000,4923],[1500,5814],[2000,6525],[2500,7393],[3000,8247],[3500,8604],[4000,9410],[4500,10217],[5000,11023],
  [5500,12722],[6000,13295],[6500,13868],[7000,14440],[7500,15014],[8000,15587],[8500,16159],[9000,16731],[9500,20767],[10000,21455],
  [10500,21873],[11000,22291],[11500,22710],[12000,23129],[12500,25549],[13000,26003],[13500,26458],[14000,26911],[14500,27365],[15000,27818],
  [15500,28272],[16000,28754],[16500,29207],[17000,29663],[17500,30116],[18000,30570],[18500,31025],[19000,31479],[19500,31934],[20000,32388],
  [21000,32886],[22000,32886],[23000,33237],[24000,34681],[25000,36126],[26000,37572],[27000,39017],[28000,40461],[29000,41907],[30000,43352],
  [31000,44796],[32000,46242],[33000,47696],[34000,49142],[35000,50587],[36000,52032],[37000,53478],[38000,54923],[39000,56368],[40000,57814],
  [41000,59259],[42000,60704],[43000,62150],[44000,63595],[45000,63627],[46000,63627],[47000,63627],[48000,63627],[49000,63627],[50000,63627],
  [51000,63627],[52000,63627],[53000,63682],[54000,64884],[55000,66085],[56000,67287],[57000,68489],[58000,69690],[59000,70892],[60000,72093],
  [61000,73295],[62000,74496],[63000,75698],[64000,76899],[65000,78101],[66000,79303],[67000,80504],[68000,81706]
];

// --- FedEx IP Envelope Zone U (AU/NZ) --- ‚ÄªExcel„ÇΩ„Éº„Çπ
const ipEnvelopeZoneU = 2820;

// --- FedEx IP Pak Zone U (AU/NZ) --- ‚ÄªExcel„ÇΩ„Éº„Çπ
const ipPakZoneU = [
  [500,3592],[1000,4343],[1500,5057],[2000,5786],[2500,6558]
];

// --- DHL Zone 2 (France) ---
const dhlZone2 = [
  [500,2073],[1000,2073],[1500,2468],[2000,2905],[2500,3195],[3000,3340],[3500,3555],[4000,3898],[4500,4053],[5000,4208],
  [5500,4829],[6000,5454],[6500,6077],[7000,6701],[7500,7324],[8000,7949],[8500,8571],[9000,9195],[9500,9819],[10000,10443],
  [10500,11145],[11000,11847],[11500,12547],[12000,13249],[12500,13950],[13000,14651],[13500,15321],[14000,16024],[14500,16725],[15000,17426],
  [15500,18128],[16000,18830],[16500,19532],[17000,20234],[17500,20935],[18000,21637],[18500,22339],[19000,23041],[19500,23743],[20000,24445],
  [21000,25790],[22000,27136],[23000,28480],[24000,29824],[25000,31169],[26000,32513],[27000,33858],[28000,35203],[29000,36535],[30000,37891]
];

// --- DHL Zone 3 (Germany/Italy/NL/CH) ---
const dhlZone3 = [
  [500,2073],[1000,2073],[1500,2468],[2000,2905],[2500,3195],[3000,3340],[3500,3555],[4000,3898],[4500,4053],[5000,4208],
  [5500,4829],[6000,5454],[6500,6077],[7000,6701],[7500,7324],[8000,7949],[8500,8571],[9000,9195],[9500,9819],[10000,10443],
  [10500,11145],[11000,11847],[11500,12547],[12000,13249],[12500,13950],[13000,14651],[13500,15321],[14000,16024],[14500,16725],[15000,17426],
  [15500,18128],[16000,18830],[16500,19532],[17000,20234],[17500,20935],[18000,21637],[18500,22339],[19000,23041],[19500,23743],[20000,24445],
  [21000,25790],[22000,27136],[23000,28480],[24000,29824],[25000,31169],[26000,32513],[27000,33858],[28000,35203],[29000,36535],[30000,37891]
];

// --- DHL Zone 4 (UK/Spain) ---
const dhlZone4 = [
  [500,2285],[1000,2827],[1500,3073],[2000,3378],[2500,3393],[3000,4215],[3500,5139],[4000,6291],[4500,7173],[5000,8055],
  [5500,8954],[6000,9854],[6500,10753],[7000,11651],[7500,12551],[8000,14108],[8500,15053],[9000,15995],[9500,16941],[10000,17883],
  [10500,18741],[11000,19600],[11500,20457],[12000,21315],[12500,22172],[13000,23028],[13500,23862],[14000,24721],[14500,25579],[15000,26437],
  [15500,27294],[16000,28152],[16500,29009],[17000,29865],[17500,30722],[18000,31579],[18500,32437],[19000,33294],[19500,34151],[20000,35007],
  [21000,36724],[22000,38439],[23000,40155],[24000,41872],[25000,43588],[26000,45305],[27000,47021],[28000,48736],[29000,50462],[30000,52174]
];

// --- DHL Zone 5 (Canada) ---
const dhlZone5 = [
  [500,2342],[1000,2653],[1500,2767],[2000,2907],[2500,3250],[3000,3589],[3500,4012],[4000,4360],[4500,4711],[5000,5059],
  [5500,5407],[6000,5755],[6500,6174],[7000,6650],[7500,7123],[8000,7599],[8500,8073],[9000,8550],[9500,9031],[10000,9510],
  [10500,9991],[11000,10471],[11500,10951],[12000,11432],[12500,11912],[13000,12393],[13500,12872],[14000,13353],[14500,13833],[15000,14315],
  [15500,14795],[16000,15276],[16500,15757],[17000,16237],[17500,16719],[18000,17199],[18500,17680],[19000,18161],[19500,18642],[20000,19123],
  [21000,20083],[22000,21043],[23000,22003],[24000,22962],[25000,23922],[26000,24881],[27000,25839],[28000,26799],[29000,27749],[30000,28717]
];

// --- DHL Zone 11 (Australia) ---
const dhlZone11 = [
  [500,2419],[1000,2419],[1500,2419],[2000,2427],[2500,4155],[3000,4173],[3500,4297],[4000,4314],[4500,4325],[5000,4330],
  [5500,5730],[6000,7218],[6500,8708],[7000,10197],[7500,11685],[8000,13176],[8500,14665],[9000,16152],[9500,17643],[10000,19132],
  [10500,19489],[11000,19846],[11500,20203],[12000,20560],[12500,20918],[13000,21276],[13500,21632],[14000,21991],[14500,22348],[15000,22705],
  [15500,23062],[16000,23418],[16500,23775],[17000,24131],[17500,24488],[18000,24844],[18500,25200],[19000,25557],[19500,25914],[20000,26271],
  [21000,27319],[22000,28368],[23000,29417],[24000,30466],[25000,31517],[26000,32566],[27000,33616],[28000,34665],[29000,35712],[30000,36752]
];

// --- DHL Envelope per zone (max 0.3kg) ---
const dhlEnvelopeRates = { 2:2111, 3:2111, 4:2439, 5:2342, 10:2454, 11:2439 };

// --- Economy UK (max 25kg, real weight ‚â§ 15kg, 7-10Êó•, ¬£135‰ª•‰∏ã) ---
const economyUK = [
  [100,938],[200,1073],[300,1244],[400,1430],[500,1571],[600,1703],[700,1851],[800,1968],[900,2121],[1000,2240],
  [1100,2411],[1200,2552],[1300,2690],[1400,2811],[1500,2947],[1600,3068],[1700,3234],[1800,3357],[1900,3497],[2000,3620],
  [2500,4402],[3000,5095],[3500,5760],[4000,6412],[4500,7079],[5000,7810],[5500,8484],[6000,9142],[6500,9815],[7000,10475],
  [7500,11149],[8000,11809],[8500,12483],[9000,13141],[9500,13815],[10000,14474],[10500,15148],[11000,15807],[11500,16482],[12000,17140],
  [12500,17814],[13000,18472],[13500,19147],[14000,19806],[14500,20696],[15000,21362],[15500,22043],[16000,22710],[16500,23392],[17000,24058],
  [17500,24739],[18000,25404],[18500,26086],[19000,26752],[19500,27434],[20000,28100],[20500,28783],[21000,29448],[21500,30129],[22000,30794],
  [22500,33796],[23000,34512],[23500,35245],[24000,35960],[24500,36693],[25000,37410]
];

// --- Economy Germany (max 25kg, 7-11Êó•, ‚Ç¨150‰ª•‰∏ã) ---
const economyDE = [
  [100,1336],[200,1460],[300,1589],[400,1634],[500,1769],[600,1863],[700,1978],[800,2178],[900,2273],[1000,2273],
  [1100,2387],[1200,2609],[1300,2609],[1400,2609],[1500,2919],[1600,3313],[1700,3313],[1800,3617],[1900,3621],[2000,4092],
  [2500,4618],[3000,5092],[3500,6088],[4000,6563],[4500,7049],[5000,7524],[5500,8540],[6000,9014],[6500,9500],[7000,10442],
  [7500,10929],[8000,11405],[8500,12358],[9000,12832],[9500,13318],[10000,13805],[10500,14841],[11000,15316],[11500,15802],[12000,16743],
  [12500,17231],[13000,17716],[13500,18659],[14000,19134],[14500,19621],[15000,20107],[15500,21183],[16000,21670],[16500,22143],[17000,23086],
  [17500,23573],[18000,24060],[18500,25001],[19000,25488],[19500,25963],[20000,26451],[20500,27555],[21000,28042],[21500,28517],[22000,29471],
  [22500,29946],[23000,30433],[23500,30453],[24000,30472],[24500,30492],[25000,30511]
];

// --- Economy Australia (real weight ‚â§ 22kg, billable ‚â§ 22.5kg, 6-12Êó•, AUD1000‰ª•‰∏ã) ---
const economyAU = [
  [100,1142],[200,1322],[300,1508],[400,1539],[500,1630],[600,1812],[700,1847],[800,1997],[900,2068],[1000,2068],
  [1100,2139],[1200,2174],[1300,2209],[1400,2462],[1500,2462],[1600,2462],[1700,2462],[1800,2724],[1900,3153],[2000,3153],
  [2500,3153],[3000,3507],[3500,4015],[4000,4369],[4500,4547],[5000,5290],[5500,5466],[6000,5820],[6500,5997],[7000,6977],
  [7500,7155],[8000,7509],[8500,7687],[9000,8041],[9500,8219],[10000,8573],[10500,8749],[11000,9104],[11500,9281],[12000,9636],
  [12500,9813],[13000,10167],[13500,10344],[14000,10700],[14500,10877],[15000,11230],[15500,11409],[16000,11762],[16500,11940],[17000,13581],
  [17500,13758],[18000,14112],[18500,14290],[19000,14644],[19500,14821],[20000,15176],[20500,15176],[21000,15176],[21500,15176],[22000,15431],
  [22500,15768]
];

// ========== Country Configuration ==========
const COUNTRIES = [
  { id:'us', name:'üá∫üá∏ „Ç¢„É°„É™„Ç´', fedexZone:'F', dhlZone:10, jpZone:4, jpOk:false, elogiZone:'E', upsZone:5, economy:true, ecoTable:speedpakEconomyRates, ecoMaxKg:25, ecoMaxVal:'$1,300', ecoDays:'8-12Êó•',
    ecoSizeCheck:(L,W,H,g)=>{ const d=[L,W,H].sort((a,b)=>b-a); return d[0]<=66 && (d[0]+2*(d[1]+d[2]))<=274; },
    ecoSurcharge:(L,W,H,vol)=>(Math.max(L,W,H)>55.88||vol>55000?2475:0)+245 },
  { id:'uk', name:'üá¨üáß „Ç§„ÇÆ„É™„Çπ', fedexZone:'M', dhlZone:4, jpZone:3, jpOk:true, elogiZone:'H', upsZone:6, economy:true, ecoTable:economyUK, ecoMaxKg:25, ecoRealMaxKg:15, ecoMaxVal:'¬£135', ecoDays:'7-10Êó•',
    ecoSizeCheck:(L,W,H,g)=>{ const d=[L,W,H].sort((a,b)=>b-a); return d[0]<=120 && (d[0]+2*(d[1]+d[2]))<=225; },
    ecoSurcharge:()=>0 },
  { id:'de', name:'üá©üá™ „Éâ„Ç§„ÉÑ', fedexZone:'M', dhlZone:3, jpZone:3, jpOk:true, elogiZone:'H', upsZone:6, economy:true, ecoTable:economyDE, ecoMaxKg:25, ecoMaxVal:'‚Ç¨150', ecoDays:'7-11Êó•',
    ecoSizeCheck:(L,W,H,g)=>{ const d=[L,W,H].sort((a,b)=>b-a); return d[0]<=110 && d[1]<=50 && d[2]<=50; },
    ecoSurcharge:()=>0 },
  { id:'au', name:'üá¶üá∫ „Ç™„Éº„Çπ„Éà„É©„É™„Ç¢', fedexZone:'U', dhlZone:11, jpZone:3, jpOk:true, elogiZone:'U', upsZone:'au', economy:true, ecoTable:economyAU, ecoMaxKg:22.5, ecoRealMaxKg:22, ecoMaxVal:'AUD1,000', ecoDays:'6-12Êó•',
    ecoSizeCheck:(L,W,H,g)=>{ const d=[L,W,H].sort((a,b)=>b-a); return d[0]<=105 && (d[0]*d[1]*d[2])<=180000; },
    ecoSurcharge:()=>0 },
  { id:'fr', name:'üá´üá∑ „Éï„É©„É≥„Çπ', fedexZone:'M', dhlZone:2, jpZone:3, jpOk:true, elogiZone:'H', upsZone:6, economy:false },
  { id:'ca', name:'üá®üá¶ „Ç´„Éä„ÉÄ', fedexZone:'F', dhlZone:5, jpZone:3, jpOk:true, elogiZone:'F', upsZone:5, economy:false },
  { id:'it', name:'üáÆüáπ „Ç§„Çø„É™„Ç¢', fedexZone:'M', dhlZone:3, jpZone:3, jpOk:true, elogiZone:'H', upsZone:6, economy:false },
  { id:'es', name:'üá™üá∏ „Çπ„Éö„Ç§„É≥', fedexZone:'M', dhlZone:4, jpZone:3, jpOk:true, elogiZone:'H', upsZone:6, economy:false },
];

function getFicpTable(zone) { return zone==='M'?ficpZoneM:zone==='U'?ficpZoneU:speedpakFicpRates; }
function getIpPackageTable(zone) { return zone==='M'?ipPackageZoneM:zone==='U'?ipPackageZoneU:speedpakIpPackageRates; }
function getDhlTable(z) { return z===2?dhlZone2:z===3?dhlZone3:z===4?dhlZone4:z===5?dhlZone5:z===11?dhlZone11:speedpakDhlRates; }
function getDhlEnvelopeRate(z) { return dhlEnvelopeRates[z]||2454; }
function getEpacketLightTable(jpZone) { return jpZone===3?epacketLightZone3:epacketLightZone4; }
function getEmsTable(jpZone) { return jpZone===3?emsZone3:emsZone4; }

// --- Êó•Êú¨ÈÉµ‰æø e„Éë„Ç±„ÉÉ„Éà„É©„Ç§„Éà (ÂÆüÈáçÈáè, ÊúÄÂ§ß2kg) ---
// Á¨¨3Âú∞Â∏Ø: „Ç™„Çª„Ç¢„Éã„Ç¢„ÉªÂåóÁ±≥(Á±≥ÂõΩÈô§„Åè)„Éª‰∏≠ËøëÊù±„Éª„É®„Éº„É≠„ÉÉ„Éë (UK/DE/FR/CA/AU/IT/ES)
const epacketLightZone3 = [
  [100,880],[200,1060],[300,1240],[400,1420],[500,1600],
  [600,1780],[700,1960],[800,2140],[900,2320],[1000,2500],
  [1100,2680],[1200,2860],[1300,3040],[1400,3220],[1500,3400],
  [1600,3580],[1700,3760],[1800,3940],[1900,4120],[2000,4300]
];
// Á¨¨4Âú∞Â∏Ø: „Ç¢„É°„É™„Ç´(„Ç∞„Ç¢„É†Á≠âÊµ∑Â§ñÈ†òÂúüÂê´„ÇÄ)
const epacketLightZone4 = [
  [100,1200],[200,1410],[300,1620],[400,1830],[500,2040],
  [600,2250],[700,2460],[800,2670],[900,2880],[1000,3090],
  [1100,3300],[1200,3510],[1300,3720],[1400,3930],[1500,4140],
  [1600,4350],[1700,4560],[1800,4770],[1900,4980],[2000,5190]
];

// --- Êó•Êú¨ÈÉµ‰æø EMS (ÂÆüÈáçÈáè, ÊúÄÂ§ß30kg) ---
// Á¨¨3Âú∞Â∏Ø
const emsZone3 = [
  [500,3150],[600,3400],[700,3650],[800,3900],[900,4150],
  [1000,4400],[1250,5000],[1500,5550],[1750,6150],[2000,6700],
  [2500,7750],[3000,8800],[3500,9850],[4000,10900],[4500,11950],
  [5000,13000],[5500,14050],[6000,15100],[7000,17200],[8000,19300],
  [9000,21400],[10000,23500],[11000,25600],[12000,27700],[13000,29800],
  [14000,31900],[15000,34000],[16000,36100],[17000,38200],[18000,40300],
  [19000,42400],[20000,44500],[21000,46600],[22000,48700],[23000,50800],
  [24000,52900],[25000,55000],[26000,57100],[27000,59200],[28000,61300],
  [29000,63400],[30000,65500]
];
// Á¨¨4Âú∞Â∏Ø
const emsZone4 = [
  [500,3900],[600,4180],[700,4460],[800,4740],[900,5020],
  [1000,5300],[1250,5990],[1500,6600],[1750,7290],[2000,7900],
  [2500,9100],[3000,10300],[3500,11500],[4000,12700],[4500,13900],
  [5000,15100],[5500,16300],[6000,17500],[7000,19900],[8000,22300],
  [9000,24700],[10000,27100],[11000,29500],[12000,31900],[13000,34300],
  [14000,36700],[15000,39100],[16000,41500],[17000,43900],[18000,46300],
  [19000,48700],[20000,51100],[21000,53500],[22000,55900],[23000,58300],
  [24000,60700],[25000,63100],[26000,65500],[27000,67900],[28000,70300],
  [29000,72700],[30000,75100]
];

// ========== eLogi Rate Tables (US=Column E, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ==========

// --- eLogi FICP US (ÊúÄÂ§ß99kg, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiFicpUS = [
  [500,3000],[1000,3400],[1500,3500],[2000,3900],[2500,4200],
  [3000,4900],[3500,4900],[4000,5500],[4500,6100],[5000,6700],
  [5500,8100],[6000,8400],[6500,8600],[7000,8900],[7500,9100],
  [8000,9400],[8500,9600],[9000,9900],[9500,12100],[10000,12400],
  [10500,12800],[11000,13100],[11500,13400],[12000,13700],
  [12500,15700],[13000,16100],[13500,16400],[14000,16800],
  [14500,17200],[15000,17500],[15500,17900],[16000,20100],
  [16500,20500],[17000,21000],[17500,21400],[18000,21800],
  [18500,22200],[19000,22600],[19500,23000],[20000,23400],
  [20500,23800],[21000,26400],[21500,27100],[22000,27700],
  [22500,28400],[23000,29100],[23500,29700],[24000,30400],
  [24500,31100],[25000,31700],[25500,32400],[26000,33100],
  [26500,33700],[27000,34400],[27500,35100],[28000,35700],
  [28500,36400],[29000,37100],[29500,37700],[30000,38400],
  [30500,39100],[31000,39700],[31500,40400],[32000,41100],[32500,41700]
];
// Per-kg tiers: 33-44:¬•1,303/kg, 45-70:¬•1,176/kg, 71-99:¬•1,158/kg
const elogiFicpUSPerKg = [[44,1303],[70,1176],[99,1158]];

// --- eLogi IP Package US (ÊúÄÂ§ß99kg, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiIpPackageUS = [
  [500,3300],[1000,3100],[1500,3500],[2000,3900],[2500,4400],
  [3000,4500],[3500,5200],[4000,5800],[4500,6500],[5000,7200],
  [5500,8800],[6000,9000],[6500,9200],[7000,9400],[7500,9600],
  [8000,9800],[8500,10100],[9000,10300],[9500,10500],[10000,10700],
  [10500,13700],[11000,13900],[11500,14100],[12000,14400],
  [12500,14600],[13000,14900],[13500,15100],[14000,15300],
  [14500,15600],[15000,15800],[15500,16100],[16000,16300],
  [16500,16600],[17000,16800],[17500,17000],[18000,17300],
  [18500,17500],[19000,17800],[19500,18000],[20000,18200],
  [20500,18500]
];
// Per-kg tiers: 21-44:¬•1,342/kg, 45-70:¬•1,271/kg, 71-99:¬•1,257/kg
const elogiIpPackageUSPerKg = [[44,1342],[70,1271],[99,1257]];

// --- eLogi IP Envelope US (ÊúÄÂ§ß0.5kg, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiIpEnvelopeUS = 2900;

// --- eLogi IP Pak US (ÊúÄÂ§ß2.5kg, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiIpPakUS = [
  [500,3300],[1000,4000],[1500,4500],[2000,5000],[2500,5600]
];

// --- eLogi FICP Zone F (CA/ÂåóÁ±≥, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiFicpF = [
  [500,3100],[1000,3500],[1500,3600],[2000,3900],[2500,4200],[3000,4900],[3500,5000],[4000,5600],[4500,6200],[5000,6800],
  [5500,8200],[6000,8500],[6500,8800],[7000,9000],[7500,9300],[8000,9500],[8500,9800],[9000,10100],[9500,12300],[10000,12600],
  [10500,13000],[11000,13300],[11500,13700],[12000,14000],[12500,15800],[13000,16200],[13500,16600],[14000,17000],[14500,17400],[15000,17800],
  [15500,18200],[16000,20300],[16500,20700],[17000,21100],[17500,21500],[18000,22000],[18500,22400],[19000,22800],[19500,23200],[20000,23700],
  [20500,24100],[21000,28600],[21500,29300],[22000,30000],[22500,30700],[23000,31400],[23500,32100],[24000,32900],[24500,33600],[25000,34300],
  [25500,35000],[26000,35700],[26500,36400],[27000,37100],[27500,37900],[28000,38600],[28500,39300],[29000,40000],[29500,40700],[30000,41400],
  [30500,42100],[31000,42800],[31500,43600],[32000,44300],[32500,45000]
];
const elogiFicpFPerKg = [[44,1405],[70,1294],[99,1271]];

// --- eLogi FICP Zone H („É®„Éº„É≠„ÉÉ„Éë UK/DE/FR/IT/ES, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiFicpH = [
  [500,3300],[1000,3700],[1500,4000],[2000,4500],[2500,5000],[3000,5600],[3500,5700],[4000,6200],[4500,6700],[5000,7200],
  [5500,8700],[6000,9000],[6500,9400],[7000,9700],[7500,10100],[8000,10400],[8500,10800],[9000,11200],[9500,13600],[10000,14000],
  [10500,14300],[11000,14600],[11500,14800],[12000,15100],[12500,17800],[13000,18100],[13500,18400],[14000,18700],[14500,19100],[15000,19400],
  [15500,19700],[16000,22800],[16500,23200],[17000,23600],[17500,24000],[18000,24300],[18500,24700],[19000,25100],[19500,25500],[20000,25900],
  [20500,26200],[21000,29300],[21500,30000],[22000,30800],[22500,31500],[23000,32300],[23500,33000],[24000,33700],[24500,34500],[25000,35200],
  [25500,36000],[26000,36700],[26500,37500],[27000,38200],[27500,38900],[28000,39700],[28500,40400],[29000,41200],[29500,41900],[30000,42700],
  [30500,43400],[31000,44100],[31500,44900],[32000,45600],[32500,46400]
];
const elogiFicpHPerKg = [[44,1443],[70,1278],[99,1270]];

// --- eLogi FICP Zone U (AU, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiFicpU = [
  [500,4000],[1000,4400],[1500,4400],[2000,4900],[2500,5400],[3000,5800],[3500,6200],[4000,6600],[4500,7100],[5000,7500],
  [5500,7800],[6000,8200],[6500,8700],[7000,9100],[7500,9600],[8000,10000],[8500,10400],[9000,10900],[9500,12200],[10000,12700],
  [10500,13100],[11000,13500],[11500,13800],[12000,14200],[12500,30900],[13000,31700],[13500,32500],[14000,33300],[14500,34100],[15000,34900],
  [15500,35700],[16000,36500],[16500,37300],[17000,38100],[17500,38900],[18000,39700],[18500,40500],[19000,41300],[19500,42100],[20000,43000],
  [20500,43800],[21000,41800],[21500,42800],[22000,43900],[22500,45000],[23000,46000],[23500,47100],[24000,48200],[24500,49200],[25000,50300],
  [25500,51300],[26000,52400],[26500,53500],[27000,54500],[27500,55600],[28000,56700],[28500,57700],[29000,58800],[29500,59900],[30000,60900],
  [30500,62000],[31000,63100],[31500,64100],[32000,65200],[32500,66300]
];
const elogiFicpUPerKg = [[44,1907],[70,1677],[99,1664]];

// --- eLogi IP Package Zone F (CA/ÂåóÁ±≥, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiIpPackageF = [
  [500,3300],[1000,3100],[1500,3500],[2000,4000],[2500,4400],[3000,4500],[3500,5200],[4000,5900],[4500,6600],[5000,7300],
  [5500,8900],[6000,9100],[6500,9300],[7000,9600],[7500,9800],[8000,10000],[8500,10200],[9000,10400],[9500,10700],[10000,10900],
  [10500,13800],[11000,14100],[11500,14300],[12000,14600],[12500,14800],[13000,15100],[13500,15300],[14000,15600],[14500,15800],[15000,16100],
  [15500,16300],[16000,16600],[16500,16800],[17000,17100],[17500,17300],[18000,17500],[18500,17800],[19000,18000],[19500,18300],[20000,18500],[20500,18800]
];
const elogiIpPackageFPerKg = [[44,1454],[70,1400],[99,1382]];

// --- eLogi IP Package Zone H („É®„Éº„É≠„ÉÉ„Éë, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiIpPackageH = [
  [500,3500],[1000,3300],[1500,4000],[2000,4600],[2500,5300],[3000,5400],[3500,5900],[4000,6500],[4500,7100],[5000,7700],
  [5500,9400],[6000,9700],[6500,10000],[7000,10300],[7500,10700],[8000,11000],[8500,11300],[9000,11600],[9500,11900],[10000,12200],
  [10500,15200],[11000,15400],[11500,15600],[12000,15800],[12500,16100],[13000,16300],[13500,16500],[14000,16700],[14500,16900],[15000,17100],
  [15500,17400],[16000,17600],[16500,17800],[17000,18000],[17500,18200],[18000,18400],[18500,18700],[19000,18900],[19500,19100],[20000,19200],[20500,19200]
];
const elogiIpPackageHPerKg = [[44,1488],[70,1393],[99,1378]];

// --- eLogi IP Package Zone U (AU, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiIpPackageU = [
  [500,6200],[1000,7100],[1500,8400],[2000,9600],[2500,10900],[3000,11500],[3500,12700],[4000,13900],[4500,15000],[5000,16200],
  [5500,18700],[6000,19600],[6500,20400],[7000,21200],[7500,22100],[8000,22900],[8500,23800],[9000,24600],[9500,25500],[10000,26300],
  [10500,32300],[11000,32900],[11500,33500],[12000,34100],[12500,34800],[13000,35400],[13500,36000],[14000,36600],[14500,37200],[15000,37800],
  [15500,38500],[16000,39100],[16500,39700],[17000,40300],[17500,40900],[18000,41500],[18500,42200],[19000,42800],[19500,43400],[20000,44000],[20500,44600]
];
const elogiIpPackageUPerKg = [[44,2126],[70,1756],[99,1737]];

// --- eLogi IP Envelope per zone („Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiIpEnvelopeF = 2900;
const elogiIpEnvelopeH = 3000;
const elogiIpEnvelopeU = 4200;

// --- eLogi IP Pak Zone F/H/U („Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiIpPakF = [[500,3400],[1000,4000],[1500,4600],[2000,5100],[2500,5700]];
const elogiIpPakH = [[500,2900],[1000,3600],[1500,4500],[2000,5500],[2500,6400]];
const elogiIpPakU = [[500,5300],[1000,6400],[1500,7500],[2000,8500],[2500,9700]];

// --- eLogi UPS Express Saver US (Zone 5, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiUpsUS = [
  [500,3600],[1000,4000],[1500,4100],[2000,4700],[2500,5200],[3000,5800],[3500,6500],[4000,7100],[4500,7600],[5000,8100],
  [5500,9800],[6000,10100],[6500,10500],[7000,10800],[7500,11200],[8000,11400],[8500,11600],[9000,11900],[9500,12200],[10000,12500],
  [10500,12700],[11000,13000],[11500,13200],[12000,13400],[12500,13600],[13000,13800],[13500,14100],[14000,14300],[14500,14500],[15000,14900],
  [15500,15100],[16000,15300],[16500,15600],[17000,15800],[17500,16000],[18000,16300],[18500,16500],[19000,16700],[19500,16900],[20000,17300]
];
const elogiUpsUSPerKg = [[54,1267],[70,1258],[99,1188]];

// --- eLogi UPS Express Saver AU („Ç¢„Ç∏„Ç¢Â§™Âπ≥Ê¥ãÁâπÂà•ÊñôÈáë, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiUpsAU = [
  [500,2400],[1000,2500],[1500,2600],[2000,2900],[2500,3600],[3000,4300],[3500,5000],[4000,5700],[4500,6300],[5000,7000],
  [5500,7700],[6000,8400],[6500,9100],[7000,9800],[7500,10400],[8000,11100],[8500,11800],[9000,12500],[9500,13200],[10000,13900],
  [10500,14500],[11000,15200],[11500,15900],[12000,16600],[12500,17300],[13000,18000],[13500,18600],[14000,19300],[14500,20000],[15000,20700],
  [15500,21400],[16000,22100],[16500,22700],[17000,23400],[17500,24100],[18000,24800],[18500,25500],[19000,26200],[19500,26900],[20000,27600]
];
const elogiUpsAUPerKg = [[44,1384],[54,1397],[99,1383]];

// --- eLogi UPS Express Saver Zone 6 (UK/DE/FR/IT/ES, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) ---
const elogiUpsZone6 = [
  [500,2700],[1000,3900],[1500,4500],[2000,5300],[2500,6100],[3000,6800],[3500,7700],[4000,8400],[4500,9200],[5000,9900],
  [5500,13100],[6000,14000],[6500,14600],[7000,15400],[7500,16100],[8000,16400],[8500,16700],[9000,17000],[9500,17400],[10000,17700],
  [10500,18000],[11000,18400],[11500,18700],[12000,19100],[12500,19500],[13000,19800],[13500,20100],[14000,20500],[14500,20800],[15000,21200],
  [15500,21400],[16000,21400],[16500,21500],[17000,21500],[17500,21500],[18000,21600],[18500,21600],[19000,21700],[19500,21800],[20000,21800]
];
const elogiUpsZone6PerKg = [[54,1391],[70,1364],[99,1253]];

// eLogi zone lookup helpers
function getElogiFicpData(z) { return z==='E'?[elogiFicpUS,elogiFicpUSPerKg]:z==='F'?[elogiFicpF,elogiFicpFPerKg]:z==='H'?[elogiFicpH,elogiFicpHPerKg]:z==='U'?[elogiFicpU,elogiFicpUPerKg]:null; }
function getElogiIpPkgData(z) { return z==='E'?[elogiIpPackageUS,elogiIpPackageUSPerKg]:z==='F'?[elogiIpPackageF,elogiIpPackageFPerKg]:z==='H'?[elogiIpPackageH,elogiIpPackageHPerKg]:z==='U'?[elogiIpPackageU,elogiIpPackageUPerKg]:null; }
function getElogiIpEnvRate(z) { return z==='E'?elogiIpEnvelopeUS:z==='F'?elogiIpEnvelopeF:z==='H'?elogiIpEnvelopeH:z==='U'?elogiIpEnvelopeU:0; }
function getElogiIpPakTable(z) { return z==='E'?elogiIpPakUS:z==='F'?elogiIpPakF:z==='H'?elogiIpPakH:z==='U'?elogiIpPakU:null; }
function getElogiUpsData(z) { return z===5?[elogiUpsUS,elogiUpsUSPerKg]:z===6?[elogiUpsZone6,elogiUpsZone6PerKg]:z==='au'?[elogiUpsAU,elogiUpsAUPerKg]:null; }

// eLogi lookup: „ÉÜ„Éº„Éñ„É´‚Üíper-kg„ÉÜ„Ç£„Ç¢„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ‰ªò„Åç
function elogiLookup(table, perKgTiers, weightG) {
  // „ÉÜ„Éº„Éñ„É´ÂÜÖ„Å´„ÅÇ„Çå„Å∞„Åù„ÅÆ„Åæ„ÅæËøî„Åô
  const r = lookupRate(table, weightG);
  if (r > 0) return r;
  // per-kg„ÉÜ„Ç£„Ç¢„ÅßË®àÁÆó
  if (!perKgTiers) return -1;
  const kg = Math.ceil(weightG / 1000);
  for (let i = 0; i < perKgTiers.length; i++) {
    if (kg <= perKgTiers[i][0]) return kg * perKgTiers[i][1];
  }
  return -1;
}

// ========== Utility Functions ==========

function lookupRate(table, weightGrams) {
  for (let i = 0; i < table.length; i++) {
    if (weightGrams <= table[i][0]) return table[i][1];
  }
  return -1;
}

function getVal(id) { return parseFloat(document.getElementById(id).value) || 0; }
function fmt(n) { return Math.round(n).toLocaleString('ja-JP'); }
function fmtD(n) { return n.toFixed(2); }

const currentSort = 'profit';
let currentCountry = 'us';
let currentPricingMode = 'us';

function initCountrySelector() {
  const sel = document.getElementById('destCountry');
  COUNTRIES.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
  sel.value = 'us';
}

function onCountryChange() {
  currentCountry = document.getElementById('destCountry').value;
  calculate();
}

function setPricingMode(mode) {
  currentPricingMode = mode;
  document.getElementById('modeUs').classList.toggle('active', mode === 'us');
  document.getElementById('modeOther').classList.toggle('active', mode === 'other');
  document.getElementById('usSection').style.display = mode === 'us' ? '' : 'none';
  document.getElementById('otherSection').style.display = mode === 'other' ? '' : 'none';
  updatePricingDisplay();
  calculate();
}

function getEffectiveSellingPrice() {
  const selling = getVal('sellingPrice');
  if (currentPricingMode === 'us') {
    const compShipping = getVal('compShipping');
    const compTotal = selling + compShipping;
    if (compTotal <= 0) return selling;
    if ((compTotal - 0.01) > 2499.99) {
      return Math.round((compTotal - 0.01) * 100) / 100;
    } else {
      return Math.round((compTotal * 0.816 - 0.01) * 100) / 100;
    }
  }
  return selling;
}

function updatePricingDisplay() {
  const selling = getVal('sellingPrice');
  if (currentPricingMode === 'us') {
    const compShipping = getVal('compShipping');
    const compTotal = selling + compShipping;
    let listPrice, listShipping;
    if (compTotal <= 0) {
      listPrice = selling; listShipping = 0;
    } else if ((compTotal - 0.01) > 2499.99) {
      listPrice = Math.round((compTotal - 0.01) * 100) / 100;
      listShipping = 0;
    } else {
      listPrice = Math.round((compTotal * 0.816 - 0.01) * 100) / 100;
      listShipping = Math.round((compTotal - 0.01) * 0.184 * 100) / 100;
    }
    document.getElementById('listPrice').textContent = '$' + fmtD(listPrice);
    document.getElementById('listShipping').textContent = '$' + fmtD(listShipping);
  } else {
    const tariff = getVal('usTariffRate') / 100;
    const usShipping = Math.round(selling * tariff * 100) / 100;
    document.getElementById('otherPricingInfo').innerHTML =
      'üá∫üá∏Á±≥ÂõΩÂêë„ÅëÈÄÅÊñô: <strong>$' + fmtD(usShipping) + '</strong>';
  }
}

function toggleSettings() {
  const c = document.getElementById('settingsContent');
  const b = document.getElementById('settingsToggle');
  if (c.classList.contains('show')) {
    c.classList.remove('show');
    b.textContent = 'Ë©≥Á¥∞Ë®≠ÂÆö ‚ñº';
    b.classList.remove('active');
  } else {
    c.classList.add('show');
    b.textContent = 'Ë©≥Á¥∞Ë®≠ÂÆö ‚ñ≤';
    b.classList.add('active');
  }
}

function toggleFeeDetail() {
  const c = document.getElementById('feeDetailContent');
  const b = document.getElementById('feeToggle');
  if (c.classList.contains('show')) {
    c.classList.remove('show');
    b.textContent = 'ÂÜÖË®≥ ‚ñº';
    b.classList.remove('active');
  } else {
    c.classList.add('show');
    b.textContent = 'ÂÜÖË®≥ ‚ñ≤';
    b.classList.add('active');
  }
}

async function fetchRate() {
  try {
    const r = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
    const d = await r.json();
    if (d.rates && d.rates.JPY) {
      document.getElementById('exchangeRate').value = d.rates.JPY.toFixed(4);
      calculate();
    }
  } catch(e) {
    alert('„É¨„Éº„ÉàÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
  }
}

// ========== Fuel Surcharge Auto-Fetch (EIA APIÁµåÁî±) ==========
// FedEx Express International Export ÁáÉÊñôÂâ≤Â¢óÈáë„ÉÜ„Éº„Éñ„É´ (Effective Dec 1, 2025)
// USGC Kerosene-Type Jet Fuel $/gallon ‚Üí „Çµ„Éº„ÉÅ„É£„Éº„Ç∏%
// ÂõΩÈöõËº∏Âá∫Áî®: ÂõΩÂÜÖ„ÉÜ„Éº„Éñ„É´„Çà„ÇäÁ¥Ñ2.5%È´ò„ÅÑ
// $2.120 ‚Üí 30.50% (FedExÂÖ¨Âºè 2026Âπ¥2Êúà16-22Êó•ÈÄ±„ÅßÁ¢∫Ë™çÊ∏à„Åø)
// $0.05Âàª„Åø„Åß0.5%„Åö„Å§Â§âÂãï
const FUEL_TABLE = [
  [1.36, 23.0],[1.41, 23.5],[1.46, 24.0],[1.51, 24.5],[1.56, 25.0],
  [1.61, 25.5],[1.66, 26.0],[1.71, 26.5],[1.76, 27.0],[1.81, 27.5],
  [1.86, 28.0],[1.91, 28.5],[1.96, 29.0],[2.01, 29.5],[2.06, 30.0],
  [2.11, 30.5],[2.16, 31.0],[2.21, 31.5],[2.26, 32.0],[2.31, 32.5],
  [2.36, 33.0],[2.41, 33.5],[2.46, 34.0],[2.51, 34.5],[2.56, 35.0],
  [2.61, 35.5],[2.66, 36.0],[2.71, 36.5],[2.76, 37.0],[2.81, 37.5],
  [2.86, 38.0],[2.91, 38.5],[2.96, 39.0],[3.01, 39.5],[3.06, 40.0],
];
const FUEL_CACHE_KEY = 'fedex_fuel_surcharge';
const FUEL_CACHE_TIME_KEY = 'fedex_fuel_surcharge_time';
const FUEL_CACHE_PRICE_KEY = 'fedex_fuel_price';
const FUEL_CACHE_TTL = 7 * 24 * 60 * 60 * 1000; // 7Êó•„Ç≠„É£„ÉÉ„Ç∑„É•ÔºàEIA„ÅØÈÄ±Ê¨°Êõ¥Êñ∞Ôºâ

function _fuelPriceToSurcharge(pricePerGallon) {
  for (let i = FUEL_TABLE.length - 1; i >= 0; i--) {
    if (pricePerGallon >= FUEL_TABLE[i][0]) return FUEL_TABLE[i][1];
  }
  return FUEL_TABLE[0][1]; // ÊúÄ‰ΩéÂÄ§
}

async function _fetchJetFuelPrice() {
  // EIA API: USGC Kerosene-Type Jet Fuel Spot Price (ÈÄ±Ê¨°)
  const url = 'https://api.eia.gov/v2/petroleum/pri/spt/data/?api_key=DEMO_KEY&frequency=weekly&data[0]=value&facets[series][]=EER_EPJK_PF4_RGC_DPG&sort[0][column]=period&sort[0][direction]=desc&length=1';
  const r = await fetch(url, { signal: AbortSignal.timeout(10000) });
  const d = await r.json();
  if (d.response && d.response.data && d.response.data.length > 0) {
    return { price: parseFloat(d.response.data[0].value), date: d.response.data[0].period };
  }
  return null;
}

async function fetchFuelSurcharge(silent) {
  const statusEl = document.getElementById('fuelStatus');
  if (statusEl) statusEl.textContent = 'ÂèñÂæó‰∏≠...';
  try {
    const result = await _fetchJetFuelPrice();
    if (result) {
      const surcharge = _fuelPriceToSurcharge(result.price);
      document.getElementById('fuelSurcharge').value = surcharge;
      localStorage.setItem(FUEL_CACHE_KEY, surcharge);
      localStorage.setItem(FUEL_CACHE_PRICE_KEY, result.price);
      localStorage.setItem(FUEL_CACHE_TIME_KEY, Date.now());
      if (statusEl) statusEl.textContent = '‚úì ' + surcharge + '% (ÁáÉÊñô$' + result.price.toFixed(3) + '/gal ' + result.date + ')';
      calculate();
      if (!silent) alert('FedExÁáÉÊ≤π„Çµ„Éº„ÉÅ„É£„Éº„Ç∏: ' + surcharge + '%\n(„Ç∏„Çß„ÉÉ„ÉàÁáÉÊñô: $' + result.price.toFixed(3) + '/gal, ' + result.date + 'ÈÄ±)');
    } else {
      throw new Error('„Éá„Éº„Çø„Å™„Åó');
    }
  } catch(e) {
    const cached = localStorage.getItem(FUEL_CACHE_KEY);
    if (cached) {
      const age = Date.now() - (parseInt(localStorage.getItem(FUEL_CACHE_TIME_KEY)) || 0);
      const days = Math.floor(age / (24*60*60*1000));
      if (statusEl) statusEl.textContent = '‚ö† ' + cached + '% (' + days + 'Êó•Ââç)';
    } else {
      if (statusEl) statusEl.textContent = '‚ö† ÂèñÂæóÂ§±Êïó';
    }
    if (!silent) alert('Ëá™ÂãïÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\nÊâãÂãï„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\nÁèæÂú®„ÅÆÂÄ§: ' + document.getElementById('fuelSurcharge').value + '%');
  }
}

function initFuelSurcharge() {
  const cached = localStorage.getItem(FUEL_CACHE_KEY);
  const cachedTime = parseInt(localStorage.getItem(FUEL_CACHE_TIME_KEY)) || 0;
  const age = Date.now() - cachedTime;
  if (cached && age < FUEL_CACHE_TTL) {
    document.getElementById('fuelSurcharge').value = cached;
    const price = localStorage.getItem(FUEL_CACHE_PRICE_KEY) || '?';
    const statusEl = document.getElementById('fuelStatus');
    if (statusEl) statusEl.textContent = '‚úì ' + cached + '% („Ç≠„É£„ÉÉ„Ç∑„É•„ÉªÁáÉÊñô$' + price + '/gal)';
  } else {
    fetchFuelSurcharge(true);
  }
}

// ========== Main Calculation ==========

function calculate() {
  updatePricingDisplay();
  const purchase = getVal('purchasePrice');
  const selling = getEffectiveSellingPrice();
  const weightKg = getVal('weight');
  const L = getVal('length');
  const W = getVal('width');
  const H = getVal('height');

  const ebayRate1 = getVal('ebayFeeRate') / 100;
  const threshold = getVal('feeThreshold');
  const ebayRate2 = getVal('ebayFeeRate2') / 100;
  const perOrder = getVal('perOrderFee');
  const promotedRate = getVal('promotedRate') / 100;
  const intlRate = getVal('intlFeeRate') / 100;
  const payoneerRate = getVal('payoneerRate') / 100;
  const rate = getVal('exchangeRate');
  const taxRate = getVal('taxRate') / 100;
  const taxMultiplier = 1 + taxRate;
  const fuelSurchargeRate = getVal('fuelSurcharge') / 100; // ÁáÉÊ≤π„Çµ„Éº„ÉÅ„É£„Éº„Ç∏Áéá

  const vol = L * W * H;
  const volWeight = vol / 5000;
  const volWeightEco = vol / 8000;

  document.getElementById('volWeight').textContent = volWeight.toFixed(3) + ' kg';
  document.getElementById('volWeightEco').textContent = volWeightEco.toFixed(3) + ' kg';

  // eBay FVF: two-rate system
  let fvfBase = 0;
  if (selling <= threshold) {
    fvfBase = selling * ebayRate1;
  } else {
    fvfBase = threshold * ebayRate1 + (selling - threshold) * ebayRate2;
  }
  const ebayFvf = (fvfBase + perOrder) * taxMultiplier;
  const promotedFee = selling * promotedRate * taxMultiplier;
  const intlFee = selling * intlRate * taxMultiplier;
  const totalEbayDeductions = ebayFvf + promotedFee + intlFee;
  const netPayout = selling - totalEbayDeductions;
  const payoneerFee = netPayout * payoneerRate;
  const netReceived = netPayout * (1 - payoneerRate) * rate;
  const revenueYen = selling * rate;
  const totalFeesYen = revenueYen - netReceived;

  const purchaseTax = purchase * taxRate / taxMultiplier;
  const ebayFeeTaxPortion = totalEbayDeductions / taxMultiplier * taxRate * rate;
  const totalRefund = purchaseTax + ebayFeeTaxPortion;

  document.getElementById('revenueYen').textContent = '¬•' + fmt(revenueYen) + 'Ôºà$' + fmtD(selling) + 'Ôºâ';
  document.getElementById('totalFeesYen').textContent = '¬•' + fmt(totalFeesYen);
  document.getElementById('feeEbay').textContent = '$' + fmtD(ebayFvf);
  document.getElementById('feePromoted').textContent = '$' + fmtD(promotedFee);
  document.getElementById('feeIntl').textContent = '$' + fmtD(intlFee);
  document.getElementById('feePayoneer').textContent = '$' + fmtD(payoneerFee) + 'Ôºà¬•' + fmt(payoneerFee * rate) + 'Ôºâ';
  document.getElementById('feeTotalUsd').textContent = '$' + fmtD(totalEbayDeductions + payoneerFee) + 'Ôºà¬•' + fmt(totalFeesYen) + 'Ôºâ';

  // ========== Shipping Methods ==========
  const weightG = weightKg * 1000;
  const dims = [L, W, H].sort((a,b) => b-a);
  const longest = dims[0];
  const girth = longest + 2 * (dims[1] + dims[2]);
  const billableStandard = Math.max(weightKg, volWeight);
  const billableStandardG = billableStandard * 1000;
  const billableEcoKg = Math.max(weightKg, volWeightEco);
  const billableEcoG = billableEcoKg * 1000;

  // Current country config
  const cc = COUNTRIES.find(c => c.id === currentCountry) || COUNTRIES[0];
  const ficpTable = getFicpTable(cc.fedexZone);
  const ipPkgTable = getIpPackageTable(cc.fedexZone);
  const dhlTable = getDhlTable(cc.dhlZone);
  const dhlEnvRate = getDhlEnvelopeRate(cc.dhlZone);
  const isUS = currentCountry === 'us';

  const groups = [
    { id: 'fedex',    label: 'SpeedPAK FedEx International Connect Plus', icon: 'üü£', cls: 'group-elogi',    tag: 'Êé®Â•®',      primary: true,  methods: [], note: 'Âü∫Êú¨ÁöÑ„Å´„ÅØ„Åì„ÅÆÈÖçÈÄÅÊñπÊ≥ï„ÅßOK' },
    { id: 'fedex-ip', label: 'SpeedPAK FedEx International Priority',   icon: 'üü£', cls: 'group-elogi',    tag: 'ÈÄüÈÅî',      primary: false, methods: [], collapsed: true, note: 'Êó©„ÅÑÈÖçÈÄÅÊñπÊ≥ï„ÄÅÂ∞ë„ÅóÈ´ò„ÅÑ' },
    { id: 'dhl',      label: 'SpeedPAK DHL',        icon: 'üü°', cls: 'group-dhl',      tag: 'Êé®Â•®',      primary: true,  methods: [], note: 'ÂÆâ„Åë„Çå„Å∞‰ΩøÁî®OK„ÄÅÂü∫Êú¨ÁöÑ„Å´„ÅØFedEx„ÅåÂÆâ„ÅÑ' },
    { id: 'speedpak', label: 'SpeedPAK Economy',    icon: 'üü†', cls: 'group-speedpak', tag: cc.economy?'4„É∂ÂõΩÈôêÂÆö':'ÈùûÂØæÂøú', primary: false, methods: [], note: cc.economy?'ÈÖçÈÄÅ„ÅåÈÅÖ„ÅÑ„ÅÆ„Åß‰ΩøÁî®„Åô„ÇãÂ†¥Âêà„ÅØEconomyÁî®„ÅÆShipping Policy„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ':'„Åì„ÅÆÂõΩ„ÅØEconomyÈùûÂØæÂøú„Åß„Åô' },
    { id: 'elogi-ficp', label: 'eLogi FedEx FICP', icon: 'üîµ', cls: 'group-elogi-blue', tag: 'ÊØîËºÉÁî®', primary: false, methods: [], collapsed: true, note: 'SpeedPAK„Å®ÊØîËºÉÁî®' },
    { id: 'elogi-ip',   label: 'eLogi FedEx IP',   icon: 'üîµ', cls: 'group-elogi-blue', tag: 'ÊØîËºÉÁî®', primary: false, methods: [], collapsed: true, note: 'SpeedPAK„Å®ÊØîËºÉÁî®' },
    ...(getElogiUpsData(cc.upsZone) ? [
      { id: 'elogi-ups', label: 'eLogi UPS Express Saver', icon: 'üü§', cls: 'group-ups', tag: 'ÊØîËºÉÁî®', primary: false, methods: [], collapsed: true, note: '„Ç¢„Ç∏„Ç¢„Éª„Ç™„Éº„Çπ„Éà„É©„É™„Ç¢Âêë„Åë„ÅåÂÆâ„ÅÑ' },
    ] : []),
    { id: 'jppost',   label: 'Êó•Êú¨ÈÉµ‰æø',             icon: 'üü¢', cls: cc.jpOk!==false?'group-jppost':'group-unavail', tag: cc.jpOk!==false?'Ë£úÂä©':'Â∑ÆÂá∫‰∏çÂèØ', primary: false, methods: [], note: cc.jpOk!==false?'SpeedPAKÈùûÂØæÂøú„ÉªËá™ÂàÜ„ÅßÁô∫ÈÄÅÊâãÁ∂ö„Åç„ÅåÂøÖË¶Å':'„Åì„ÅÆÂõΩ„ÅØÊó•Êú¨ÈÉµ‰æø„ÅÆÂ∑ÆÂá∫„ÅåÂà∂Èôê„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºà‚ñ≥Ôºâ' },
  ];

  function addMethod(groupId, m) {
    m._groupId = groupId;
    const g = groups.find(g => g.id === groupId);
    if (g) g.methods.push(m);
  }

  // ===== SpeedPAK Economy =====
  if (cc.economy) {
    const maxKg = cc.ecoMaxKg || 25;
    const realMaxKg = cc.ecoRealMaxKg || Infinity;
    const csW = billableEcoKg <= maxKg && weightKg <= realMaxKg;
    const csD = cc.ecoSizeCheck ? cc.ecoSizeCheck(L, W, H, billableEcoG) : true;
    const cs = csW && csD;
    let c = cs ? lookupRate(cc.ecoTable, billableEcoG) : -1;
    if (cs && c > 0 && cc.ecoSurcharge) c += cc.ecoSurcharge(L, W, H, vol);
    const r2 = [];
    if (!csW) r2.push(maxKg + 'kgË∂ÖÈÅé');
    if (!csD) r2.push('„Çµ„Ç§„Ç∫Ë∂ÖÈÅé');
    addMethod('speedpak',{name:'Economy',sub:cc.ecoDays+'/'+cc.ecoMaxVal+'‰ª•‰∏ã/‰ΩìÁ©ç√∑8,000/DDP',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:r2.join(', ')});
  } else {
    addMethod('speedpak',{name:'Economy',sub:'„Åì„ÅÆÂõΩ„ÅØEconomyÈùûÂØæÂøú',cost:-1,canSend:false,reason:cc.name+' ÈùûÂØæÂøú'});
  }

  // ===== SpeedPAK FedEx FICP (International Connect Plus) =====
  {
    const cs = billableStandardG <= 68000;
    let c = cs ? lookupRate(ficpTable, billableStandardG) : -1;
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    addMethod('fedex',{name:'International Connect Plus',sub:'2-5Êó•/DDP/ÊúÄÂ§ß68kg/‰ΩìÁ©ç√∑5,000/ÁáÉÊ≤πËæº',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:!cs?'68kgË∂ÖÈÅé':''});
  }

  // ===== SpeedPAK FedEx IP Envelope =====
  {
    const sorted = [L, W, H].sort((a,b) => b-a);
    const csW = weightG <= 500;
    const csS = sorted[0] <= 33.5 && sorted[1] <= 23.5 && sorted[2] <= 3;
    const cs = csW && csS;
    let c = -1;
    if (cs) {
      if (cc.fedexZone === 'M') c = ipEnvelopeZoneM;
      else if (cc.fedexZone === 'U') c = ipEnvelopeZoneU;
      else c = lookupRate(speedpakIpEnvelopeRates, weightG);
    }
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    const r2 = [];
    if (!csW) r2.push('500gË∂ÖÈÅé');
    if (!csS) r2.push('„Çµ„Ç§„Ç∫Ë∂ÖÈÅé(23.5x33.5x3cm)');
    addMethod('fedex-ip',{name:'FedEx IP Envelope',sub:'1-3Êó•/DDP/ÊúÄÂ§ß500g/ÂÜÖÂØ∏23.5√ó33.5√ó3cm/ÁáÉÊ≤πËæº',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:r2.join(', ')});
  }

  // ===== SpeedPAK FedEx IP Pak =====
  {
    const cs = weightG <= 2500;
    const pakTable = cc.fedexZone==='M'?ipPakZoneM:cc.fedexZone==='U'?ipPakZoneU:speedpakIpPakRates;
    let c = cs ? lookupRate(pakTable, weightG) : -1;
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    addMethod('fedex-ip',{name:'FedEx IP Pak',sub:'1-3Êó•/DDP/ÊúÄÂ§ß2.5kg/ÂÆüÈáçÈáè/ÁáÉÊ≤πËæº',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:!cs?'2.5kgË∂ÖÈÅé':''});
  }

  // ===== SpeedPAK FedEx IP Package =====
  {
    const cs = billableStandardG <= 68000;
    let c = cs ? lookupRate(ipPkgTable, billableStandardG) : -1;
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    addMethod('fedex-ip',{name:'FedEx IP Package',sub:'1-3Êó•/DDP/ÊúÄÂ§ß68kg/‰ΩìÁ©ç√∑5,000/ÁáÉÊ≤πËæº',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:!cs?'68kgË∂ÖÈÅé':''});
  }

  // ===== SpeedPAK DHL Express Envelope =====
  {
    const maxW = cc.dhlZone === 10 ? 300 : 300; // ÂÖ®zone 0.3kg
    const cs = weightG <= maxW;
    let c = cs ? dhlEnvRate : -1;
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    addMethod('dhl',{name:'DHL Express Envelope',sub:'2-4Êó•/DDP/ÊúÄÂ§ß300g/ÂÆüÈáçÈáè/ÁáÉÊ≤πËæº',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:!cs?'300gË∂ÖÈÅé':''});
  }

  // ===== SpeedPAK DHL Express Worldwide =====
  {
    const maxW = cc.dhlZone === 10 ? 70000 : 30000; // US=70kg, others=30kg
    const cs = billableStandardG <= maxW;
    let c = cs ? lookupRate(dhlTable, billableStandardG) : -1;
    if (cs && c > 0) c = Math.round(c * (1 + fuelSurchargeRate));
    addMethod('dhl',{name:'DHL Express',sub:'2-4Êó•/DDP/ÊúÄÂ§ß'+(maxW/1000)+'kg/‰ΩìÁ©ç√∑5,000/ÁáÉÊ≤πËæº',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:!cs?(maxW/1000)+'kgË∂ÖÈÅé':''});
  }

  // ===== Êó•Êú¨ÈÉµ‰æøÔºàÂõΩÂà•ÊñôÈáëÔºâ =====
  {
    const jpZone = cc.jpZone || 4;
    const jpOk = cc.jpOk !== false;
    const zoneName = jpZone === 3 ? 'Á¨¨3Âú∞Â∏Ø' : 'Á¨¨4Âú∞Â∏Ø';
    const eplTable = getEpacketLightTable(jpZone);
    const emsTable = getEmsTable(jpZone);
    {
      const cs = jpOk && weightG <= 2000;
      const c = cs ? lookupRate(eplTable, weightG) : (jpOk ? -1 : lookupRate(eplTable, Math.min(weightG,2000)));
      const reason = !jpOk ? 'Â∑ÆÂá∫‰∏çÂèØÔºà‚ñ≥Ôºâ' : !cs ? '2kgË∂ÖÈÅé' : '';
      addMethod('jppost',{name:'e„Éë„Ç±„ÉÉ„Éà„É©„Ç§„Éà',sub:zoneName+'/ËøΩË∑°„ÅÇ„Çä/ÊúÄÂ§ß2kg/ÂÆüÈáçÈáè/‚ö†Ô∏è EconomyÁî®Shipping PolicyË¶Å‰ΩúÊàê',cost:c>0?c:-1,canSend:cs&&c>0,reason:reason});
    }
    {
      const cs = jpOk && weightG <= 30000;
      const c = cs ? lookupRate(emsTable, weightG) : (jpOk ? -1 : lookupRate(emsTable, Math.min(weightG,30000)));
      const reason = !jpOk ? 'Â∑ÆÂá∫‰∏çÂèØÔºà‚ñ≥Ôºâ' : !cs ? '30kgË∂ÖÈÅé' : '';
      addMethod('jppost',{name:'EMS',sub:zoneName+'/ÊúÄÈÄü/ÊúÄÂ§ß30kg/ÂÆüÈáçÈáè',cost:c>0?c:-1,canSend:cs&&c>0,reason:reason});
    }
  }

  // ===== eLogi FedEx (ÂÖ®ÂõΩ, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) =====
  {
    const eZ = cc.elogiZone;
    if (eZ) {
      const ficpD = getElogiFicpData(eZ);
      if (ficpD) {
        let c = elogiLookup(ficpD[0], ficpD[1], billableStandardG);
        const cs = c > 0;
        addMethod('elogi-ficp',{name:'eLogi FICP',sub:'2-5Êó•/DDP/‰ΩìÁ©ç√∑5,000/„Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº',cost:cs?c:-1,canSend:cs,reason:!cs?'ÈáçÈáèË∂ÖÈÅé':''});
      }
      {
        const sorted = [L, W, H].sort((a,b) => b-a);
        const csW = weightG <= 500;
        const csS = sorted[0] <= 33.5 && sorted[1] <= 23.5 && sorted[2] <= 3;
        const cs = csW && csS;
        const envRate = getElogiIpEnvRate(eZ);
        const c = cs && envRate > 0 ? envRate : -1;
        const r2 = [];
        if (!csW) r2.push('500gË∂ÖÈÅé');
        if (!csS) r2.push('„Çµ„Ç§„Ç∫Ë∂ÖÈÅé');
        addMethod('elogi-ip',{name:'eLogi IP Envelope',sub:'1-3Êó•/DDP/ÊúÄÂ§ß500g/„Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:r2.join(', ')});
      }
      {
        const pakTable = getElogiIpPakTable(eZ);
        const cs = weightG <= 2500 && pakTable;
        let c = cs ? lookupRate(pakTable, weightG) : -1;
        addMethod('elogi-ip',{name:'eLogi IP Pak',sub:'1-3Êó•/DDP/ÊúÄÂ§ß2.5kg/ÂÆüÈáçÈáè/„Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº',cost:cs&&c>0?c:-1,canSend:cs&&c>0,reason:!cs?'2.5kgË∂ÖÈÅé':''});
      }
      {
        const pkgD = getElogiIpPkgData(eZ);
        if (pkgD) {
          let c = elogiLookup(pkgD[0], pkgD[1], billableStandardG);
          const cs = c > 0;
          addMethod('elogi-ip',{name:'eLogi IP Package',sub:'1-3Êó•/DDP/‰ΩìÁ©ç√∑5,000/„Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº',cost:cs?c:-1,canSend:cs,reason:!cs?'ÈáçÈáèË∂ÖÈÅé':''});
        }
      }
    }
  }

  // ===== eLogi UPS Express Saver (US/AU, „Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº„Åø) =====
  {
    const upsD = getElogiUpsData(cc.upsZone);
    if (upsD) {
      let c = elogiLookup(upsD[0], upsD[1], billableStandardG);
      const cs = c > 0;
      addMethod('elogi-ups',{name:'UPS Express Saver',sub:'2-5Êó•/DDP/‰ΩìÁ©ç√∑5,000/„Çµ„Éº„ÉÅ„É£„Éº„Ç∏Ëæº',cost:cs?c:-1,canSend:cs,reason:!cs?'ÈáçÈáèË∂ÖÈÅé':''});
    }
  }

  // Profit calculation
  let allMethods = [];
  groups.forEach(g => {
    g.methods.forEach(m => {
      if (m.cost > 0) {
        m.profit = Math.round(netReceived - purchase - m.cost);
        m.profitWithRefund = Math.round(m.profit + totalRefund);
        m.profitRate = purchase > 0 ? (m.profit / purchase * 100) : 0;
        m.isOk = m.canSend && m.profit >= 500 && m.profitRate >= 5;
      } else {
        m.profit = null; m.profitWithRefund = null; m.profitRate = 0; m.isOk = false;
      }
      allMethods.push(m);
    });
  });

  // BestÂà§ÂÆö: FedEx/DHL„ÇíÂÑ™ÂÖà„ÄÇEconomy„ÅØ„Åä„Åæ„Åë„ÄÇ
  // FedEx/DHLÂÜÖ„ÅßÂà©ÁõäOK„ÅÆÊúÄÈ´òÂà©Áõä„É°„ÇΩ„ÉÉ„Éâ„Çíbest„ÄÇ„Å™„Åë„Çå„Å∞ÂÖ®‰Ωì„ÅßÊúÄÈ´òÂà©Áõä„Çíbest„ÄÇ
  const fedexDhlMethods = allMethods.filter(m => m._groupId === 'fedex' || m._groupId === 'fedex-ip' || m._groupId === 'dhl' || m._groupId === 'elogi-ficp' || m._groupId === 'elogi-ip' || m._groupId === 'elogi-ups');
  let bestFD = null, bestFDProfit = -Infinity;
  fedexDhlMethods.forEach(m => {
    if (m.isOk && m.profit !== null && m.profit > bestFDProfit) { bestFDProfit = m.profit; bestFD = m; }
  });

  let bestProfit = -Infinity, bestRefund = -Infinity;
  allMethods.forEach(m => {
    if (!m.canSend) return; // Áô∫ÈÄÅ‰∏çÂèØ„É°„ÇΩ„ÉÉ„Éâ„ÅØ„Çµ„Éû„É™„ÉºÂØæË±°Â§ñ
    if (m.profit !== null && m.profit > bestProfit) bestProfit = m.profit;
    if (m.profitWithRefund !== null && m.profitWithRefund > bestRefund) bestRefund = m.profitWithRefund;
  });

  function setSummaryVal(elId, value, cellId) {
    const el = document.getElementById(elId);
    const cell = document.getElementById(cellId);
    if (value === null || value === undefined) {
      el.textContent = '-';
      if (cell) { cell.style.background = ''; }
      return;
    }
    if (value < 0) {
      el.textContent = '‚ö† ¬•' + fmt(value);
      el.style.color = 'var(--red)';
      if (cell) cell.style.background = 'var(--red-bg)';
    } else {
      el.textContent = '¬•' + fmt(value);
      el.style.color = '';
      if (cell) cell.style.background = '';
    }
  }

  if (bestFD) {
    allMethods.forEach(m => { m.isBest = (m === bestFD); });
    setSummaryVal('bestProfitYen', bestFD.profit, 'summaryProfit');
    setSummaryVal('bestProfitRefundYen', bestFD.profitWithRefund, 'summaryRefund');
    const rateEl = document.getElementById('bestProfitRate');
    rateEl.textContent = bestFD.profitRate.toFixed(1) + '%';
    rateEl.style.color = bestFD.profitRate < 0 ? 'var(--red)' : '';
  } else {
    let bestMethod = null;
    allMethods.forEach(m => { m.isBest = m.profit !== null && m.profit === bestProfit && m.isOk; if (m.isBest && !bestMethod) bestMethod = m; });
    setSummaryVal('bestProfitYen', bestProfit > -Infinity ? bestProfit : null, 'summaryProfit');
    setSummaryVal('bestProfitRefundYen', bestRefund > -Infinity ? bestRefund : null, 'summaryRefund');
    const rateEl = document.getElementById('bestProfitRate');
    rateEl.textContent = bestMethod ? bestMethod.profitRate.toFixed(1) + '%' : '-';
    rateEl.style.color = bestMethod && bestMethod.profitRate < 0 ? 'var(--red)' : '';
  }

  // Sort by profit (descending)
  groups.forEach(g => {
    g.methods.sort((a,b) => {
      const av = a.profit, bv = b.profit;
      if (av === null && bv === null) return 0;
      if (av === null) return 1;
      if (bv === null) return -1;
      return bv - av;
    });
  });

  // Render
  const container = document.getElementById('resultsContainer');
  container.innerHTML = '';

  groups.forEach(g => {
    const section = document.createElement('div');
    let sectionCls = 'group-section';
    if (g.id === 'fedex' || g.id === 'fedex-ip') sectionCls += ' grp-fedex';
    else if (g.id === 'dhl') sectionCls += ' grp-dhl';
    else if (g.id === 'elogi-ficp' || g.id === 'elogi-ip') sectionCls += ' grp-elogi';
    else if (g.id === 'elogi-ups') sectionCls += ' grp-ups';
    else if (g.id === 'speedpak') { sectionCls += ' grp-speedpak'; if (!cc.economy) sectionCls += ' collapsed'; }
    else if (g.id === 'jppost') sectionCls += ' grp-jppost';
    if (g.collapsed) sectionCls += ' collapsed';
    section.className = sectionCls;

    let headerExtra = '';
    const isCollapsed = g.collapsed || (g.id === 'speedpak' && !cc.economy);
    if (isCollapsed) {
      headerExtra = `<button class="group-toggle" onclick="this.closest('.group-section').classList.toggle('collapsed');this.textContent=this.closest('.group-section').classList.contains('collapsed')?'Ë©≥Á¥∞ ‚ñº':'Èñâ„Åò„Çã ‚ñ≤'">Ë©≥Á¥∞ ‚ñº</button>`;
    }
    const noteHtml = g.note ? `<span class="g-note">‚Äî ${g.note}</span>` : '';
    section.innerHTML = `<div class="group-header ${g.cls}"><span class="g-icon">${g.icon}</span><span class="g-label">${g.label}</span>${noteHtml}<span class="g-tag">${g.tag}</span>${headerExtra}</div>`;

    // Êó•Êú¨ÈÉµ‰æø„ÅÆÊ≥®Ë®ò
    if (g.id === 'jppost') {
      const jpZone = cc.jpZone || 4;
      const note = document.createElement('div');
      note.className = 'group-note';
      note.style.cssText = 'font-size:.78rem;color:var(--text2);padding:4px 12px;margin-bottom:6px';
      note.textContent = 'üìÆ ' + (jpZone===3?'Á¨¨3Âú∞Â∏Ø':'Á¨¨4Âú∞Â∏Ø') + 'Ôºà' + cc.name + 'Ôºâ';
      section.appendChild(note);
    }

    const grid = document.createElement('div');
    grid.className = 'group-grid';

    g.methods.forEach(m => {
      const row = document.createElement('div');
      let cls = 'method-row';
      if (m.isBest) cls += ' best';
      else if (!m.canSend || (m.profit !== null && !m.isOk)) cls += ' ng';
      row.className = cls;

      let badge = '';
      if (!m.canSend) badge = '<span class="badge badge-na">‰∏çÂèØ</span>';
      else if (m.isBest) badge = '<span class="badge badge-best">ÊúÄÈ´ò</span>';
      else if (m.isOk) badge = '<span class="badge badge-ok">OK</span>';
      else badge = '<span class="badge badge-ng">NG</span>';

      let right;
      if (m.cost > 0 && m.profit !== null) {
        const profitCls = m.profit < 0 ? 'val val-neg' : 'val val-profit';
        const refundCls = m.profitWithRefund < 0 ? 'val val-neg' : 'val val-refund';
        const profitTxt = m.profit < 0 ? '‚ö† ¬•' + fmt(m.profit) : '¬•' + fmt(m.profit);
        const refundTxt = m.profitWithRefund < 0 ? '‚ö† ¬•' + fmt(m.profitWithRefund) : '¬•' + fmt(m.profitWithRefund);
        right = `<div class="mr-right">
          <span class="lbl">ÈÄÅÊñô</span><span class="val">¬•${fmt(m.cost)}</span>
          <span class="lbl">Âà©Áõä</span><span class="${profitCls}">${profitTxt}</span>
          <span class="lbl">ÈÇÑ‰ªòËæº</span><span class="${refundCls}">${refundTxt}</span>
        </div>`;
      } else {
        right = `<div class="mr-na">${m.reason || 'Áô∫ÈÄÅ‰∏çÂèØ'}</div>`;
      }

      row.innerHTML = `<div class="mr-left"><div class="mr-name">${m.name}${badge}</div><div class="mr-sub">${m.sub}</div></div>${right}`;
      grid.appendChild(row);
    });

    section.appendChild(grid);
    container.appendChild(section);
  });
}

// ========== Event Listeners ==========
document.querySelectorAll('input').forEach(el => {
  el.addEventListener('input', calculate);
});
document.getElementById('categoryNo').addEventListener('input', onCategoryNoInput);

// Initial setup
initCountrySelector();
onCategoryNoInput();
updateFeeDescription();
initFuelSurcharge();
calculate();
</script>
</body>
</html>
